# 测试聊天消息保存功能

## 测试步骤

### 1. 启动应用
```bash
mvn spring-boot:run
```

### 2. 连接WebSocket
访问：http://localhost:8080/websocket.html

### 3. 发送测试消息
在聊天窗口发送消息，或者等待接收消息

### 4. 查询数据库验证

#### 查看所有消息
```sql
SELECT 
    id,
    xianyu_account_id,
    pnm_id,
    s_id,
    content_type,
    msg_content,
    sender_user_name,
    sender_user_id,
    datetime(message_time/1000, 'unixepoch', 'localtime') as msg_time
FROM xianyu_chat_message
ORDER BY message_time DESC
LIMIT 10;
```

#### 查看用户消息
```sql
SELECT * FROM xianyu_chat_message 
WHERE content_type = 1 
ORDER BY message_time DESC;
```

#### 查看系统消息
```sql
SELECT * FROM xianyu_chat_message 
WHERE content_type = 32 
ORDER BY message_time DESC;
```

#### 查看某个会话的消息
```sql
SELECT * FROM xianyu_chat_message 
WHERE s_id = '55435931514@goofish' 
ORDER BY message_time ASC;
```

#### 查看完整消息体
```sql
SELECT 
    pnm_id,
    msg_content,
    complete_msg
FROM xianyu_chat_message 
WHERE id = 1;
```

## 预期结果

### 用户消息示例
```
id: 1
xianyu_account_id: 1
pnm_id: 3813496236127.PNM
s_id: 55435931514@goofish
content_type: 1
msg_content: 舅舅舅舅
sender_user_name: 肥极喵喵喵
sender_user_id: 3553532632
sender_app_v: 7.23.50
sender_os_type: ios
message_time: 1762957508906
```

### 系统消息示例
```
id: 2
xianyu_account_id: 1
pnm_id: 3813794318221.PNM
s_id: 50660220958@goofish
content_type: 32
msg_content: [已付款，待发货]
sender_user_name: 肥极喵喵喵
sender_user_id: 3553532632
message_time: 1762996838973
```

## 日志检查

查看应用日志，应该看到类似输出：
```
【账号1】保存聊天消息成功: pnmId=3813496236127.PNM, contentType=1, content=舅舅舅舅
【账号1】保存聊天消息成功: pnmId=3813794318221.PNM, contentType=32, content=[已付款，待发货]
```

## 常见问题

### 1. 消息没有保存
- 检查WebSocket是否正常连接
- 查看日志是否有错误信息
- 确认数据库表是否正确创建

### 2. 字段为空
- 检查消息格式是否符合预期
- 查看complete_msg字段确认原始数据
- 调整字段提取逻辑

### 3. 重复消息
- 唯一索引会自动过滤重复的pnm_id
- 日志会显示"消息已存在，跳过保存"

## 手动测试数据插入

如果需要手动插入测试数据：

```sql
INSERT INTO xianyu_chat_message (
    xianyu_account_id, pnm_id, s_id, content_type, 
    msg_content, sender_user_name, sender_user_id,
    sender_app_v, sender_os_type, reminder_url,
    complete_msg, message_time
) VALUES (
    1, 
    'TEST123.PNM', 
    '12345@goofish', 
    1,
    '测试消息内容',
    '测试用户',
    '12345',
    '7.23.50',
    'ios',
    'fleamarket://test',
    '{"test": "data"}',
    1762957508906
);
```

## 性能测试

### 批量插入测试
```sql
-- 查看消息数量
SELECT COUNT(*) FROM xianyu_chat_message;

-- 查看索引使用情况
EXPLAIN QUERY PLAN 
SELECT * FROM xianyu_chat_message 
WHERE xianyu_account_id = 1 AND pnm_id = 'TEST123.PNM';
```

### 查询性能测试
```sql
-- 测试时间范围查询
SELECT COUNT(*) FROM xianyu_chat_message 
WHERE message_time BETWEEN 1762957508906 AND 1762996838973;

-- 测试会话查询
SELECT COUNT(*) FROM xianyu_chat_message 
WHERE s_id = '55435931514@goofish';
```
