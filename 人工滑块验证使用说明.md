# 人工滑块验证使用说明

## 概述

当系统检测到需要滑块验证时，会自动在网页中弹出验证窗口，让你人工完成验证。这比自动化方式更稳定可靠。

## 访问地址

```
http://localhost:8080/websocket-manual-captcha.html
```

## 使用流程

### 1. 打开验证页面

在浏览器中访问：`http://localhost:8080/websocket-manual-captcha.html`

### 2. 输入账号ID

在"账号ID"输入框中输入你的闲鱼账号ID（通常是1）

### 3. 点击启动连接

点击"启动WebSocket连接"按钮

### 4. 完成滑块验证

如果需要验证，系统会自动弹出验证窗口：

1. **在弹窗中完成滑块验证**
   - 按住滑块，拖动到正确位置
   - 等待验证结果

2. **验证成功后**
   - 页面可能会跳转或显示成功信息
   - 等待3-5秒，系统会自动检测

3. **自动继续连接**
   - 系统检测到验证成功后
   - 弹窗会自动关闭
   - WebSocket连接会自动建立

### 5. 连接成功

看到"✅ 滑块验证成功！WebSocket连接已建立"提示，表示连接成功。

## 工作原理

### 前端流程

```
1. 用户点击"启动连接"
   ↓
2. 调用 /api/websocket/start
   ↓
3. 后端返回需要验证 (code=500, needCaptcha=true)
   ↓
4. 前端弹出iframe显示验证页面
   ↓
5. 用户在iframe中完成验证
   ↓
6. 前端每5秒检查一次验证状态
   ↓
7. 验证成功后，后端返回 code=200
   ↓
8. 前端关闭弹窗，显示成功提示
```

### 后端流程

```java
// WebSocketController.java
@PostMapping("/start")
public ResultObject<CaptchaInfoDTO> startWebSocket(@RequestBody WebSocketReqDTO reqDTO) {
    try {
        // 尝试启动连接
        boolean success = webSocketService.startWebSocket(accountId);
        
        if (success) {
            return ResultObject.success(null, "WebSocket连接已启动");
        }
    } catch (CaptchaRequiredException e) {
        // 需要滑块验证
        CaptchaInfoDTO captchaInfo = new CaptchaInfoDTO();
        captchaInfo.setNeedCaptcha(true);
        captchaInfo.setCaptchaUrl(e.getCaptchaUrl());
        return new ResultObject<>(500, "需要滑块验证", captchaInfo);
    }
}
```

### 验证检测机制

前端使用定时器每5秒检查一次：

```javascript
// 每5秒尝试重新连接
setInterval(async () => {
    const response = await fetch(`${API_BASE}/start`, {
        method: 'POST',
        body: JSON.stringify({ xianyuAccountId: accountId })
    });
    
    const result = await response.json();
    
    if (result.code === 200) {
        // 验证成功，连接已建立
        closeCaptchaModal();
        showSuccess();
    }
}, 5000);
```

## 验证窗口说明

### 弹窗特性

- **全屏遮罩**：半透明黑色背景，聚焦验证窗口
- **响应式设计**：自动适应不同屏幕尺寸
- **iframe隔离**：验证页面在iframe中加载，安全隔离
- **自动检测**：无需手动操作，验证成功后自动继续

### 操作提示

弹窗中会显示详细的操作步骤：

1. 在下方窗口中完成滑块验证
2. 验证成功后，页面会自动跳转或显示成功信息
3. 等待3-5秒，系统会自动检测验证结果
4. 如果验证成功，弹窗会自动关闭并继续连接

### 关闭弹窗

- 点击右上角的"×"按钮可以手动关闭
- 验证成功后会自动关闭
- 超时（5分钟）后会自动关闭

## 常见问题

### 1. 弹窗显示空白

**原因**：验证URL可能失效或网络问题

**解决**：
- 刷新页面重试
- 检查网络连接
- 查看浏览器控制台是否有错误

### 2. 验证完成但没有自动继续

**原因**：Cookie可能没有正确更新

**解决**：
- 等待更长时间（最多5分钟）
- 手动关闭弹窗，重新点击"启动连接"
- 检查浏览器是否阻止了Cookie

### 3. 一直提示需要验证

**原因**：验证可能失败或Cookie未生效

**解决**：
- 确保滑块拖动到正确位置
- 尝试多次验证
- 清除浏览器缓存后重试

### 4. 验证超时

**原因**：5分钟内未完成验证

**解决**：
- 关闭弹窗
- 重新点击"启动连接"
- 更快地完成验证

## 验证方式说明

| 特性 | 人工验证 | 手动输入Token |
|------|---------|--------------|
| 成功率 | 高（接近100%） | 高（100%） |
| 速度 | 中等（需要人工操作） | 快（直接输入） |
| 稳定性 | 非常稳定 | 非常稳定 |
| 依赖 | 无需额外依赖 | 无需额外依赖 |
| 适用场景 | 首次连接、开发测试 | 已有Token、快速连接 |

## 推荐使用场景

### 适合人工验证

1. **开发测试阶段**
   - 首次配置账号
   - 调试功能时
   - 验证失败率高时

2. **重要操作**
   - 生产环境首次连接
   - 长时间未使用后重新连接
   - 账号安全性要求高时

3. **需要确保成功率**
   - 重要的生产环境连接
   - 需要确保100%成功率
   - 避免频繁重试

### 适合手动输入Token

1. **已有Token**
   - 已经通过其他方式获取了Token
   - Token仍在有效期内
   - 需要快速连接

2. **避免验证**
   - 不想频繁完成滑块验证
   - Token缓存在其他地方
   - 批量配置多个账号

## 技术细节

### iframe安全策略

```html
<iframe 
    id="captchaIframe" 
    sandbox="allow-same-origin allow-scripts allow-forms"
    src="验证URL">
</iframe>
```

**sandbox属性说明**：
- `allow-same-origin`：允许访问同源资源
- `allow-scripts`：允许执行JavaScript
- `allow-forms`：允许提交表单

### 定时检查逻辑

```javascript
// 最多检查60次（5分钟）
const maxChecks = 60;
let checkCount = 0;

// 每5秒检查一次
const checkInterval = setInterval(async () => {
    checkCount++;
    
    if (checkCount > maxChecks) {
        // 超时
        clearInterval(checkInterval);
        showError('验证超时');
        return;
    }
    
    // 尝试连接
    const result = await tryConnect();
    
    if (result.success) {
        // 成功
        clearInterval(checkInterval);
        showSuccess();
    }
}, 5000);
```

### 响应数据结构

**需要验证时**：
```json
{
    "code": 500,
    "message": "需要滑块验证",
    "data": {
        "needCaptcha": true,
        "captchaUrl": "https://...",
        "message": "需要完成滑块验证"
    }
}
```

**验证成功后**：
```json
{
    "code": 200,
    "message": "WebSocket连接已启动",
    "data": null
}
```

## 最佳实践

1. **首次使用**
   - 使用人工验证确保成功
   - 验证成功后Token会缓存20小时
   - 后续连接可能不需要验证

2. **开发测试**
   - 使用人工验证页面
   - 避免频繁触发验证
   - 保持Token有效期内使用

3. **生产环境**
   - 首次部署使用人工验证
   - 配置自动验证作为备选
   - 监控验证成功率

4. **故障恢复**
   - 自动验证失败时切换到人工
   - 记录验证失败原因
   - 优化验证策略

## 总结

人工滑块验证功能提供了一个可靠的备选方案，特别适合：

- ✅ 开发测试阶段
- ✅ 首次配置账号
- ✅ 自动验证失败后
- ✅ 需要确保100%成功率的场景

通过网页弹窗的方式，既保证了验证的成功率，又提供了良好的用户体验。
