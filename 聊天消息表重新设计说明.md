# 聊天消息表重新设计说明

## 一、表结构变更

### 新表结构
```sql
CREATE TABLE xianyu_chat_message (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    xianyu_account_id BIGINT NOT NULL,
    lwp VARCHAR(50),
    pnm_id VARCHAR(100) NOT NULL,
    s_id VARCHAR(100),
    content_type INTEGER,
    msg_content TEXT,
    sender_user_name VARCHAR(200),
    sender_user_id VARCHAR(100),
    sender_app_v VARCHAR(50),
    sender_os_type VARCHAR(20),
    reminder_url TEXT,
    complete_msg TEXT NOT NULL,
    message_time BIGINT,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 字段说明

| 字段名 | 类型 | 说明 | 对应消息字段 |
|--------|------|------|-------------|
| id | INTEGER | 主键自增 | - |
| xianyu_account_id | BIGINT | 关联的闲鱼账号ID | - |
| lwp | VARCHAR(50) | websocket消息类型 | WebSocket原始消息的lwp字段，如："/s/para" |
| pnm_id | VARCHAR(100) | 消息唯一ID | 解密后字段1.3 |
| s_id | VARCHAR(100) | 聊天框ID | 解密后字段1.2 |
| content_type | INTEGER | 消息类别 | 解密后字段1.6.3.5中的contentType |
| msg_content | TEXT | 消息内容 | 解密后字段1.10.reminderContent |
| sender_user_name | VARCHAR(200) | 发送者用户名 | 解密后字段1.10.reminderTitle |
| sender_user_id | VARCHAR(100) | 发送者用户ID | 解密后字段1.10.senderUserId |
| sender_app_v | VARCHAR(50) | 发送者APP版本 | 解密后字段1.10._appVersion |
| sender_os_type | VARCHAR(20) | 发送者系统类型 | 解密后字段1.10._platform |
| reminder_url | TEXT | 消息链接 | 解密后字段1.10.reminderUrl |
| complete_msg | TEXT | 完整消息JSON | 解密后的完整消息体 |
| message_time | BIGINT | 消息时间戳（毫秒） | 解密后字段1.5 |
| create_time | DATETIME | 创建时间 | 自动生成 |

**注意**: lwp字段来自WebSocket原始消息，其他字段来自解密后的消息内容。

## 二、消息类型说明

### content_type值
- **1**: 用户消息（普通聊天消息）
- **32**: 系统消息（如订单状态变更）

## 三、消息示例解析

### WebSocket原始消息结构
```json
{
  "lwp": "/s/para",
  "body": {
    "syncPushPackage": {
      "data": [
        {
          "data": "加密的消息内容..."
        }
      ]
    }
  }
}
```

### 示例1：用户消息（解密后）
```json
{
  "1": {
    "1": {"1": "3553532632@goofish"},
    "2": "55435931514@goofish",
    "3": "3813496236127.PNM",
    "5": 1762957508906,
    "6": {
      "3": {
        "5": "{\"contentType\":1,\"text\":{\"text\":\"舅舅舅舅\"}}"
      }
    },
    "10": {
      "_appVersion": "7.23.50",
      "_platform": "ios",
      "reminderContent": "舅舅舅舅",
      "reminderTitle": "肥极喵喵喵",
      "reminderUrl": "fleamarket://...",
      "senderUserId": "3553532632"
    }
  }
}
```

**提取结果：**
- lwp: "/s/para" (来自WebSocket原始消息)
- pnm_id: "3813496236127.PNM"
- s_id: "55435931514@goofish"
- content_type: 1
- msg_content: "舅舅舅舅"
- sender_user_name: "肥极喵喵喵"
- sender_user_id: "3553532632"
- sender_app_v: "7.23.50"
- sender_os_type: "ios"

### 示例2：系统消息（解密后）
```json
{
  "1": {
    "2": "50660220958@goofish",
    "3": "3813794318221.PNM",
    "5": 1762996838973,
    "6": {
      "3": {
        "5": "{\"contentType\":32,...}"
      }
    },
    "10": {
      "reminderContent": "[已付款，待发货]",
      "reminderTitle": "肥极喵喵喵",
      "senderUserId": "3553532632"
    }
  }
}
```

**提取结果：**
- lwp: "/s/para" (来自WebSocket原始消息)
- pnm_id: "3813794318221.PNM"
- s_id: "50660220958@goofish"
- content_type: 32
- msg_content: "[已付款，待发货]"
- sender_user_name: "肥极喵喵喵"
- sender_user_id: "3553532632"

## 四、数据库迁移步骤

### 1. 备份现有数据（如果有）
```sql
-- 导出现有数据
SELECT * FROM xianyu_chat_message;
```

### 2. 执行迁移脚本
```bash
# 执行迁移SQL
sqlite3 your_database.db < src/main/resources/sql/migration_chat_message_redesign.sql
```

或者在应用启动时自动执行（已配置在DatabaseInitListener中）

### 3. 验证表结构
```sql
-- 查看表结构
PRAGMA table_info(xianyu_chat_message);

-- 查看索引
SELECT * FROM sqlite_master WHERE type='index' AND tbl_name='xianyu_chat_message';
```

## 五、代码变更说明

### 1. 实体类更新
- `XianyuChatMessage.java` - 字段已更新为新的命名规范

### 2. Mapper更新
- `XianyuChatMessageMapper.java` - 更新了INSERT和查询方法
- 新增 `findByPnmId()` 方法
- 新增 `findBySId()` 方法
- 新增 `findBySenderUserId()` 方法

### 3. Service更新
- `ChatMessageServiceImpl.java` - 重写了消息解析和保存逻辑
- 支持从嵌套JSON中提取字段
- 自动解析contentType
- 保存完整消息体

## 六、使用示例

### 查询某个账号的所有消息
```java
List<XianyuChatMessage> messages = chatMessageService.getMessagesByAccountId(accountId, 1, 20);
```

### 查询某个会话的消息
```java
List<XianyuChatMessage> messages = chatMessageService.getMessagesBySessionId("55435931514@goofish");
```

### 查询用户消息（排除系统消息）
```sql
SELECT * FROM xianyu_chat_message 
WHERE xianyu_account_id = 1 AND content_type = 1 
ORDER BY message_time DESC;
```

### 查询系统消息
```sql
SELECT * FROM xianyu_chat_message 
WHERE xianyu_account_id = 1 AND content_type = 32 
ORDER BY message_time DESC;
```

## 七、注意事项

1. **唯一性约束**：`(xianyu_account_id, pnm_id)` 组合唯一，防止重复消息
2. **自动保存**：WebSocket接收到消息后会自动调用保存方法
3. **异常处理**：保存失败会静默跳过，不影响消息接收
4. **完整数据**：`complete_msg` 字段保存了完整的JSON，方便后续分析
5. **时间戳**：`message_time` 使用闲鱼的毫秒时间戳，保持一致性

## 八、测试建议

1. 发送一条用户消息，检查是否正确保存
2. 触发一条系统消息（如下单），检查是否正确保存
3. 查询数据库验证字段是否正确提取
4. 测试重复消息是否被正确过滤
