# 闲鱼扫码登录功能使用说明

## 功能概述

本功能实现了闲鱼扫码登录，可以通过二维码获取用户的Cookie信息。

## 项目结构

```
com.feijimiao.xianyuassistant
├── controller
│   └── QRLoginController.java          # 控制器层，提供REST API接口
├── service
│   ├── QRLoginService.java             # 服务接口定义
│   └── impl
│       └── QRLoginServiceImpl.java     # 服务实现类，核心业务逻辑
├── model
│   ├── QRLoginSession.java             # 登录会话模型
│   ├── QRLoginResponse.java            # 登录响应模型
│   └── QRStatusResponse.java           # 状态响应模型
└── utils
    └── CookieUtils.java                 # Cookie工具类（已存在）
```

## API接口说明

### 1. 生成二维码
- **接口**: `POST /api/qrlogin/generate`
- **功能**: 生成登录二维码
- **返回**:
```json
{
  "success": true,
  "sessionId": "uuid",
  "qrCodeUrl": "data:image/png;base64,..."
}
```

### 2. 查询登录状态
- **接口**: `GET /api/qrlogin/status/{sessionId}`
- **功能**: 查询二维码扫描状态
- **返回**:
```json
{
  "status": "success",
  "sessionId": "uuid",
  "cookies": "cookie字符串",
  "unb": "用户unb"
}
```

状态值说明：
- `waiting`: 等待扫码
- `scanned`: 已扫描，等待确认
- `success`: 登录成功
- `expired`: 二维码已过期
- `cancelled`: 用户取消登录
- `verification_required`: 需要风控验证

### 3. 获取Cookie
- **接口**: `GET /api/qrlogin/cookies/{sessionId}`
- **功能**: 获取登录成功后的Cookie
- **返回**:
```json
{
  "cookies": "cookie字符串",
  "unb": "用户unb"
}
```

### 4. 清理过期会话
- **接口**: `POST /api/qrlogin/cleanup`
- **功能**: 清理过期的登录会话

## 使用方式

### 方式一：使用前端页面

1. 启动Spring Boot应用
2. 访问: `http://localhost:8080/qrlogin.html`
3. 点击"生成二维码"按钮
4. 使用闲鱼APP扫描二维码
5. 在手机上确认登录
6. 页面会显示获取到的Cookie信息

### 方式二：直接调用API

```java
// 1. 生成二维码
QRLoginResponse response = qrLoginService.generateQRCode();
String sessionId = response.getSessionId();
String qrCodeUrl = response.getQrCodeUrl();

// 2. 轮询状态
while (true) {
    QRStatusResponse status = qrLoginService.getSessionStatus(sessionId);
    if ("success".equals(status.getStatus())) {
        String cookies = status.getCookies();
        String unb = status.getUnb();
        // 使用Cookie进行后续操作
        break;
    }
    Thread.sleep(1000);
}
```

## 核心实现逻辑

1. **获取m_h5_tk**: 首先请求闲鱼API获取必要的token
2. **获取登录参数**: 解析页面获取登录所需的表单参数
3. **生成二维码**: 调用API生成二维码内容，并转换为图片
4. **监控状态**: 后台线程持续轮询二维码扫描状态
5. **获取Cookie**: 登录成功后提取Cookie信息

## 注意事项

1. 二维码有效期为5分钟
2. 会话会自动清理过期数据
3. 如遇到风控验证，需要手动完成手机验证
4. Cookie获取后请妥善保管，不要泄露

## 依赖说明

项目已包含所需依赖：
- OkHttp: HTTP客户端
- Gson: JSON解析
- ZXing: 二维码生成
- Lombok: 简化代码

## 测试建议

1. 先使用前端页面测试基本流程
2. 确认能正常生成二维码
3. 使用闲鱼APP扫码测试
4. 验证Cookie是否正确获取
5. 测试过期和取消等异常场景
