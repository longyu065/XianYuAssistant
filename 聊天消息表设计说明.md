# 聊天消息表设计说明

## 表结构概览

`xianyu_chat_message` 表用于保存所有通过 WebSocket 接收到的聊天消息。

## 字段说明

### 关联信息
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| xianyu_account_id | BIGINT | 关联的闲鱼账号ID |
| session_id | VARCHAR(100) | 会话ID，用于区分不同的对话 |

### 消息基本信息
| 字段 | 类型 | 说明 |
|------|------|------|
| message_id | VARCHAR(100) | 闲鱼的消息ID，唯一标识 |
| message_type | INTEGER | 消息类型：1=文本 2=图片 3=语音 4=商品卡片 5=系统消息 |
| direction | TINYINT | 消息方向：1=发送（我发的）2=接收（收到的）|

### 用户信息
| 字段 | 类型 | 说明 |
|------|------|------|
| sender_user_id | VARCHAR(100) | 发送者用户ID |
| sender_nickname | VARCHAR(200) | 发送者昵称 |
| receiver_user_id | VARCHAR(100) | 接收者用户ID |
| receiver_nickname | VARCHAR(200) | 接收者昵称 |

### 消息内容
| 字段 | 类型 | 说明 |
|------|------|------|
| content_type | INTEGER | 内容类型：1=文本 2=图片 3=语音 101=文本消息 |
| content_text | TEXT | 纯文本内容，方便查询和显示 |
| content_json | TEXT | 完整的消息内容JSON |

### 商品信息
| 字段 | 类型 | 说明 |
|------|------|------|
| item_id | VARCHAR(100) | 商品ID（如果是商品相关对话）|
| item_title | VARCHAR(500) | 商品标题 |

### 消息状态
| 字段 | 类型 | 说明 |
|------|------|------|
| is_read | TINYINT | 是否已读：0=未读 1=已读 |
| read_time | DATETIME | 阅读时间 |

### 扩展信息
| 字段 | 类型 | 说明 |
|------|------|------|
| raw_data | TEXT | 原始解密后的完整JSON数据 |
| extra_info | TEXT | 额外信息JSON（位置、快捷回复等）|

### 时间信息
| 字段 | 类型 | 说明 |
|------|------|------|
| message_time | BIGINT | 消息时间戳（毫秒）|
| created_time | DATETIME | 记录创建时间 |
| updated_time | DATETIME | 记录更新时间 |

## 索引设计

| 索引名 | 字段 | 用途 |
|--------|------|------|
| idx_chat_message_account_id | xianyu_account_id | 按账号查询 |
| idx_chat_message_session_id | session_id | 按会话查询 |
| idx_chat_message_message_id | message_id | 按消息ID查询 |
| idx_chat_message_direction | direction | 按方向查询（发送/接收）|
| idx_chat_message_time | message_time | 按时间排序 |
| idx_chat_message_sender | sender_user_id | 按发送者查询 |
| idx_chat_message_receiver | receiver_user_id | 按接收者查询 |
| idx_chat_message_item_id | item_id | 按商品查询 |
| idx_chat_message_is_read | is_read | 查询未读消息 |
| idx_chat_message_unique | account_id, message_id | 防止重复消息（唯一索引）|

## 数据映射

### 从解密数据提取字段

根据解密后的消息结构：

```json
{
  "1": {
    "1": {"1": "2218021801256@goofish"},  // 发送者
    "2": "55435931514@goofish",            // 接收者
    "3": "3821739948157.PNM",              // 消息ID
    "5": 1762946473089,                    // 时间戳
    "6": {
      "1": 101,                            // 内容类型
      "3": {"2": "你好"}                   // 文本内容
    },
    "10": {
      "reminderTitle": "肥极喵资源",       // 发送者昵称
      "messageId": "xxx"
    }
  }
}
```

映射关系：
- `message_id` ← `1.3` 或 `1.10.messageId`
- `sender_user_id` ← `1.1.1`
- `receiver_user_id` ← `1.2`
- `sender_nickname` ← `1.10.reminderTitle`
- `content_type` ← `1.6.1`
- `content_text` ← `1.6.3.2`
- `message_time` ← `1.5`

## 使用场景

### 1. 保存收到的消息

```java
ChatMessage message = new ChatMessage();
message.setXianyuAccountId(1L);
message.setMessageId("3821739948157.PNM");
message.setDirection(2); // 接收
message.setSenderUserId("2218021801256@goofish");
message.setReceiverUserId("55435931514@goofish");
message.setContentText("你好");
message.setMessageTime(1762946473089L);
chatMessageMapper.insert(message);
```

### 2. 查询某个会话的消息

```sql
SELECT * FROM xianyu_chat_message 
WHERE session_id = 'xxx' 
ORDER BY message_time ASC;
```

### 3. 查询未读消息

```sql
SELECT * FROM xianyu_chat_message 
WHERE xianyu_account_id = 1 
AND is_read = 0 
AND direction = 2  -- 只查询接收的消息
ORDER BY message_time DESC;
```

### 4. 查询与某个用户的对话

```sql
SELECT * FROM xianyu_chat_message 
WHERE xianyu_account_id = 1 
AND (sender_user_id = '2218021801256@goofish' 
     OR receiver_user_id = '2218021801256@goofish')
ORDER BY message_time ASC;
```

### 5. 统计消息数量

```sql
-- 按方向统计
SELECT direction, COUNT(*) as count
FROM xianyu_chat_message 
WHERE xianyu_account_id = 1
GROUP BY direction;

-- 按日期统计
SELECT DATE(datetime(message_time/1000, 'unixepoch', 'localtime')) as date, 
       COUNT(*) as count
FROM xianyu_chat_message 
WHERE xianyu_account_id = 1
GROUP BY date
ORDER BY date DESC;
```

## 数据示例

| id | account_id | message_id | direction | sender_user_id | content_text | message_time |
|----|------------|------------|-----------|----------------|--------------|--------------|
| 1 | 1 | 3821739948157.PNM | 2 | 2218021801256@goofish | 你好 | 1762946473089 |
| 2 | 1 | 3821739948158.PNM | 1 | 55435931514@goofish | 你好，有什么可以帮你 | 1762946473190 |

## 注意事项

1. **防止重复**：使用唯一索引 `(xianyu_account_id, message_id)` 防止重复保存
2. **时间戳**：`message_time` 使用毫秒时间戳，与闲鱼保持一致
3. **方向判断**：根据 `receiver_user_id` 是否包含当前账号ID判断
4. **原始数据**：`raw_data` 保存完整的解密数据，方便后续分析
5. **会话ID**：可以从消息中提取或根据用户ID生成

## 扩展功能

### 1. 自动回复
根据 `content_text` 匹配关键词，自动发送回复

### 2. 消息统计
统计每天的消息数量、回复率等

### 3. 用户画像
根据聊天记录分析用户行为

### 4. 商品推荐
根据聊天内容推荐相关商品

## 下一步

1. 创建实体类 `XianyuChatMessage`
2. 创建 Mapper 接口 `XianyuChatMessageMapper`
3. 在消息处理器中保存消息到数据库
4. 创建查询接口和前端页面

## 相关文件

- `src/main/resources/sql/chat_message_table_design.sql` - 表结构SQL
- 待创建：`src/main/java/com/feijimiao/xianyuassistant/entity/XianyuChatMessage.java`
- 待创建：`src/main/java/com/feijimiao/xianyuassistant/mapper/XianyuChatMessageMapper.java`
