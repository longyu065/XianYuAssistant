# 自动发货功能实现说明

## 功能概述

实现了虚拟商品自动发货功能，当买家拍下商品后，系统自动发送发货内容。

## 数据库设计

### 1. xianyu_goods_config（商品配置表）
- id: 主键ID
- xianyu_account_id: 闲鱼账号ID
- xianyu_goods_id: 本地闲鱼商品ID
- xy_goods_id: 闲鱼的商品ID
- xianyu_auto_delivery_on: 自动发货开关（1-开启，0-关闭）
- xianyu_auto_reply_on: 自动回复开关（1-开启，0-关闭）
- create_time: 创建时间
- update_time: 更新时间

### 2. xianyu_goods_auto_delivery_config（自动发货配置表）
- id: 主键ID
- xianyu_account_id: 闲鱼账号ID
- xianyu_goods_id: 本地闲鱼商品ID
- xy_goods_id: 闲鱼的商品ID
- type: 发货类型（1-文本，2-自定义）
- auto_delivery_content: 自动发货的文本内容
- create_time: 创建时间
- update_time: 更新时间

### 3. xianyu_goods_auto_delivery_record（自动发货记录表）
- id: 主键ID
- xianyu_account_id: 闲鱼账号ID
- xianyu_goods_id: 本地闲鱼商品ID
- xy_goods_id: 闲鱼的商品ID
- content: 发货消息内容
- state: 状态（1-成功，0-失败）
- create_time: 创建时间

## 核心功能实现

### 1. 实体类
- XianyuGoodsConfig: 商品配置实体
- XianyuGoodsAutoDeliveryConfig: 自动发货配置实体
- XianyuGoodsAutoDeliveryRecord: 自动发货记录实体

### 2. Mapper层
- XianyuGoodsConfigMapper: 商品配置数据访问
- XianyuGoodsAutoDeliveryConfigMapper: 自动发货配置数据访问
- XianyuGoodsAutoDeliveryRecordMapper: 自动发货记录数据访问

### 3. Service层
- AutoDeliveryService: 自动发货服务接口
- AutoDeliveryServiceImpl: 自动发货服务实现

### 4. WebSocket消息处理
- AutoDeliveryHandler: 监听content_type=26的消息，当消息内容包含"[我已拍下，待付款]"时触发自动发货

## API接口修改

### 1. /api/items/list（商品列表接口）
**修改内容：**
- 返回数据新增 `itemsWithConfig` 字段，包含商品配置信息
- 每个商品包含：
  - item: 商品基本信息
  - xianyuAutoDeliveryOn: 自动发货开关
  - xianyuAutoReplyOn: 自动回复开关

**请求示例：**
```json
{
  "status": 0
}
```

**响应示例：**
```json
{
  "code": 200,
  "data": {
    "itemsWithConfig": [
      {
        "item": {
          "id": 123456,
          "xyGoodId": "789012",
          "title": "测试商品",
          "soldPrice": "99.00",
          ...
        },
        "xianyuAutoDeliveryOn": 1,
        "xianyuAutoReplyOn": 0
      }
    ],
    "totalCount": 1
  }
}
```

### 2. /api/items/detail（商品详情接口）
**修改内容：**
- 返回数据新增 `itemWithConfig` 字段，包含商品配置信息
- 包含字段：
  - item: 商品基本信息
  - xianyuAutoDeliveryOn: 自动发货开关
  - xianyuAutoReplyOn: 自动回复开关
  - autoDeliveryType: 自动发货类型
  - autoDeliveryContent: 自动发货内容

**请求示例：**
```json
{
  "xyGoodId": "789012",
  "cookieId": "1"
}
```

**响应示例：**
```json
{
  "code": 200,
  "data": {
    "itemWithConfig": {
      "item": {
        "id": 123456,
        "xyGoodId": "789012",
        "title": "测试商品",
        ...
      },
      "xianyuAutoDeliveryOn": 1,
      "xianyuAutoReplyOn": 0,
      "autoDeliveryType": 1,
      "autoDeliveryContent": "您好，这是您购买的虚拟商品内容..."
    }
  }
}
```

## 自动发货流程

1. **消息监听**
   - AutoDeliveryHandler 监听 WebSocket 消息
   - 检测 content_type=26 且内容包含"[我已拍下，待付款]"的消息

2. **触发条件检查**
   - 从消息中提取商品ID（xy_goods_id）和会话ID（sId）
   - 查询商品配置，检查是否开启自动发货

3. **发送发货消息**
   - 获取自动发货配置内容
   - 通过 WebSocketService 发送消息给买家
   - 记录发货结果到数据库

4. **记录保存**
   - 保存发货记录到 xianyu_goods_auto_delivery_record 表
   - 记录发货内容和成功/失败状态

## 使用说明

### 1. 配置自动发货
需要通过数据库或后续开发的管理接口配置：
- 在 xianyu_goods_config 表中设置 xianyu_auto_delivery_on = 1
- 在 xianyu_goods_auto_delivery_config 表中配置发货内容

### 2. 测试自动发货
1. 确保 WebSocket 已连接
2. 配置商品的自动发货开关和内容
3. 模拟买家拍下商品（发送包含"[我已拍下，待付款]"的消息）
4. 系统自动发送配置的发货内容

### 3. 查看发货记录
查询 xianyu_goods_auto_delivery_record 表可以看到所有自动发货记录。

## 自动回复功能

### 数据库表

#### 1. xianyu_goods_auto_reply_config（自动回复配置表）
- id: 主键ID
- xianyu_account_id: 闲鱼账号ID
- xianyu_goods_id: 本地闲鱼商品ID
- xy_goods_id: 闲鱼的商品ID
- keyword: 关键词（支持多个，用逗号分隔）
- reply_content: 回复内容
- match_type: 匹配类型（1-包含，2-完全匹配，3-正则）
- create_time: 创建时间
- update_time: 更新时间

#### 2. xianyu_goods_auto_reply_record（自动回复记录表）
- id: 主键ID
- xianyu_account_id: 闲鱼账号ID
- xianyu_goods_id: 本地闲鱼商品ID
- xy_goods_id: 闲鱼的商品ID
- buyer_message: 买家消息内容
- reply_content: 回复消息内容
- matched_keyword: 匹配的关键词
- state: 状态（1-成功，0-失败）
- create_time: 创建时间

### 自动回复流程

1. **消息监听**
   - AutoReplyHandler 监听 WebSocket 消息
   - 检测 content_type=1 的普通文本消息

2. **关键词匹配**
   - 支持三种匹配类型：
     - 包含匹配（默认）：消息包含关键词即匹配
     - 完全匹配：消息完全等于关键词
     - 正则匹配：使用正则表达式匹配
   - 支持多个关键词（用逗号分隔）

3. **发送回复**
   - 匹配成功后，发送配置的回复内容
   - 模拟人工操作延迟（阅读+思考+打字）
   - 记录回复结果到数据库

## 人工操作延迟模拟

为了使自动化操作更像真人，系统添加了随机延迟：

### 延迟类型

1. **短延迟**（500-1500ms）：快速操作
2. **中等延迟**（1000-3000ms）：页面加载、消息发送
3. **长延迟**（2000-5000ms）：页面切换、复杂操作
4. **阅读延迟**：根据文本长度计算（50-100ms/字符，最多5秒）
5. **思考延迟**（1000-4000ms）：模拟人思考时间
6. **打字延迟**：根据文本长度计算（100-200ms/字符，最多10秒）
7. **翻页延迟**（800-2000ms）：模拟翻页操作

### 应用场景

1. **自动发货**：阅读消息 → 思考 → 打字 → 发送
2. **自动回复**：阅读消息 → 思考 → 打字 → 发送
3. **获取商品列表**：每次翻页添加随机延迟

## 注意事项

1. **消息类型**：
   - 自动发货监听 content_type=26（系统消息）
   - 自动回复监听 content_type=1（普通文本消息）

2. **WebSocket连接**：自动发货和自动回复都依赖 WebSocket 连接，需要确保连接正常

3. **配置管理**：当前需要直接操作数据库配置，建议后续开发配置管理接口

4. **错误处理**：所有操作都会记录到数据库，可以通过 state 字段查看成功/失败状态

5. **延迟设置**：延迟时间是随机的，可以根据需要调整 HumanLikeDelayUtils 中的参数

6. **避免重复回复**：系统会检查发送者ID，避免回复自己发送的消息

## 数据库迁移

执行迁移脚本：
```bash
# 迁移脚本位置
src/main/resources/sql/migration_add_auto_delivery.sql
```

或者重新初始化数据库（会创建所有表）：
```bash
# 完整schema位置
src/main/resources/sql/schema.sql
```

## 配置示例

### 自动发货配置示例

```sql
-- 1. 开启商品的自动发货开关
INSERT INTO xianyu_goods_config (xianyu_account_id, xy_goods_id, xianyu_auto_delivery_on, xianyu_auto_reply_on)
VALUES (1, '789012', 1, 0);

-- 2. 配置自动发货内容
INSERT INTO xianyu_goods_auto_delivery_config (xianyu_account_id, xy_goods_id, type, auto_delivery_content)
VALUES (1, '789012', 1, '您好！感谢购买，这是您的虚拟商品内容：\n激活码：XXXX-XXXX-XXXX\n使用说明：...');
```

### 自动回复配置示例

```sql
-- 1. 开启商品的自动回复开关
UPDATE xianyu_goods_config SET xianyu_auto_reply_on = 1 WHERE xy_goods_id = '789012';

-- 2. 配置自动回复规则（包含匹配）
INSERT INTO xianyu_goods_auto_reply_config (xianyu_account_id, xy_goods_id, keyword, reply_content, match_type)
VALUES (1, '789012', '在吗,你好,咨询', '您好！我在的，有什么可以帮您？', 1);

-- 3. 配置自动回复规则（完全匹配）
INSERT INTO xianyu_goods_auto_reply_config (xianyu_account_id, xy_goods_id, keyword, reply_content, match_type)
VALUES (1, '789012', '多少钱', '这个商品价格是99元哦~', 2);

-- 4. 配置自动回复规则（正则匹配）
INSERT INTO xianyu_goods_auto_reply_config (xianyu_account_id, xy_goods_id, keyword, reply_content, match_type)
VALUES (1, '789012', '.*包邮.*', '亲，全国包邮的哦！', 3);
```

## 后续优化建议

1. 添加配置管理接口（增删改查商品配置）
2. 添加发货和回复模板管理
3. 支持更多消息类型的自动处理
4. 添加发货和回复统计报表功能
5. 支持智能回复（AI集成）
6. 添加黑名单功能（某些用户不自动回复）
7. 支持时间段控制（只在特定时间段自动回复）
