# 聊天消息自动保存功能说明

## 功能概述

系统现在会自动将 WebSocket 接收到的 `/s/sync` 消息解密后保存到数据库的 `xianyu_chat_message` 表中。

## 实现内容

### 1. 数据库表自动创建

在 `DatabaseInitListener` 中添加了 `xianyu_chat_message` 表的自动检测和创建：

- **表结构**：包含消息ID、会话ID、发送者/接收者信息、消息内容、时间戳等字段
- **索引**：创建了10个索引，包括唯一索引防止重复消息
- **触发器**：自动更新 `updated_time` 字段

### 2. 实体类和Mapper

**XianyuChatMessage.java**
- 聊天消息实体类，包含所有字段的映射

**XianyuChatMessageMapper.java**
- 提供插入、查询、防重复等数据库操作
- 支持按账号ID、会话ID、消息ID查询

### 3. 服务层

**ChatMessageService.java / ChatMessageServiceImpl.java**
- `saveChatMessage()`: 保存解密后的JSON消息
- `saveChatMessageFromMap()`: 从Map保存消息
- 自动提取消息字段（发送者、接收者、内容、时间等）
- 自动判断消息方向（发送/接收）
- 防止重复保存（通过消息ID检查）

### 4. WebSocket集成

**XianyuWebSocketClient.java**
- 在解密 `/s/sync` 消息后，自动调用 `ChatMessageService` 保存
- 保存失败不影响消息处理流程

**WebSocketServiceImpl.java**
- 注入 `ChatMessageService`
- 在创建 WebSocket 客户端时设置服务

## 消息字段映射

解密后的消息JSON字段映射：

| JSON字段 | 数据库字段 | 说明 |
|---------|-----------|------|
| 1.1.1 | sender_user_id | 发送者用户ID |
| 1.1.2 | sender_nickname | 发送者昵称 |
| 1.2 | receiver_user_id | 接收者用户ID |
| 1.3 | message_id | 消息ID（唯一） |
| 1.4.1 | content_type | 内容类型 |
| 1.4.2 | content_text | 文本内容 |
| 1.5 | message_time | 消息时间戳 |
| 1.6 | session_id | 会话ID |

## 消息方向判断

- **接收消息（direction=2）**：接收者ID包含当前账号ID
- **发送消息（direction=1）**：发送者ID包含当前账号ID

## 防重复机制

- 使用 `(xianyu_account_id, message_id)` 唯一索引
- 保存前先查询是否已存在
- 已存在的消息静默跳过保存
- 捕获 `DuplicateKeyException` 唯一索引冲突异常，静默跳过
- 所有异常都静默处理，不影响消息接收流程

## 日志输出

保存成功时会输出：
```
【账号{accountId}】保存聊天消息成功: messageId={messageId}, direction={发送/接收}, content={内容}
```

## 查询示例

```java
// 查询账号的消息（分页）
List<XianyuChatMessage> messages = chatMessageService.getMessagesByAccountId(accountId, 1, 20);

// 查询会话的消息
List<XianyuChatMessage> messages = chatMessageService.getMessagesBySessionId(sessionId);
```

## 注意事项

1. **已读回执不保存**：消息类型为2的已读回执会被跳过
2. **自动去重**：相同的消息ID不会重复保存
3. **静默处理**：
   - 消息ID已存在时，静默跳过（debug日志）
   - 唯一索引冲突时，静默跳过（debug日志）
   - 数据库异常时，静默跳过（debug日志）
   - 不会记录error级别日志，不影响消息接收流程
4. **完整数据**：原始JSON保存在 `raw_data` 字段，方便后续分析

## 启动流程

1. 应用启动时，`DatabaseInitListener` 自动检测并创建 `xianyu_chat_message` 表
2. WebSocket 连接建立后，接收到 `/s/sync` 消息
3. 消息解密成功后，自动调用 `ChatMessageService.saveChatMessage()`
4. 提取字段并保存到数据库
5. 日志输出保存结果

## 测试验证

启动应用后，查看日志：
- 启动时应该看到：`✓ 表已存在: xianyu_chat_message` 或 `➕ 创建表: xianyu_chat_message`
- 收到消息时应该看到：`【账号X】保存聊天消息成功: messageId=xxx`

查询数据库验证：
```sql
SELECT * FROM xianyu_chat_message ORDER BY message_time DESC LIMIT 10;
```
