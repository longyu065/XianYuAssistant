# 滑块验证快速指南

## 用户操作指南

### 遇到滑块验证时该怎么做？

#### 步骤 1：启动连接
点击"▶ 启动连接"按钮

#### 步骤 2：看到验证提示
如果账号需要验证，会弹出对话框：
```
⚠️ 需要滑块验证

检测到账号需要完成滑块验证才能启动连接。

点击"打开验证"将在新窗口中打开验证页面，
完成验证后请点击"清除验证等待"按钮重试。

        [取消]  [打开验证]
```

#### 步骤 3：打开验证页面
点击"打开验证"按钮，系统会自动在新窗口打开验证页面

> 💡 如果新窗口没有打开，请检查浏览器是否拦截了弹出窗口

#### 步骤 4：完成滑块验证
在新窗口中完成滑块验证操作

#### 步骤 5：清除等待状态
回到原页面，点击"🔓 清除验证等待"按钮

#### 步骤 6：重新启动连接
再次点击"▶ 启动连接"按钮，连接成功！

---

## 常见问题

### Q1: 新窗口没有打开怎么办？
**A:** 浏览器可能拦截了弹出窗口
- 检查浏览器地址栏右侧是否有弹窗拦截图标
- 点击允许弹出窗口
- 或者查看操作日志中的验证 URL，手动复制到浏览器打开

### Q2: 完成验证后还是连接失败？
**A:** 需要先清除验证等待状态
- 点击"🔓 清除验证等待"按钮
- 等待提示"验证等待状态已清除"
- 再次点击"▶ 启动连接"

### Q3: 验证链接打开后显示已过期？
**A:** 验证 URL 有 5 分钟有效期
- 关闭验证窗口
- 重新点击"▶ 启动连接"获取新的验证链接

### Q4: 为什么会触发滑块验证？
**A:** 可能的原因：
- 频繁启动/断开连接
- 短时间内多次请求
- 账号被系统标记为异常
- 建议：避免频繁操作，等待一段时间后再试

### Q5: 如何避免频繁触发验证？
**A:** 最佳实践：
- ✅ 启动连接后保持稳定运行
- ✅ 避免频繁断开重连
- ✅ 不要同时操作多个账号
- ❌ 不要短时间内反复启动/停止

---

## 按钮说明

| 按钮 | 功能 | 使用场景 |
|-----|------|---------|
| ▶ 启动连接 | 启动 WebSocket 连接 | 需要接收消息时 |
| ⏹ 停止连接 | 断开 WebSocket 连接 | 暂时不需要接收消息时 |
| 🔓 清除验证等待 | 清除验证等待状态 | 完成滑块验证后 |

---

## 操作日志示例

### 正常流程
```
[16:03:10] 正在启动连接...
[16:03:11] ⚠️ 需要完成滑块验证
[16:03:11] 已在新窗口打开验证页面，请完成验证后点击"清除验证等待"按钮重试
[16:03:45] 正在清除验证等待状态...
[16:03:45] ✅ 验证等待状态已清除
[16:03:50] 正在启动连接...
[16:03:51] 连接启动成功
```

### 错误示例（忘记清除等待状态）
```
[16:03:10] 正在启动连接...
[16:03:11] ⚠️ 需要完成滑块验证
[16:03:11] 已在新窗口打开验证页面，请完成验证后点击"清除验证等待"按钮重试
[16:04:00] 正在启动连接...  ← 直接重试，没有清除等待状态
[16:04:01] ⚠️ 需要完成滑块验证  ← 还是返回验证提示
```

**正确做法：** 完成验证后先点击"🔓 清除验证等待"

---

## 技术说明（开发者）

### API 接口

#### 启动连接
```
POST /api/websocket/start
Body: { xianyuAccountId: number }

成功响应:
{ code: 200, msg: "WebSocket连接已启动" }

需要验证响应:
{
  code: 500,
  msg: "需要滑块验证",
  data: {
    needCaptcha: true,
    captchaUrl: "https://...",
    message: "..."
  }
}
```

#### 清除验证等待
```
POST /api/websocket/clearCaptchaWait
Body: { xianyuAccountId: number }

响应:
{ code: 200, msg: "验证等待状态已清除，可以重新请求" }
```

### 前端处理逻辑
```typescript
// 检测验证响应
if (response.code === 500 && response.data?.needCaptcha) {
  // 显示对话框
  await ElMessageBox.confirm('...');
  
  // 打开验证窗口
  window.open(captchaUrl, '_blank', 'width=800,height=600');
  
  // 提示用户后续操作
  showInfo('请在新窗口完成验证，然后点击"清除验证等待"按钮重试');
}
```

---

## 总结

滑块验证处理现在变得非常简单：

1. ✅ **自动弹窗提示** - 不需要查看日志
2. ✅ **自动打开验证页面** - 不需要复制链接
3. ✅ **一键清除等待** - 不需要手动操作
4. ✅ **清晰的操作指引** - 知道每一步该做什么

遇到验证不要慌，按照提示操作即可！
