# 自动发货记录功能说明

## 功能概述

在自动发货配置页面添加了自动发货记录的显示功能，用户可以查看每次自动发货的详细记录，包括买家信息、发货内容、发货状态和发货时间。

## 修改内容

### 1. 数据库表修改

#### 1.1 添加字段
在 `xianyu_goods_auto_delivery_record` 表中添加了 `buyer_user_name` 字段：

```sql
ALTER TABLE xianyu_goods_auto_delivery_record 
ADD COLUMN buyer_user_name VARCHAR(100);
```

#### 1.2 更新表结构
- **文件**: `src/main/resources/sql/schema.sql`
- **修改**: 在表定义中添加 `buyer_user_name VARCHAR(100)` 字段

#### 1.3 更新数据库初始化监听器
- **文件**: `src/main/java/com/feijimiao/xianyuassistant/config/DatabaseInitListener.java`
- **修改**: 
  - 在 `requiredTables` 中的表创建SQL添加 `buyer_user_name` 字段
  - 在 `checkAndAddColumns` 方法中添加字段检查逻辑

### 2. 后端修改

#### 2.1 实体类更新
- **文件**: `src/main/java/com/feijimiao/xianyuassistant/entity/XianyuGoodsAutoDeliveryRecord.java`
- **修改**: 添加 `goodsTitle` 字段（用于关联查询显示商品标题）

#### 2.2 Mapper更新
- **文件**: `src/main/java/com/feijimiao/xianyuassistant/mapper/XianyuGoodsAutoDeliveryRecordMapper.java`
- **修改**:
  - 更新 `insert` 方法，添加 `buyer_user_name` 字段
  - 添加 `selectByAccountIdWithPage` 方法（分页查询，关联商品表获取标题）
  - 添加 `countByAccountId` 方法（统计记录总数）

#### 2.3 Service接口和实现类更新
- **文件**: 
  - `src/main/java/com/feijimiao/xianyuassistant/service/AutoDeliveryService.java`
  - `src/main/java/com/feijimiao/xianyuassistant/service/impl/AutoDeliveryServiceImpl.java`
- **修改**:
  - `recordAutoDelivery` 方法添加 `buyerUserName` 参数
  - `handleAutoDelivery` 方法添加 `buyerUserName` 参数
  - 添加 `getAutoDeliveryRecords` 方法（查询自动发货记录）

#### 2.4 WebSocket处理器更新
- **文件**: `src/main/java/com/feijimiao/xianyuassistant/websocket/handler/AutoDeliveryHandler.java`
- **修改**:
  - 从消息中提取 `buyerUserName`（从 `reminderTitle` 字段）
  - 在 `AutoDeliveryParams` 类中添加 `buyerUserName` 字段
  - 调用 `handleAutoDelivery` 时传递买家用户名

#### 2.5 Controller更新
- **文件**: `src/main/java/com/feijimiao/xianyuassistant/controller/ItemController.java`
- **修改**:
  - 注入 `AutoDeliveryService`
  - 添加 `/api/items/autoDeliveryRecords` 接口

#### 2.6 DTO类创建
创建了以下DTO类：
- `AutoDeliveryRecordReqDTO.java` - 查询请求DTO
- `AutoDeliveryRecordDTO.java` - 记录数据DTO
- `AutoDeliveryRecordRespDTO.java` - 查询响应DTO

### 3. 前端修改

#### 3.1 API接口
- **文件**: `vue-code/src/api/auto-delivery-record.ts`（新建）
- **内容**: 定义了自动发货记录相关的接口和类型

#### 3.2 页面更新
- **文件**: `vue-code/src/views/auto-delivery/index.vue`
- **修改**:
  - 导入自动发货记录API
  - 添加记录相关的响应式变量（`deliveryRecords`、`recordsTotal`等）
  - 添加 `loadDeliveryRecords` 方法（加载记录）
  - 添加分页处理方法（`handleRecordsPageChange`、`handleRecordsSizeChange`）
  - 在选择商品时自动加载记录
  - 在配置面板下方添加记录列表展示

#### 3.3 UI组件
在自动发货配置页面添加了记录表格，包含以下列：
- **买家信息**: 显示买家用户名和用户ID
- **发货内容**: 显示自动发送的内容
- **状态**: 显示成功/失败状态（带颜色标签）
- **发货时间**: 显示记录创建时间

支持分页显示，每页可选择10/20/50/100条记录。

## 使用说明

1. 进入"自动发货配置"页面
2. 选择账号和商品
3. 在配置面板下方可以看到"自动发货记录"卡片
4. 记录表格显示该商品的所有自动发货记录
5. 支持分页浏览历史记录

## 数据流程

1. 买家下单后，WebSocket接收到"[我已拍下，待付款]"消息
2. `AutoDeliveryHandler` 提取买家用户ID和用户名
3. `AutoDeliveryService` 处理自动发货逻辑
4. 发货完成后调用 `recordAutoDelivery` 记录结果
5. 前端通过 `/api/items/autoDeliveryRecords` 接口查询记录
6. 页面展示记录列表

## 注意事项

1. 系统启动时会自动检查并添加 `buyer_user_name` 字段
2. 旧数据的 `buyer_user_name` 字段可能为空
3. 记录按创建时间倒序排列（最新的在前）
4. 记录支持按商品筛选，也可以查看账号下所有商品的记录
