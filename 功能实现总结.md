# é—²é±¼åŠ©æ‰‹åŠŸèƒ½å®ç°æ€»ç»“

## å·²å®ç°åŠŸèƒ½

### 1. WebSocketæ¶ˆæ¯å‘é€åŠŸèƒ½ âœ…

**å®ç°æ–‡ä»¶**ï¼š
- `XianyuWebSocketClient.java` - WebSocketå®¢æˆ·ç«¯ï¼ŒåŒ…å«sendMessageæ–¹æ³•
- `WebSocketService.java` - æœåŠ¡æ¥å£
- `WebSocketServiceImpl.java` - æœåŠ¡å®ç°
- `WebSocketController.java` - APIæ§åˆ¶å™¨

**åŠŸèƒ½ç‰¹ç‚¹**ï¼š
- å®Œå…¨å‚è€ƒPythonä»£ç å®ç°
- æ”¯æŒå‘æŒ‡å®šç”¨æˆ·å‘é€æ–‡æœ¬æ¶ˆæ¯
- è‡ªåŠ¨å¤„ç†æ¶ˆæ¯æ ¼å¼å’ŒBase64ç¼–ç 
- è‡ªåŠ¨æ·»åŠ @goofishåç¼€
- è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

**APIæ¥å£**ï¼š
```
POST /api/websocket/sendMessage
{
  "xianyuAccountId": 1,
  "cid": "ä¼šè¯ID",
  "toId": "æ¥æ”¶æ–¹ç”¨æˆ·ID",
  "text": "æ¶ˆæ¯å†…å®¹"
}
```

**æµ‹è¯•é¡µé¢**ï¼š
- `websocket-send.html` - æ¶ˆæ¯å‘é€æµ‹è¯•é¡µé¢
- `websocket.html` - WebSocketç›‘å¬é¡µé¢

**æ–‡æ¡£**ï¼š
- `æ¶ˆæ¯å‘é€åŠŸèƒ½è¯´æ˜.md` - å®Œæ•´åŠŸèƒ½è¯´æ˜
- `æ¶ˆæ¯å‘é€500é”™è¯¯æ’æŸ¥æŒ‡å—.md` - é”™è¯¯æ’æŸ¥æŒ‡å—
- `å¿«é€Ÿæµ‹è¯•æ¶ˆæ¯å‘é€.md` - å¿«é€Ÿæµ‹è¯•æŒ‡å—
- `æŸ¥è¯¢æ¶ˆæ¯å‚æ•°SQLç¤ºä¾‹.md` - SQLæŸ¥è¯¢ç¤ºä¾‹

**å…³é”®å®ç°**ï¼š
```java
// å‘é€æ¶ˆæ¯
public void sendMessage(String cid, String toId, String text) {
    // æ„é€ æ¶ˆæ¯å†…å®¹
    Map<String, Object> textContent = new HashMap<>();
    textContent.put("contentType", 1);
    textContent.put("text", Map.of("text", text));
    
    // Base64ç¼–ç 
    String textBase64 = Base64.getEncoder()
        .encodeToString(objectMapper.writeValueAsString(textContent).getBytes());
    
    // æ„é€ å®Œæ•´æ¶ˆæ¯
    Map<String, Object> message = new HashMap<>();
    message.put("lwp", "/r/MessageSend/sendByReceiverScope");
    message.put("headers", Map.of("mid", generateMid()));
    message.put("body", Arrays.asList(messageBody, receivers));
    
    // å‘é€
    send(objectMapper.writeValueAsString(message));
}
```

### 2. ç¡®è®¤å‘è´§åŠŸèƒ½ âœ…

**å®ç°æ–‡ä»¶**ï¼š
- `OrderController.java` - è®¢å•æ§åˆ¶å™¨
- `OrderService.java` - è®¢å•æœåŠ¡æ¥å£
- `OrderServiceImpl.java` - è®¢å•æœåŠ¡å®ç°
- `XianyuSignUtils.java` - ç­¾åå·¥å…·ç±»

**åŠŸèƒ½ç‰¹ç‚¹**ï¼š
- å®Œå…¨å‚è€ƒPythonä»£ç å®ç°
- æ”¯æŒä¸€é”®ç¡®è®¤å‘è´§
- è‡ªåŠ¨ç”Ÿæˆç­¾å
- é€‚ç”¨äºè™šæ‹Ÿå•†å“æˆ–æ— éœ€ç‰©æµçš„å•†å“

**APIæ¥å£**ï¼š
```
POST /api/order/confirmShipment
{
  "xianyuAccountId": 1,
  "orderId": "è®¢å•ID"
}
```

**æµ‹è¯•é¡µé¢**ï¼š
- `order.html` - ç¡®è®¤å‘è´§æµ‹è¯•é¡µé¢

**æ–‡æ¡£**ï¼š
- `ç¡®è®¤å‘è´§åŠŸèƒ½è¯´æ˜.md` - å®Œæ•´åŠŸèƒ½è¯´æ˜
- `æµ‹è¯•ç¡®è®¤å‘è´§API.bat` - æµ‹è¯•è„šæœ¬

**å…³é”®å®ç°**ï¼š
```java
// ç¡®è®¤å‘è´§
public boolean confirmShipment(Long accountId, String orderId) {
    // æå–token
    String token = XianyuSignUtils.extractToken(cookies);
    
    // ç”Ÿæˆæ—¶é—´æˆ³
    String timestamp = String.valueOf(System.currentTimeMillis());
    
    // æ„é€ dataå‚æ•°
    String dataVal = "{\"orderId\":\"" + orderId + 
        "\",\"tradeText\":\"\",\"picList\":[],\"newUnconsign\":true}";
    
    // ç”Ÿæˆç­¾å
    String sign = XianyuSignUtils.generateSign(timestamp, token, dataVal);
    
    // å‘é€è¯·æ±‚
    HttpRequest request = HttpRequest.newBuilder()
        .uri(URI.create(url))
        .header("Cookie", cookieStr)
        .POST(HttpRequest.BodyPublishers.ofString("data=" + URLEncoder.encode(dataVal)))
        .build();
    
    HttpResponse<String> response = httpClient.send(request);
    
    // è§£æå“åº”
    return response.body().contains("SUCCESS");
}
```

## æ•°æ®åº“å­—æ®µå¯¹åº”å…³ç³»

### èŠå¤©æ¶ˆæ¯è¡¨ (xianyu_chat_message)

| å‚æ•°å | æ•°æ®åº“å­—æ®µ | è¯´æ˜ |
|--------|-----------|------|
| cid | `session_id` | ä¼šè¯IDï¼ˆä¸å¸¦@goofishåç¼€ï¼‰ |
| toId | `sender_user_id` æˆ– `receiver_user_id` | ç”¨æˆ·IDï¼ˆä¸å¸¦@goofishåç¼€ï¼‰ |
| accountId | `xianyu_account_id` | è´¦å·ID |
| myUserId | Cookieçš„`unb`å­—æ®µ | å½“å‰ç”¨æˆ·ID |

**æ¶ˆæ¯æ–¹å‘**ï¼š
- `direction = 1`ï¼šå‘é€çš„æ¶ˆæ¯ï¼ˆæˆ‘å‘çš„ï¼‰
- `direction = 2`ï¼šæ¥æ”¶çš„æ¶ˆæ¯ï¼ˆæ”¶åˆ°çš„ï¼‰

**å¦‚ä½•ç¡®å®štoId**ï¼š
- å›å¤æ”¶åˆ°çš„æ¶ˆæ¯ï¼ˆdirection=2ï¼‰ï¼šä½¿ç”¨`sender_user_id`
- ç»§ç»­ä¹‹å‰çš„å¯¹è¯ï¼ˆdirection=1ï¼‰ï¼šä½¿ç”¨`receiver_user_id`

## æŠ€æœ¯è¦ç‚¹

### 1. WebSocketæ¶ˆæ¯æ ¼å¼

```json
{
  "lwp": "/r/MessageSend/sendByReceiverScope",
  "headers": {
    "mid": "éšæœºæ•° + æ—¶é—´æˆ³ + ' 0'"
  },
  "body": [
    {
      "uuid": "è´Ÿæ•°æ—¶é—´æˆ³",
      "cid": "ä¼šè¯ID@goofish",
      "conversationType": 1,
      "content": {
        "contentType": 101,
        "custom": {
          "type": 1,
          "data": "Base64ç¼–ç çš„æ¶ˆæ¯å†…å®¹"
        }
      },
      "redPointPolicy": 0,
      "extension": {"extJson": "{}"},
      "ctx": {"appVersion": "1.0", "platform": "web"},
      "mtags": {},
      "msgReadStatusSetting": 1
    },
    {
      "actualReceivers": [
        "æ¥æ”¶æ–¹ID@goofish",
        "å‘é€æ–¹ID@goofish"
      ]
    }
  ]
}
```

### 2. ç­¾åç”Ÿæˆç®—æ³•

```
MD5(token + "&" + timestamp + "&" + appKey + "&" + data)
```

**å‚æ•°è¯´æ˜**ï¼š
- `token`: Cookieçš„`_m_h5_tk`å­—æ®µï¼Œå–ä¸‹åˆ’çº¿å‰çš„éƒ¨åˆ†
- `timestamp`: å½“å‰æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
- `appKey`: å›ºå®šå€¼ `34839810`
- `data`: POST bodyä¸­çš„dataå‚æ•°å€¼ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰

### 3. ç”¨æˆ·IDå¤„ç†

**é‡è¦**ï¼š
- `accountId`ï¼ˆæ•°æ®åº“IDï¼‰â‰  `userId`ï¼ˆé—²é±¼ç”¨æˆ·IDï¼‰
- å‘é€æ¶ˆæ¯æ—¶ä½¿ç”¨Cookieçš„`unb`å­—æ®µä½œä¸ºå½“å‰ç”¨æˆ·ID
- ä¸è¦ä½¿ç”¨`accountId`ä½œä¸ºç”¨æˆ·ID

## æµ‹è¯•æ–¹æ³•

### 1. æµ‹è¯•æ¶ˆæ¯å‘é€

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨Webç•Œé¢
è®¿é—®ï¼šhttp://localhost:8080/websocket-send.html

# æ–¹æ³•2ï¼šä½¿ç”¨curlå‘½ä»¤
curl -X POST http://localhost:8080/api/websocket/sendMessage \
  -H "Content-Type: application/json" \
  -d "{\"xianyuAccountId\": 1, \"cid\": \"3812882055015\", \"toId\": \"3553532632\", \"text\": \"æµ‹è¯•\"}"

# æ–¹æ³•3ï¼šä½¿ç”¨æ‰¹å¤„ç†æ–‡ä»¶
è¿è¡Œï¼šæµ‹è¯•æ¶ˆæ¯å‘é€API.bat
```

### 2. æµ‹è¯•ç¡®è®¤å‘è´§

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨Webç•Œé¢
è®¿é—®ï¼šhttp://localhost:8080/order.html

# æ–¹æ³•2ï¼šä½¿ç”¨curlå‘½ä»¤
curl -X POST http://localhost:8080/api/order/confirmShipment \
  -H "Content-Type: application/json" \
  -d "{\"xianyuAccountId\": 1, \"orderId\": \"1234567890\"}"

# æ–¹æ³•3ï¼šä½¿ç”¨æ‰¹å¤„ç†æ–‡ä»¶
è¿è¡Œï¼šæµ‹è¯•ç¡®è®¤å‘è´§API.bat
```

## ä¸»é¡µå¯¼èˆª

å·²åœ¨ä¸»é¡µæ·»åŠ ä»¥ä¸‹èœå•ï¼š

**è®¢å•ç®¡ç†**ï¼š
- ğŸšš ç¡®è®¤å‘è´§

**æ¶ˆæ¯ç®¡ç†**ï¼š
- ğŸ”Œ WebSocketç›‘å¬
- ğŸ’¬ å‘é€æ¶ˆæ¯

è®¿é—®ä¸»é¡µï¼š`http://localhost:8080/index.html`

## å¸¸è§é—®é¢˜

### 1. æ¶ˆæ¯å‘é€è¿”å›500é”™è¯¯

**åŸå› **ï¼š
- `myUserId`æœªæ­£ç¡®è®¾ç½®ï¼ˆä½¿ç”¨äº†accountIdè€Œä¸æ˜¯unbï¼‰
- `cid`æˆ–`toId`æ ¼å¼é”™è¯¯ï¼ˆåŒ…å«äº†@goofishåç¼€ï¼‰
- æ¶ˆæ¯æ ¼å¼ä¸æ­£ç¡®

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥æ—¥å¿—ä¸­çš„`myUserId`æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤`cid`å’Œ`toId`ä¸åŒ…å«`@goofish`åç¼€
3. æŸ¥çœ‹å®Œæ•´çš„é”™è¯¯æ—¥å¿—

### 2. ç¡®è®¤å‘è´§å¤±è´¥

**åŸå› **ï¼š
- Cookieè¿‡æœŸ
- ç­¾åé”™è¯¯
- è®¢å•çŠ¶æ€ä¸å…è®¸

**è§£å†³æ–¹æ³•**ï¼š
1. é‡æ–°ç™»å½•è·å–Cookie
2. æ£€æŸ¥ç­¾åç”Ÿæˆé€»è¾‘
3. ç¡®è®¤è®¢å•æ˜¯å¦å¤„äºå¾…å‘è´§çŠ¶æ€

### 3. WebSocketæœªè¿æ¥

**è§£å†³æ–¹æ³•**ï¼š
1. è®¿é—® `http://localhost:8080/websocket-send.html`
2. ç‚¹å‡»"å¯åŠ¨è¿æ¥"
3. ç­‰å¾…è¿æ¥æˆåŠŸåå†å‘é€æ¶ˆæ¯

## ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸè®¡åˆ’

1. **æ‰¹é‡æ“ä½œ**ï¼š
   - æ‰¹é‡å‘é€æ¶ˆæ¯
   - æ‰¹é‡ç¡®è®¤å‘è´§

2. **è‡ªåŠ¨åŒ–åŠŸèƒ½**ï¼š
   - è‡ªåŠ¨å›å¤æ¶ˆæ¯
   - è‡ªåŠ¨ç¡®è®¤å‘è´§

3. **æ¶ˆæ¯æ¨¡æ¿**ï¼š
   - é¢„è®¾æ¶ˆæ¯æ¨¡æ¿
   - å¿«æ·å›å¤

### é•¿æœŸè®¡åˆ’

1. **è®¢å•ç®¡ç†**ï¼š
   - è®¢å•åˆ—è¡¨æŸ¥è¯¢
   - è®¢å•è¯¦æƒ…æŸ¥çœ‹
   - è®¢å•çŠ¶æ€æ›´æ–°

2. **æ•°æ®ç»Ÿè®¡**ï¼š
   - æ¶ˆæ¯ç»Ÿè®¡
   - è®¢å•ç»Ÿè®¡
   - é”€å”®æŠ¥è¡¨

3. **æ™ºèƒ½åŠŸèƒ½**ï¼š
   - AIè‡ªåŠ¨å›å¤
   - æ™ºèƒ½æ¨è
   - é£é™©é¢„è­¦

## å‚è€ƒèµ„æ–™

### Pythonä»£ç å‚è€ƒ

- `XianyuAutoAsync.py` - WebSocketå’Œæ¶ˆæ¯å‘é€
- `secure_confirm_decrypted.py` - ç¡®è®¤å‘è´§
- `reply_server.py` - APIæœåŠ¡å™¨

### æ–‡æ¡£

- `æ¶ˆæ¯å‘é€åŠŸèƒ½è¯´æ˜.md`
- `ç¡®è®¤å‘è´§åŠŸèƒ½è¯´æ˜.md`
- `WebSocketåŠŸèƒ½è¯´æ˜å’Œé™åˆ¶.md`
- `èŠå¤©æ¶ˆæ¯è‡ªåŠ¨ä¿å­˜åŠŸèƒ½è¯´æ˜.md`

### å·¥å…·ç±»

- `XianyuSignUtils.java` - ç­¾åå·¥å…·
- `MessageDecryptUtils.java` - æ¶ˆæ¯è§£å¯†
- `XianyuApiUtils.java` - APIå·¥å…·

## ç‰ˆæœ¬å†å²

### v1.0.0 (2025-11-12)

- âœ… å®ç°WebSocketæ¶ˆæ¯å‘é€åŠŸèƒ½
- âœ… å®ç°ç¡®è®¤å‘è´§åŠŸèƒ½
- âœ… æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
- âœ… åˆ›å»ºæµ‹è¯•é¡µé¢å’Œæ–‡æ¡£
- âœ… æ›´æ–°ä¸»é¡µå¯¼èˆªèœå•

## è´¡çŒ®è€…

- å¼€å‘è€…ï¼šKiro AI Assistant
- å‚è€ƒä»£ç ï¼šPythonç‰ˆé—²é±¼åŠ©æ‰‹
