# 商品账号关联功能说明

## 功能概述

为 `xianyu_goods` 表添加 `xianyu_account_id` 字段，用于关联闲鱼账号，实现商品与账号的绑定关系。

## 数据库变更

### 新增字段

```sql
ALTER TABLE xianyu_goods ADD COLUMN xianyu_account_id BIGINT;
```

**字段说明：**
- 字段名：`xianyu_account_id`
- 字段类型：`BIGINT`
- 用途：关联闲鱼账号ID
- 外键：`FOREIGN KEY (xianyu_account_id) REFERENCES xianyu_account(id)`

### 新增索引

```sql
CREATE INDEX IF NOT EXISTS idx_goods_account_id ON xianyu_goods(xianyu_account_id);
```

**索引说明：**
- 索引名：`idx_goods_account_id`
- 用途：提升按账号查询商品的性能

## 自动迁移

系统启动时会自动检测并添加 `xianyu_account_id` 字段，无需手动操作。

**迁移逻辑位置：**
- `DatabaseInitListener.java` - 数据库初始化监听器
- 在 `checkAndAddColumns()` 方法中添加了字段检查和创建逻辑

## 功能实现

### 1. 刷新商品时自动填充

在调用 `/api/items/refresh` 接口刷新商品列表时，会自动填充 `xianyu_account_id` 字段。

**实现逻辑：**
```java
// 1. 从 cookieId 获取账号ID
Long accountId = getAccountIdFromCookieId(reqDTO.getCookieId());

// 2. 保存商品时传入账号ID
goodsInfoService.saveOrUpdateGoodsInfo(item, accountId);

// 3. 在保存方法中设置账号ID
goodsInfo.setXianyuAccountId(accountId);
```

### 2. cookieId 到账号ID的转换

支持三种方式获取账号ID：

**方式1：直接使用账号ID**
```java
// cookieId = "1"
Long accountId = Long.parseLong(cookieId);  // 返回 1
```

**方式2：通过账号备注查询**
```java
// cookieId = "账号_12345678"
Long accountId = accountService.getAccountIdByAccountNote(cookieId);
```

**方式3：通过UNB查询**
```java
// cookieId = "2200123456789"
Long accountId = accountService.getAccountIdByUnb(cookieId);
```

## 修改的文件

### 数据库文件

1. **schema.sql**
   - 添加 `xianyu_account_id` 字段定义
   - 添加外键约束
   - 添加索引定义

2. **migration_add_account_id.sql**
   - 手动迁移脚本（可选）

### 实体类

1. **XianyuGoodsInfo.java**
   - 添加 `xianyuAccountId` 属性

### 服务接口

1. **GoodsInfoService.java**
   - `saveOrUpdateGoodsInfo()` 方法添加 `xianyuAccountId` 参数
   - `batchSaveOrUpdateGoodsInfo()` 方法添加 `xianyuAccountId` 参数

2. **AccountService.java**
   - 添加 `getAccountIdByAccountNote()` 方法
   - 添加 `getAccountIdByUnb()` 方法

### 服务实现

1. **GoodsInfoServiceImpl.java**
   - 实现保存商品时设置 `xianyuAccountId`
   - 更新日志输出包含账号ID

2. **AccountServiceImpl.java**
   - 实现 `getAccountIdByAccountNote()` 方法
   - 实现 `getAccountIdByUnb()` 方法

3. **ItemServiceImpl.java**
   - 添加 `getAccountIdFromCookieId()` 方法
   - 在刷新商品时获取并传递账号ID

4. **DatabaseInitListener.java**
   - 添加 `xianyu_account_id` 字段的自动迁移逻辑
   - 添加索引的自动创建逻辑

## 使用示例

### 示例1：刷新商品（自动填充账号ID）

```bash
curl -X POST "http://localhost:8080/api/items/refresh" \
  -H "Content-Type: application/json" \
  -d '{"cookieId":"1","pageSize":20,"maxPages":1}'
```

**结果：**
- 获取商品列表
- 自动填充 `xianyu_account_id = 1`
- 保存到数据库

### 示例2：查询商品（包含账号ID）

```sql
SELECT 
    xy_good_id,
    title,
    xianyu_account_id,
    sold_price,
    status
FROM xianyu_goods
WHERE xianyu_account_id = 1;
```

### 示例3：按账号统计商品

```sql
SELECT 
    xianyu_account_id,
    COUNT(*) as total_count,
    SUM(CASE WHEN status = 0 THEN 1 ELSE 0 END) as on_sale_count,
    SUM(CASE WHEN status = 2 THEN 1 ELSE 0 END) as sold_count
FROM xianyu_goods
GROUP BY xianyu_account_id;
```

## 数据库表结构

### 完整表结构

```sql
CREATE TABLE xianyu_goods (
    id BIGINT PRIMARY KEY,                        -- 表ID（使用雪花ID）
    xy_good_id VARCHAR(100) NOT NULL,             -- 闲鱼商品ID
    xianyu_account_id BIGINT,                     -- 关联的闲鱼账号ID
    title VARCHAR(500),                           -- 商品标题
    cover_pic TEXT,                               -- 封面图片URL
    info_pic TEXT,                                -- 商品详情图片（JSON数组）
    detail_info TEXT,                             -- 商品详情信息
    detail_url TEXT,                              -- 商品详情页URL
    sold_price VARCHAR(50),                       -- 商品价格
    status TINYINT DEFAULT 0,                     -- 商品状态 0:在售 1:已下架 2:已售出
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,  -- 创建时间
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP,  -- 更新时间
    FOREIGN KEY (xianyu_account_id) REFERENCES xianyu_account(id)
);

-- 索引
CREATE UNIQUE INDEX idx_goods_xy_good_id ON xianyu_goods(xy_good_id);
CREATE INDEX idx_goods_status ON xianyu_goods(status);
CREATE INDEX idx_goods_account_id ON xianyu_goods(xianyu_account_id);
```

## 日志示例

### 成功日志

```
2024-11-12 16:00:00.123 [http-nio-8080-exec-1] INFO  ItemServiceImpl - 开始刷新商品数据: cookieId=1
2024-11-12 16:00:00.124 [http-nio-8080-exec-1] INFO  ItemServiceImpl - 从数据库查询Cookie: cookieId=1
2024-11-12 16:00:00.125 [http-nio-8080-exec-1] INFO  ItemServiceImpl - 通过账号ID获取Cookie成功: accountId=1
2024-11-12 16:00:01.234 [http-nio-8080-exec-1] INFO  GoodsInfoServiceImpl - 新增商品信息: xyGoodId=123456789, title=商品标题, id=987654321, accountId=1
2024-11-12 16:00:01.235 [http-nio-8080-exec-1] INFO  GoodsInfoServiceImpl - 批量保存商品信息完成: 总数=20, 成功=20, accountId=1
```

## 优势

1. **数据关联**：商品与账号建立明确的关联关系
2. **多账号支持**：支持多个闲鱼账号管理各自的商品
3. **查询优化**：通过索引提升按账号查询的性能
4. **数据隔离**：不同账号的商品数据相互独立
5. **统计分析**：可以按账号统计商品数量、销售情况等

## 注意事项

1. **自动迁移**：系统启动时会自动添加字段，无需手动操作
2. **数据兼容**：已有商品的 `xianyu_account_id` 会是 `NULL`，下次刷新时会自动填充
3. **外键约束**：删除账号前需要先处理关联的商品
4. **索引维护**：新增字段会自动创建索引，提升查询性能

## 未来扩展

1. **级联删除**：删除账号时自动删除关联商品
2. **账号切换**：支持将商品转移到其他账号
3. **权限控制**：基于账号ID实现商品访问权限控制
4. **数据统计**：按账号生成商品统计报表

## 更新时间

2024-11-12
