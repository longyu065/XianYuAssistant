# 滑块验证处理说明

## 功能概述

当获取WebSocket Token时遇到滑块验证，系统会自动将验证URL返回给前端，并在新窗口打开验证页面。

## 实现流程

### 1. 后端异常处理

#### CaptchaRequiredException 异常类
```java
// 位置: src/main/java/com/feijimiao/xianyuassistant/exception/CaptchaRequiredException.java
public class CaptchaRequiredException extends RuntimeException {
    private final String captchaUrl;
    
    public CaptchaRequiredException(String captchaUrl) {
        super("需要完成滑块验证");
        this.captchaUrl = captchaUrl;
    }
    
    public String getCaptchaUrl() {
        return captchaUrl;
    }
}
```

### 2. Token服务检测滑块验证

#### WebSocketTokenServiceImpl
```java
// 位置: src/main/java/com/feijimiao/xianyuassistant/service/impl/WebSocketTokenServiceImpl.java

// 检查是否需要滑块验证
if (retList.stream().anyMatch(ret -> ret.contains("FAIL_SYS_USER_VALIDATE"))) {
    // 提取滑块验证URL
    Map<String, Object> dataMap = (Map<String, Object>) responseMap.get("data");
    if (dataMap != null && dataMap.containsKey("url")) {
        String captchaUrl = (String) dataMap.get("url");
        log.warn("【账号{}】需要滑块验证，URL: {}", accountId, captchaUrl);
        // 抛出特殊异常，包含验证URL
        throw new CaptchaRequiredException(captchaUrl);
    }
}
```

### 3. WebSocket服务传递异常

#### WebSocketServiceImpl
```java
// 位置: src/main/java/com/feijimiao/xianyuassistant/service/impl/WebSocketServiceImpl.java

public boolean startWebSocket(Long accountId) {
    try {
        // ... 其他代码
        String accessToken = tokenService.getAccessToken(accountId, cookieStr, deviceId);
        // ... 其他代码
    } catch (com.feijimiao.xianyuassistant.exception.CaptchaRequiredException e) {
        log.warn("启动WebSocket需要滑块验证: accountId={}, url={}", accountId, e.getCaptchaUrl());
        throw e; // 重新抛出，让Controller处理
    }
}
```

### 4. Controller返回滑块信息

#### WebSocketController
```java
// 位置: src/main/java/com/feijimiao/xianyuassistant/controller/WebSocketController.java

@PostMapping("/start")
public ResultObject<CaptchaInfoDTO> startWebSocket(@RequestBody WebSocketReqDTO reqDTO) {
    try {
        // ... 启动WebSocket
    } catch (com.feijimiao.xianyuassistant.exception.CaptchaRequiredException e) {
        log.warn("需要滑块验证", e);
        CaptchaInfoDTO captchaInfo = new CaptchaInfoDTO();
        captchaInfo.setNeedCaptcha(true);
        captchaInfo.setCaptchaUrl(e.getCaptchaUrl());
        captchaInfo.setMessage("需要完成滑块验证，请在浏览器中打开验证链接");
        return ResultObject.failed(captchaInfo, "需要滑块验证");
    }
}

// 滑块验证信息DTO
@Data
public static class CaptchaInfoDTO {
    private Boolean needCaptcha;
    private String captchaUrl;
    private String message;
}
```

### 5. 前端处理滑块验证

#### websocket.html
```javascript
// 位置: src/main/resources/static/websocket.html

async function startWebSocket() {
    const response = await fetch(`${API_BASE}/start`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ xianyuAccountId: parseInt(accountId) })
    });

    const result = await response.json();

    if (result.code === 200) {
        showMessage('✅ WebSocket连接已启动');
        showStatus(true);
    } else {
        // 检查是否需要滑块验证
        if (result.data && result.data.needCaptcha) {
            const captchaUrl = result.data.captchaUrl;
            showMessage('⚠️ 需要滑块验证，正在打开验证页面...', true);
            
            // 在新窗口打开滑块验证页面
            window.open(captchaUrl, '_blank');
            
            // 显示提示信息
            setTimeout(() => {
                showMessage('请在新窗口完成滑块验证，然后刷新Cookie后重试', true);
            }, 1000);
        } else {
            showMessage('❌ ' + result.msg, true);
        }
        showStatus(false);
    }
}
```

## 使用流程

1. **用户操作**: 在前端页面点击"启动监听"按钮
2. **后端检测**: 系统尝试获取WebSocket Token
3. **触发验证**: 如果遇到滑块验证，抛出 `CaptchaRequiredException`
4. **返回前端**: Controller捕获异常，返回包含验证URL的响应
5. **打开验证**: 前端自动在新窗口打开验证URL
6. **完成验证**: 用户在新窗口完成滑块验证
7. **更新Cookie**: 验证完成后，用户需要更新Cookie（可通过扫码登录功能）
8. **重新尝试**: 用户再次点击"启动监听"，使用新Cookie连接

## 响应格式

### 成功响应
```json
{
    "code": 200,
    "msg": "WebSocket连接已启动",
    "data": null
}
```

### 滑块验证响应
```json
{
    "code": 500,
    "msg": "需要滑块验证",
    "data": {
        "needCaptcha": true,
        "captchaUrl": "https://h5api.m.goofish.com/h5/mtop.taobao.idlemessage.pc.login.token/1.0/?...",
        "message": "需要完成滑块验证，请在浏览器中打开验证链接"
    }
}
```

## 注意事项

1. **自动打开**: 前端会自动在新窗口打开验证URL，无需手动复制
2. **Cookie更新**: 完成验证后，需要更新Cookie才能继续使用
3. **Token缓存**: 系统会缓存Token 20小时，减少验证频率
4. **重试机制**: 验证完成后，直接重新点击"启动监听"即可

## 相关文件

- `src/main/java/com/feijimiao/xianyuassistant/exception/CaptchaRequiredException.java` - 滑块验证异常类
- `src/main/java/com/feijimiao/xianyuassistant/service/impl/WebSocketTokenServiceImpl.java` - Token服务（检测验证）
- `src/main/java/com/feijimiao/xianyuassistant/service/impl/WebSocketServiceImpl.java` - WebSocket服务（传递异常）
- `src/main/java/com/feijimiao/xianyuassistant/controller/WebSocketController.java` - 控制器（返回验证信息）
- `src/main/resources/static/websocket.html` - 前端页面（处理验证）

## 测试方法

1. 访问 http://localhost:8080/websocket.html
2. 输入账号ID（如：1）
3. 点击"启动监听"
4. 如果触发滑块验证，会自动打开新窗口
5. 在新窗口完成验证
6. 返回原页面，重新点击"启动监听"

## 优化建议

1. **自动重试**: 可以在验证完成后自动重试连接
2. **验证状态**: 可以添加验证状态检测，判断是否已完成验证
3. **Cookie同步**: 可以在验证完成后自动同步Cookie
