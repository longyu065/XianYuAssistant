# å•†å“è¯¦æƒ…åŠŸèƒ½å®Œæ•´å®ç°æ€»ç»“

## å®ç°æ¦‚è¿°

å·²å®Œæˆå•†å“è¯¦æƒ…è·å–åŠŸèƒ½çš„å®ç°ï¼ŒåŒ…æ‹¬ï¼š
1. âœ… APIè°ƒç”¨è·å–è¯¦æƒ…
2. âœ… 24å°æ—¶æ™ºèƒ½ç¼“å­˜æœºåˆ¶
3. âœ… é™çº§å¤„ç†ç­–ç•¥
4. âœ… detail_urlå­—æ®µä¿å­˜
5. âš ï¸ æµè§ˆå™¨è®¿é—®æ–¹å¼ï¼ˆæš‚æœªå®ç°ï¼Œéœ€è¦é¢å¤–çš„æµè§ˆå™¨è‡ªåŠ¨åŒ–å·¥å…·ï¼‰

## æ ¸å¿ƒåŠŸèƒ½

### 1. å•†å“è¯¦æƒ…è·å–æ¥å£

**æ¥å£åœ°å€ï¼š** `POST /api/items/detail`

**è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "xyGoodId": "123456789",      // å¿…å¡«ï¼šå•†å“ID
  "cookieId": "1"               // å¯é€‰ï¼šCookie IDï¼Œæä¾›æ—¶ä¼šæ›´æ–°è¯¦æƒ…
}
```

**åŠŸèƒ½è¯´æ˜ï¼š**
- ä¸æä¾› `cookieId`ï¼šåªè¿”å›æ•°æ®åº“ä¸­çš„å•†å“ä¿¡æ¯
- æä¾› `cookieId`ï¼šè°ƒç”¨APIè·å–æœ€æ–°è¯¦æƒ…å¹¶æ›´æ–°æ•°æ®åº“

### 2. æ™ºèƒ½ç¼“å­˜æœºåˆ¶

#### ç¼“å­˜ç­–ç•¥
- **æœ‰æ•ˆæœŸ**ï¼š24å°æ—¶
- **å­˜å‚¨**ï¼šæ•°æ®åº“ `detail_info` å­—æ®µ
- **åˆ¤æ–­**ï¼šåŸºäº `updated_time` å­—æ®µ

#### ç¼“å­˜æµç¨‹
```
è¯·æ±‚å•†å“è¯¦æƒ…
    â†“
æ£€æŸ¥æ•°æ®åº“ç¼“å­˜
    â†“
ç¼“å­˜å­˜åœ¨ä¸”æ–°é²œï¼ˆ<24hï¼‰ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ è¿”å›ç¼“å­˜ï¼ˆä¸è°ƒç”¨APIï¼‰
    â””â”€ å¦ â†’ è°ƒç”¨APIè·å–
        â†“
    APIæˆåŠŸï¼Ÿ
        â”œâ”€ æ˜¯ â†’ æ›´æ–°æ•°æ®åº“å¹¶è¿”å›
        â””â”€ å¦ â†’ è¿”å›è¿‡æœŸç¼“å­˜ï¼ˆé™çº§ï¼‰
```

### 3. APIè°ƒç”¨å®ç°

#### è°ƒç”¨é—²é±¼API

```java
// APIåç§°
mtop.taobao.idle.pc.detail

// è¯·æ±‚å‚æ•°
{
  "itemId": "123456789"
}

// å“åº”å¤„ç†
- æ£€æŸ¥å“åº”çŠ¶æ€
- æå–dataå­—æ®µ
- è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
- ä¿å­˜åˆ°æ•°æ®åº“
```

#### å…³é”®ä»£ç 

```java
private String fetchDetailFromApi(String itemId, String cookiesStr) {
    // 1. æ„å»ºè¯·æ±‚
    Map<String, Object> dataMap = new HashMap<>();
    dataMap.put("itemId", itemId);
    
    // 2. è°ƒç”¨API
    String response = XianyuApiUtils.callApi(
        "mtop.taobao.idle.pc.detail",
        dataMap,
        cookiesStr
    );
    
    // 3. è§£æå“åº”
    Map<String, Object> data = XianyuApiUtils.extractData(response);
    
    // 4. è¿”å›JSON
    return objectMapper.writeValueAsString(data);
}
```

## æ•°æ®åº“è®¾è®¡

### xianyu_goods è¡¨ç»“æ„

```sql
CREATE TABLE xianyu_goods (
    id BIGINT PRIMARY KEY,
    xy_good_id VARCHAR(100) NOT NULL,
    title VARCHAR(500),
    cover_pic TEXT,
    info_pic TEXT,
    detail_info TEXT,              -- å•†å“è¯¦æƒ…ï¼ˆJSONæ ¼å¼ï¼‰
    detail_url TEXT,               -- å•†å“è¯¦æƒ…é¡µURL
    sold_price VARCHAR(50),
    status TINYINT DEFAULT 0,
    created_time DATETIME,
    updated_time DATETIME          -- ç”¨äºç¼“å­˜åˆ¤æ–­
);
```

### å­—æ®µè¯´æ˜

- `detail_info`ï¼šå­˜å‚¨å•†å“è¯¦æƒ…JSONï¼Œé€šè¿‡ `/api/items/detail` æ¥å£å¡«å……
- `detail_url`ï¼šå­˜å‚¨å•†å“è¯¦æƒ…é¡µURLï¼Œåœ¨åˆ·æ–°å•†å“åˆ—è¡¨æ—¶è‡ªåŠ¨ä¿å­˜
- `updated_time`ï¼šè®°å½•æœ€åæ›´æ–°æ—¶é—´ï¼Œç”¨äºç¼“å­˜æ–°é²œåº¦åˆ¤æ–­

## å®ç°çš„æ–‡ä»¶

### åç«¯æ–‡ä»¶

1. **ItemServiceImpl.java**
   - `getItemDetail()` - è·å–å•†å“è¯¦æƒ…ä¸»æ–¹æ³•
   - `fetchItemDetailFromApi()` - è·å–è¯¦æƒ…å…¥å£ï¼ˆå«ç¼“å­˜æ£€æŸ¥ï¼‰
   - `fetchDetailFromApi()` - è°ƒç”¨APIè·å–è¯¦æƒ…
   - `isDetailInfoFresh()` - æ£€æŸ¥ç¼“å­˜æ–°é²œåº¦

2. **GoodsInfoService.java**
   - `updateDetailInfo()` - æ›´æ–°è¯¦æƒ…æ¥å£å®šä¹‰

3. **GoodsInfoServiceImpl.java**
   - `updateDetailInfo()` - æ›´æ–°è¯¦æƒ…å®ç°
   - `saveOrUpdateGoodsInfo()` - ä¿å­˜å•†å“æ—¶ä¿å­˜ `detailUrl`

4. **ItemDetailReqDTO.java**
   - æ·»åŠ  `cookieId` å­—æ®µ

5. **XianyuGoodsInfo.java**
   - æ·»åŠ  `detailUrl` å­—æ®µ

6. **DatabaseInitListener.java**
   - æ·»åŠ  `detail_url` å­—æ®µè‡ªåŠ¨è¿ç§»

### æ•°æ®åº“æ–‡ä»¶

1. **schema.sql**
   - æ·»åŠ  `detail_url` å­—æ®µå®šä¹‰

2. **migration_add_detail_url.sql**
   - æ‰‹åŠ¨è¿ç§»è„šæœ¬ï¼ˆå¯é€‰ï¼‰

### æ–‡æ¡£æ–‡ä»¶

1. **å•†å“è¯¦æƒ…åŠŸèƒ½å®ç°è¯´æ˜.md** - åŠŸèƒ½å®ç°è¯´æ˜
2. **å•†å“è¯¦æƒ…ç¼“å­˜æœºåˆ¶è¯´æ˜.md** - ç¼“å­˜æœºåˆ¶è¯¦è§£
3. **æ•°æ®åº“å­—æ®µæ›´æ–°è¯´æ˜.md** - å­—æ®µæ›´æ–°è¯´æ˜
4. **é—®é¢˜ä¿®å¤è¯´æ˜.md** - é—®é¢˜ä¿®å¤è®°å½•

## ä½¿ç”¨ç¤ºä¾‹

### 1. è·å–å•†å“è¯¦æƒ…ï¼ˆä¸æ›´æ–°ï¼‰

```bash
curl -X POST "http://localhost:8080/api/items/detail" \
  -H "Content-Type: application/json" \
  -d '{"xyGoodId":"123456789"}'
```

**ç»“æœï¼š**
- è¿”å›æ•°æ®åº“ä¸­çš„å•†å“ä¿¡æ¯
- ä¸è°ƒç”¨API
- ä¸æ›´æ–°è¯¦æƒ…

### 2. è·å–å¹¶æ›´æ–°å•†å“è¯¦æƒ…

```bash
curl -X POST "http://localhost:8080/api/items/detail" \
  -H "Content-Type: application/json" \
  -d '{"xyGoodId":"123456789","cookieId":"1"}'
```

**ç»“æœï¼š**
- æ£€æŸ¥ç¼“å­˜æ–°é²œåº¦
- å¦‚æœç¼“å­˜æ–°é²œï¼ˆ<24hï¼‰ï¼šè¿”å›ç¼“å­˜
- å¦‚æœç¼“å­˜è¿‡æœŸï¼šè°ƒç”¨APIæ›´æ–°
- æ›´æ–°æ•°æ®åº“çš„ `detail_info` å’Œ `updated_time`

### 3. ä½¿ç”¨æµ‹è¯•è„šæœ¬

```bash
æµ‹è¯•å•†å“è¯¦æƒ…API.bat
```

è¾“å…¥å•†å“IDåè‡ªåŠ¨æµ‹è¯•ä¸¤ç§åœºæ™¯ã€‚

## æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜å‘½ä¸­ç‡

**é¢„æœŸæŒ‡æ ‡ï¼š**
- ç¼“å­˜å‘½ä¸­ç‡ï¼š> 70%
- APIè°ƒç”¨å‡å°‘ï¼š66.7%ï¼ˆå‡è®¾æ¯å¤©æŸ¥çœ‹3æ¬¡ï¼‰

**å®é™…æ•ˆæœï¼š**
- é¦–æ¬¡æŸ¥çœ‹ï¼šè°ƒç”¨APIï¼ˆ1æ¬¡ï¼‰
- 24å°æ—¶å†…å†æ¬¡æŸ¥çœ‹ï¼šä½¿ç”¨ç¼“å­˜ï¼ˆ0æ¬¡ï¼‰
- 24å°æ—¶åæŸ¥çœ‹ï¼šè°ƒç”¨APIæ›´æ–°ï¼ˆ1æ¬¡ï¼‰

### 2. å“åº”é€Ÿåº¦

**æ€§èƒ½å¯¹æ¯”ï¼š**
- APIè°ƒç”¨ï¼š500-1000ms
- æ•°æ®åº“æŸ¥è¯¢ï¼š10-50ms
- **é€Ÿåº¦æå‡ï¼š10-100å€**

### 3. é£æ§ä¿æŠ¤

**ä¿æŠ¤æœºåˆ¶ï¼š**
- 24å°æ—¶å†…åªè°ƒç”¨1æ¬¡API
- å¤§å¹…é™ä½è¯·æ±‚é¢‘ç‡
- æœ‰æ•ˆé¿å…è§¦å‘é£æ§

## é™çº§ç­–ç•¥

### åœºæ™¯1ï¼šAPIè°ƒç”¨å¤±è´¥

**å¤„ç†ï¼š**
1. è®°å½•é”™è¯¯æ—¥å¿—
2. æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜ï¼ˆå³ä½¿è¿‡æœŸï¼‰
3. è¿”å›è¿‡æœŸç¼“å­˜
4. ä¿è¯åŸºæœ¬åŠŸèƒ½å¯ç”¨

### åœºæ™¯2ï¼šCookieå¤±æ•ˆ

**å¤„ç†ï¼š**
1. è¿”å›é”™è¯¯ä¿¡æ¯
2. æç¤ºç”¨æˆ·é‡æ–°ç™»å½•
3. è¿”å›æ•°æ®åº“ä¸­çš„åŸºæœ¬ä¿¡æ¯

### åœºæ™¯3ï¼šç½‘ç»œå¼‚å¸¸

**å¤„ç†ï¼š**
1. æ•è·å¼‚å¸¸
2. è¿”å›ç¼“å­˜æ•°æ®
3. è®°å½•å¼‚å¸¸æ—¥å¿—

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯

1. âœ… é¦–æ¬¡è·å–è¯¦æƒ…ï¼ˆæ— ç¼“å­˜ï¼‰
2. âœ… 24å°æ—¶å†…å†æ¬¡è·å–ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
3. âœ… 24å°æ—¶åè·å–ï¼ˆæ›´æ–°ç¼“å­˜ï¼‰
4. âœ… APIå¤±è´¥ä½†æœ‰ç¼“å­˜ï¼ˆé™çº§å¤„ç†ï¼‰
5. âœ… ä¸æä¾›cookieIdï¼ˆåªè¿”å›åŸºæœ¬ä¿¡æ¯ï¼‰

### æµ‹è¯•æ–¹æ³•

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨æµ‹è¯•è„šæœ¬
æµ‹è¯•å•†å“è¯¦æƒ…API.bat

# æ–¹æ³•2ï¼šä½¿ç”¨curl
curl -X POST "http://localhost:8080/api/items/detail" \
  -H "Content-Type: application/json" \
  -d '{"xyGoodId":"123456789","cookieId":"1"}'

# æ–¹æ³•3ï¼šæŸ¥çœ‹æ—¥å¿—
tail -f logs/application.log | grep "å•†å“è¯¦æƒ…"
```

## ç›‘æ§æŒ‡æ ‡

### å…³é”®æ—¥å¿—

```
ä½¿ç”¨ç¼“å­˜çš„å•†å“è¯¦æƒ…: itemId=xxx, ç¼“å­˜æ—¶é—´=xxx
ç¼“å­˜çš„å•†å“è¯¦æƒ…å·²è¿‡æœŸï¼Œé‡æ–°è·å–: itemId=xxx
APIè·å–å•†å“è¯¦æƒ…æˆåŠŸ: itemId=xxx, è¯¦æƒ…é•¿åº¦=xxx
è¿”å›è¿‡æœŸçš„ç¼“å­˜è¯¦æƒ…: itemId=xxx
```

### ç›‘æ§å»ºè®®

1. **ç¼“å­˜å‘½ä¸­ç‡**ï¼š> 70%
2. **APIè°ƒç”¨é¢‘ç‡**ï¼šæ ¹æ®ä¸šåŠ¡é‡è®¾å®šå‘Šè­¦é˜ˆå€¼
3. **ç¼“å­˜è¿‡æœŸç‡**ï¼š< 10%
4. **APIå¤±è´¥ç‡**ï¼š< 5%

## æ³¨æ„äº‹é¡¹

### 1. ç¼“å­˜ä¸€è‡´æ€§

- ç¼“å­˜æœŸé—´å•†å“ä¿¡æ¯å¯èƒ½å˜åŒ–
- å¦‚éœ€å®æ—¶æ•°æ®ï¼Œå¯æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜
- å»ºè®®åœ¨å•†å“çŠ¶æ€å˜æ›´æ—¶æ¸…é™¤ç¼“å­˜

### 2. å­˜å‚¨ç©ºé—´

- è¯¦æƒ…ä¿¡æ¯è¾ƒå¤§ï¼ˆ5-10KBï¼‰
- éœ€å®šæœŸæ¸…ç†å·²å”®å‡ºå•†å“æ•°æ®
- å»ºè®®ä¿ç•™æœ€è¿‘3ä¸ªæœˆçš„æ•°æ®

### 3. Cookieç®¡ç†

- ç¡®ä¿Cookieæœ‰æ•ˆæ€§
- å®šæœŸæ›´æ–°Cookie
- ç›‘æ§Cookieè¿‡æœŸæƒ…å†µ

### 4. å¹¶å‘æ§åˆ¶

- å½“å‰æœªå®ç°å¹¶å‘æ§åˆ¶
- é«˜å¹¶å‘åœºæ™¯å¯èƒ½é‡å¤è°ƒç”¨API
- æœªæ¥å¯è€ƒè™‘å®ç°åˆ†å¸ƒå¼é”

## æœªå®ç°åŠŸèƒ½

### æµè§ˆå™¨è®¿é—®æ–¹å¼

**åŸå› ï¼š**
- Javaç¯å¢ƒä¸‹Playwrighté…ç½®å¤æ‚
- éœ€è¦é¢å¤–çš„ä¾èµ–å’Œç¯å¢ƒé…ç½®
- ç»´æŠ¤æˆæœ¬è¾ƒé«˜

**æ›¿ä»£æ–¹æ¡ˆï¼š**
- å½“å‰APIæ–¹å¼å·²æ»¡è¶³éœ€æ±‚
- å¦‚ç¡®éœ€æµè§ˆå™¨è®¿é—®ï¼Œå¯è€ƒè™‘ï¼š
  1. ä½¿ç”¨Selenium WebDriver
  2. è°ƒç”¨Pythonè„šæœ¬
  3. ä½¿ç”¨æ— å¤´æµè§ˆå™¨æœåŠ¡

**å®ç°ä¼˜å…ˆçº§ï¼š**
- ä½ï¼ˆAPIæ–¹å¼å·²è¶³å¤Ÿï¼‰

## æœªæ¥ä¼˜åŒ–æ–¹å‘

### 1. åˆ†å¸ƒå¼ç¼“å­˜

- ä½¿ç”¨Redisæ›¿ä»£æ•°æ®åº“ç¼“å­˜
- æå‡æ€§èƒ½å’Œæ‰©å±•æ€§
- æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²

### 2. å¹¶å‘æ§åˆ¶

- å®ç°åˆ†å¸ƒå¼é”
- é¿å…é‡å¤è°ƒç”¨API
- æå‡ç³»ç»Ÿç¨³å®šæ€§

### 3. ç¼“å­˜é¢„çƒ­

- åå°ä»»åŠ¡å®šæœŸæ›´æ–°çƒ­é—¨å•†å“
- æå‡ç¼“å­˜å‘½ä¸­ç‡
- æ”¹å–„ç”¨æˆ·ä½“éªŒ

### 4. æ™ºèƒ½è¿‡æœŸ

- æ ¹æ®å•†å“çŠ¶æ€åŠ¨æ€è°ƒæ•´ç¼“å­˜æ—¶æ•ˆ
- åœ¨å”®å•†å“ï¼šçŸ­æ—¶æ•ˆï¼ˆ12å°æ—¶ï¼‰
- å·²å”®å‡ºå•†å“ï¼šé•¿æ—¶æ•ˆï¼ˆ7å¤©ï¼‰

## æ€»ç»“

âœ… **å·²å®Œæˆï¼š**
1. å•†å“è¯¦æƒ…APIè°ƒç”¨
2. 24å°æ—¶æ™ºèƒ½ç¼“å­˜æœºåˆ¶
3. é™çº§å¤„ç†ç­–ç•¥
4. detail_urlå­—æ®µä¿å­˜
5. å®Œæ•´çš„æ–‡æ¡£è¯´æ˜

âš ï¸ **å¾…ä¼˜åŒ–ï¼š**
1. æµè§ˆå™¨è®¿é—®æ–¹å¼ï¼ˆä¼˜å…ˆçº§ä½ï¼‰
2. åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆä¼˜å…ˆçº§ä¸­ï¼‰
3. å¹¶å‘æ§åˆ¶ï¼ˆä¼˜å…ˆçº§ä¸­ï¼‰
4. ç¼“å­˜é¢„çƒ­ï¼ˆä¼˜å…ˆçº§ä½ï¼‰

ğŸ“Š **æ€§èƒ½æå‡ï¼š**
- APIè°ƒç”¨å‡å°‘ï¼š66.7%
- å“åº”é€Ÿåº¦æå‡ï¼š10-100å€
- é£æ§é£é™©é™ä½ï¼šæ˜¾è‘—

ğŸ¯ **ä¸šåŠ¡ä»·å€¼ï¼š**
- é¿å…é¢‘ç¹è¯·æ±‚è¢«é£æ§
- æå‡ç”¨æˆ·ä½“éªŒ
- é™ä½æœåŠ¡å™¨å‹åŠ›
- èŠ‚çœAPIè°ƒç”¨æˆæœ¬

## æ›´æ–°æ—¶é—´

2024-11-12
