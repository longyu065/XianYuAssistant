# é—²é±¼å•†å“åŠŸèƒ½å®ç°è¯´æ˜

## ğŸ“‹ å®ç°å†…å®¹

åŸºäº `src/main/resources/pythondemo/xianyu-auto-reply-main/XianyuAutoAsync.py` ä¸­çš„ä»£ç ï¼Œå®ç°äº†å®Œæ•´çš„é—²é±¼è´¦å·å•†å“è·å–åŠŸèƒ½ã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. è·å–æŒ‡å®šé¡µå•†å“ä¿¡æ¯
- **å‡½æ•°**: `get_item_list_info(page_number, page_size)`
- **åŠŸèƒ½**: è°ƒç”¨é—²é±¼APIè·å–æŒ‡å®šé¡µçš„å•†å“åˆ—è¡¨
- **ç‰¹æ€§**:
  - è‡ªåŠ¨å¤„ç†tokenå¤±æ•ˆå¹¶é‡è¯•
  - è§£æå•†å“è¯¦ç»†ä¿¡æ¯ï¼ˆæ ‡é¢˜ã€ä»·æ ¼ã€åˆ†ç±»ã€å›¾ç‰‡ç­‰ï¼‰
  - è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“
  - æ”¯æŒè‡ªå®šä¹‰é¡µç å’Œæ¯é¡µæ•°é‡

### 2. è·å–æ‰€æœ‰å•†å“ä¿¡æ¯
- **å‡½æ•°**: `get_all_items(page_size, max_pages)`
- **åŠŸèƒ½**: è‡ªåŠ¨åˆ†é¡µè·å–æ‰€æœ‰å•†å“
- **ç‰¹æ€§**:
  - å¾ªç¯è°ƒç”¨è·å–æ¯ä¸€é¡µ
  - è‡ªåŠ¨æ£€æµ‹æœ€åä¸€é¡µ
  - æ”¯æŒæœ€å¤§é¡µæ•°é™åˆ¶
  - æ‰¹é‡ä¿å­˜åˆ°æ•°æ®åº“
  - æ·»åŠ è¯·æ±‚å»¶è¿Ÿé¿å…é¢‘ç¹è¯·æ±‚

### 3. æ•°æ®åº“æŸ¥è¯¢
- **å‡½æ•°**: `get_items_from_db(cookie_id)`
- **åŠŸèƒ½**: ä»æ•°æ®åº“è·å–å·²ä¿å­˜çš„å•†å“ä¿¡æ¯
- **ç‰¹æ€§**:
  - å¿«é€ŸæŸ¥è¯¢æœ¬åœ°æ•°æ®
  - æ— éœ€è°ƒç”¨API
  - æ”¯æŒæŒ‰è´¦å·ç­›é€‰

## ğŸ“ æ–‡ä»¶ç»“æ„

```
é¡¹ç›®æ ¹ç›®å½•/
â”œâ”€â”€ src/main/java/com/feijimiao/xianyuassistant/
â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â””â”€â”€ ItemController.java          # å•†å“APIæ§åˆ¶å™¨
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”œâ”€â”€ ItemService.java             # å•†å“æœåŠ¡æ¥å£
â”‚   â”‚   â””â”€â”€ impl/
â”‚   â”‚       â””â”€â”€ ItemServiceImpl.java     # å•†å“æœåŠ¡å®ç°
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ PythonScriptExecutor.java    # Pythonè„šæœ¬æ‰§è¡Œå™¨
â”‚
â”œâ”€â”€ src/main/resources/
â”‚   â”œâ”€â”€ pythondemo/xianyu-auto-reply-main/
â”‚   â”‚   â”œâ”€â”€ XianyuAutoAsync.py           # æ ¸å¿ƒåŠŸèƒ½å®ç°ï¼ˆå·²å­˜åœ¨ï¼‰
â”‚   â”‚   â””â”€â”€ item_api.py                  # å•†å“APIè„šæœ¬ï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ static/
â”‚       â””â”€â”€ items.html                   # Webæµ‹è¯•ç•Œé¢ï¼ˆæ–°å¢ï¼‰
â”‚
â”œâ”€â”€ å•†å“APIä½¿ç”¨è¯´æ˜.md                    # APIä½¿ç”¨æ–‡æ¡£
â”œâ”€â”€ å•†å“åŠŸèƒ½å®ç°è¯´æ˜.md                   # æœ¬æ–‡æ¡£
â””â”€â”€ æµ‹è¯•å•†å“API.bat                       # å¿«é€Ÿæµ‹è¯•è„šæœ¬
```

## ğŸ”§ æŠ€æœ¯å®ç°

### åç«¯æ¶æ„

```
HTTPè¯·æ±‚
    â†“
ItemController (Java)
    â†“
ItemService (Java)
    â†“
XianyuSignUtils (Javaç­¾åå·¥å…·)
    â†“
HttpClientUtils (Java HTTPå®¢æˆ·ç«¯)
    â†“
é—²é±¼API
    â†“
æ•°æ®åº“ (SQLite)
```

### å…³é”®æŠ€æœ¯ç‚¹

1. **çº¯Javaå®ç°**
   - ä½¿ç”¨RestTemplateè°ƒç”¨é—²é±¼API
   - MD5ç­¾åç®—æ³•å®ç°
   - Cookieè§£æå’ŒTokenæå–

2. **è‡ªåŠ¨åˆ†é¡µ**
   - å¾ªç¯è°ƒç”¨APIè·å–æ¯ä¸€é¡µ
   - è‡ªåŠ¨æ£€æµ‹æœ€åä¸€é¡µ
   - æ”¯æŒæœ€å¤§é¡µæ•°é™åˆ¶

3. **æ•°æ®æŒä¹…åŒ–**
   - æ‰¹é‡ä¿å­˜å•†å“ä¿¡æ¯
   - å¹¶å‘å®‰å…¨è®¾è®¡
   - è‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³

4. **é”™è¯¯å¤„ç†**
   - Tokenå¤±æ•ˆè‡ªåŠ¨é‡è¯•
   - ç½‘ç»œå¼‚å¸¸å¤„ç†
   - è¯¦ç»†çš„æ—¥å¿—è®°å½•

## ğŸ“Š æ•°æ®æµç¨‹

### è·å–å•†å“æµç¨‹

```
1. ç”¨æˆ·å‘èµ·è¯·æ±‚
   â†“
2. Java Controlleræ¥æ”¶è¯·æ±‚
   â†“
3. Serviceä»æ•°æ®åº“è·å–Cookie
   â†“
4. è§£æCookieæå–Token
   â†“
5. ç”Ÿæˆæ—¶é—´æˆ³å’Œç­¾å
   â†“
6. æ„å»ºè¯·æ±‚å‚æ•°
   â†“
7. è°ƒç”¨é—²é±¼API
   â†“
8. è§£æå“åº”æ•°æ®
   â†“
9. ä¿å­˜åˆ°æ•°æ®åº“
   â†“
10. è¿”å›JSONç»“æœç»™å‰ç«¯
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1ï¼šWebç•Œé¢
1. å¯åŠ¨åº”ç”¨
2. è®¿é—® `http://localhost:8080/items.html`
3. è¾“å…¥è´¦å·ID
4. ç‚¹å‡»ç›¸åº”æŒ‰é’®è·å–å•†å“

### æ–¹æ³•2ï¼šAPIè°ƒç”¨
```bash
# è·å–ç¬¬1é¡µå•†å“
curl "http://localhost:8080/api/items/list?cookieId=default&pageNumber=1&pageSize=20"

# è·å–æ‰€æœ‰å•†å“
curl "http://localhost:8080/api/items/all?cookieId=default&pageSize=20"

# ä»æ•°æ®åº“è·å–
curl "http://localhost:8080/api/items/db/default"
```

### æ–¹æ³•3ï¼šæµ‹è¯•è„šæœ¬
è¿è¡Œ `æµ‹è¯•å•†å“API.bat` é€‰æ‹©æµ‹è¯•é€‰é¡¹

## ğŸ“ APIæ¥å£

### 1. GET /api/items/list
è·å–æŒ‡å®šé¡µå•†å“åˆ—è¡¨

**å‚æ•°**:
- cookieId: è´¦å·IDï¼ˆå¿…å¡«ï¼‰
- pageNumber: é¡µç ï¼Œé»˜è®¤1
- pageSize: æ¯é¡µæ•°é‡ï¼Œé»˜è®¤20

### 2. GET /api/items/all
è·å–æ‰€æœ‰å•†å“ï¼ˆè‡ªåŠ¨åˆ†é¡µï¼‰

**å‚æ•°**:
- cookieId: è´¦å·IDï¼ˆå¿…å¡«ï¼‰
- pageSize: æ¯é¡µæ•°é‡ï¼Œé»˜è®¤20
- maxPages: æœ€å¤§é¡µæ•°é™åˆ¶ï¼ˆå¯é€‰ï¼‰

### 3. GET /api/items/db/{cookieId}
ä»æ•°æ®åº“è·å–å•†å“

**å‚æ•°**:
- cookieId: è´¦å·IDï¼ˆè·¯å¾„å‚æ•°ï¼‰

## ğŸ¨ Webç•Œé¢ç‰¹æ€§

- å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯
- æ¸å˜è‰²ä¸»é¢˜ï¼Œç¾è§‚å¤§æ–¹
- å®æ—¶åŠ è½½çŠ¶æ€æ˜¾ç¤º
- å•†å“å¡ç‰‡ç½‘æ ¼å¸ƒå±€
- å›¾ç‰‡æ‡’åŠ è½½å’Œé”™è¯¯å¤„ç†
- ç»Ÿè®¡æ•°æ®å±•ç¤º

## âš™ï¸ é…ç½®è¯´æ˜

åœ¨ `global_config.yml` ä¸­é…ç½®ï¼š

```yaml
ITEM_DETAIL:
  auto_fetch:
    enabled: true          # æ˜¯å¦è‡ªåŠ¨è·å–å•†å“è¯¦æƒ…
    max_concurrent: 3      # æœ€å¤§å¹¶å‘æ•°
    retry_delay: 0.5       # é‡è¯•å»¶è¿Ÿï¼ˆç§’ï¼‰
```

## ğŸ” æ ¸å¿ƒä»£ç è§£æ

### Javaç«¯ - è·å–å•†å“åˆ—è¡¨

```java
public ResultObject<ItemListRespDTO> getItemList(ItemListReqDTO reqDTO) {
    // 1. ä»æ•°æ®åº“è·å–Cookie
    String cookiesStr = getCookieFromDb(reqDTO.getCookieId());
    
    // 2. è§£æCookieæå–Token
    Map<String, String> cookies = XianyuSignUtils.parseCookies(cookiesStr);
    String token = XianyuSignUtils.extractToken(cookies);
    
    // 3. ç”Ÿæˆæ—¶é—´æˆ³å’Œç­¾å
    String timestamp = String.valueOf(System.currentTimeMillis());
    String sign = XianyuSignUtils.generateSign(timestamp, token, dataJson);
    
    // 4. æ„å»ºè¯·æ±‚URLå’Œå‚æ•°
    String url = buildApiUrl(timestamp, sign);
    
    // 5. å‘é€HTTPè¯·æ±‚
    String response = HttpClientUtils.post(url, headers, body);
    
    // 6. è§£æå“åº”
    ItemListRespDTO respDTO = parseItemListResponse(responseMap);
    
    return ResultObject.success(respDTO);
}
```

### Javaç«¯ - è·å–æ‰€æœ‰å•†å“ï¼ˆè‡ªåŠ¨åˆ†é¡µï¼‰

```java
public ResultObject<AllItemsRespDTO> getAllItems(AllItemsReqDTO reqDTO) {
    AllItemsRespDTO respDTO = new AllItemsRespDTO();
    int pageNumber = 1;
    
    while (true) {
        // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æœ€å¤§é¡µæ•°
        if (reqDTO.getMaxPages() != null && pageNumber > reqDTO.getMaxPages()) {
            break;
        }
        
        // è·å–å½“å‰é¡µ
        ResultObject<ItemListRespDTO> pageResult = getItemList(pageReqDTO);
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
        if (pageData.getItems() == null || pageData.getItems().isEmpty()) {
            break;
        }
        
        respDTO.getItems().addAll(pageData.getItems());
        pageNumber++;
        
        // æ·»åŠ å»¶è¿Ÿ
        Thread.sleep(1000);
    }
    
    return ResultObject.success(respDTO);
}
```

### Javaç«¯ - ç­¾åç”Ÿæˆ

```java
public static String generateSign(String timestamp, String token, String data) {
    // æ‹¼æ¥ç­¾åå­—ç¬¦ä¸²
    String msg = token + "&" + timestamp + "&" + APP_KEY + "&" + data;
    
    // MD5åŠ å¯†
    MessageDigest md = MessageDigest.getInstance("MD5");
    byte[] messageDigest = md.digest(msg.getBytes(StandardCharsets.UTF_8));
    
    // è½¬æ¢ä¸º16è¿›åˆ¶å­—ç¬¦ä¸²
    StringBuilder hexString = new StringBuilder();
    for (byte b : messageDigest) {
        String hex = Integer.toHexString(0xff & b);
        if (hex.length() == 1) hexString.append('0');
        hexString.append(hex);
    }
    
    return hexString.toString();
}
```

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

1. **Tokenå¤±æ•ˆ**
   - è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰
   - éœ€è¦æ—¶æ›´æ–°Cookie

2. **ç½‘ç»œè¶…æ—¶**
   - è®¾ç½®5åˆ†é’Ÿè¶…æ—¶
   - å¯è°ƒæ•´è¶…æ—¶æ—¶é—´

3. **Cookieæ— æ•ˆ**
   - æ£€æŸ¥æ•°æ®åº“ä¸­çš„Cookie
   - é‡æ–°ç™»å½•è·å–æ–°Cookie

4. **Pythonç¯å¢ƒé—®é¢˜**
   - ç¡®ä¿å®‰è£…äº†æ‰€éœ€ä¾èµ–
   - æ£€æŸ¥Pythonè·¯å¾„é…ç½®

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **æ‰¹é‡ä¿å­˜**
   - ä½¿ç”¨æ‰¹é‡æ’å…¥å‡å°‘æ•°æ®åº“æ“ä½œ
   - äº‹åŠ¡å¤„ç†ä¿è¯æ•°æ®ä¸€è‡´æ€§

2. **å¹¶å‘æ§åˆ¶**
   - ä¿¡å·é‡é™åˆ¶å¹¶å‘æ•°
   - é¿å…å¯¹APIæœåŠ¡å™¨é€ æˆå‹åŠ›

3. **ç¼“å­˜æœºåˆ¶**
   - å•†å“è¯¦æƒ…ç¼“å­˜24å°æ—¶
   - å‡å°‘é‡å¤è¯·æ±‚

4. **è¯·æ±‚å»¶è¿Ÿ**
   - è‡ªåŠ¨æ·»åŠ 1ç§’å»¶è¿Ÿ
   - é¿å…è§¦å‘é™æµ

## ğŸ” å®‰å…¨è€ƒè™‘

1. **Cookieä¿æŠ¤**
   - å­˜å‚¨åœ¨æ•°æ®åº“ä¸­
   - ä¸åœ¨æ—¥å¿—ä¸­è¾“å‡ºå®Œæ•´Cookie

2. **å‚æ•°éªŒè¯**
   - æ£€æŸ¥å¿…å¡«å‚æ•°
   - é™åˆ¶é¡µç å’Œæ•°é‡èŒƒå›´

3. **é”™è¯¯ä¿¡æ¯**
   - ä¸æš´éœ²æ•æ„Ÿä¿¡æ¯
   - è®°å½•è¯¦ç»†æ—¥å¿—ç”¨äºè°ƒè¯•

## ğŸ“š ä¾èµ–è¯´æ˜

### Javaä¾èµ–
- Spring Boot
- Spring Web (RestTemplate)
- Jackson (JSONå¤„ç†)
- Lombok (ç®€åŒ–ä»£ç )
- SLF4J (æ—¥å¿—)

## ğŸ“ å­¦ä¹ è¦ç‚¹

1. **HTTPå®¢æˆ·ç«¯**
   - RestTemplateä½¿ç”¨
   - è¯·æ±‚å¤´å’ŒCookieå¤„ç†
   - å“åº”è§£æ

2. **åŠ å¯†ç®—æ³•**
   - MD5ç­¾åç”Ÿæˆ
   - æ—¶é—´æˆ³å¤„ç†
   - Tokenæå–

3. **APIè®¾è®¡**
   - RESTfulè§„èŒƒ
   - DTOå°è£…
   - å“åº”æ ¼å¼

4. **å‰åç«¯åˆ†ç¦»**
   - POSTè¯·æ±‚
   - JSONæ•°æ®äº¤æ¢
   - é”™è¯¯å¤„ç†

## ğŸš§ åç»­ä¼˜åŒ–æ–¹å‘

1. **åŠŸèƒ½å¢å¼º**
   - å•†å“æœç´¢å’Œç­›é€‰
   - å•†å“è¯¦æƒ…æŸ¥çœ‹
   - æ‰¹é‡æ“ä½œ

2. **æ€§èƒ½ä¼˜åŒ–**
   - åˆ†å¸ƒå¼ç¼“å­˜
   - å¼‚æ­¥é˜Ÿåˆ—
   - æ•°æ®åº“ç´¢å¼•

3. **ç”¨æˆ·ä½“éªŒ**
   - å®æ—¶è¿›åº¦æ˜¾ç¤º
   - å¯¼å‡ºåŠŸèƒ½
   - æ•°æ®å¯è§†åŒ–

4. **ç›‘æ§å‘Šè­¦**
   - æ€§èƒ½ç›‘æ§
   - é”™è¯¯å‘Šè­¦
   - æ—¥å¿—åˆ†æ

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
1. `å•†å“APIä½¿ç”¨è¯´æ˜.md` - è¯¦ç»†çš„APIæ–‡æ¡£
2. `APIæµ‹è¯•ç¤ºä¾‹.md` - å…¶ä»–APIçš„æµ‹è¯•ç¤ºä¾‹
3. æ—¥å¿—æ–‡ä»¶ - `logs/xianyu_*.log`

## âœ… æµ‹è¯•æ¸…å•

- [x] è·å–å•é¡µå•†å“
- [x] è·å–æ‰€æœ‰å•†å“
- [x] ä»æ•°æ®åº“æŸ¥è¯¢
- [x] Tokenå¤±æ•ˆé‡è¯•
- [x] é”™è¯¯å¤„ç†
- [x] Webç•Œé¢
- [x] APIæ–‡æ¡£
- [x] æµ‹è¯•è„šæœ¬

## ğŸ“… æ›´æ–°è®°å½•

- 2024-11-12: åˆå§‹å®ç°ï¼Œå®Œæˆæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
