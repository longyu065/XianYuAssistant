# 确认发货功能说明

## 功能概述

实现了闲鱼订单的确认发货功能，适用于虚拟商品或无需物流的商品。通过调用闲鱼API自动确认订单已发货。

## API接口

### 确认发货接口

**接口地址**: `POST /api/order/confirmShipment`

**请求参数**:
```json
{
  "xianyuAccountId": 1,           // 账号ID（必填）
  "orderId": "1234567890"         // 订单ID（必填）
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "确认发货成功",
  "data": null
}
```

**错误响应**:
```json
{
  "code": 500,
  "message": "确认发货失败: 订单不存在",
  "data": null
}
```

## 技术实现

### 1. API地址

```
https://h5api.m.goofish.com/h5/mtop.taobao.idle.logistic.consign.dummy/1.0/
```

### 2. 请求参数

**URL参数**:
```
jsv=2.7.2
appKey=34839810
t=1731420600000          # 时间戳（毫秒）
sign=abc123...           # MD5签名
v=1.0
type=originaljson
accountSite=xianyu
dataType=json
timeout=20000
api=mtop.taobao.idle.logistic.consign.dummy
sessionOption=AutoLoginOnly
```

**POST Body**:
```
data={"orderId":"1234567890","tradeText":"","picList":[],"newUnconsign":true}
```

### 3. 签名生成

**签名算法**:
```
MD5(token + "&" + timestamp + "&" + appKey + "&" + data)
```

**参数说明**:
- `token`: 从Cookie的`_m_h5_tk`字段提取，取下划线前的部分
- `timestamp`: 当前时间戳（毫秒）
- `appKey`: 固定值 `34839810`
- `data`: POST body中的data参数值（JSON字符串）

**示例**:
```java
// 提取token
String mH5Tk = "abc123_1731420600000";
String token = mH5Tk.split("_")[0];  // "abc123"

// 生成时间戳
String timestamp = "1731420600000";

// data参数
String data = "{\"orderId\":\"1234567890\",\"tradeText\":\"\",\"picList\":[],\"newUnconsign\":true}";

// 生成签名
String msg = token + "&" + timestamp + "&34839810&" + data;
String sign = MD5(msg);
```

### 4. 请求头

```
Content-Type: application/x-www-form-urlencoded
Cookie: [完整的Cookie字符串]
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Safari/537.36
Referer: https://market.m.goofish.com/
Origin: https://market.m.goofish.com
Accept: application/json, text/plain, */*
Accept-Language: zh-CN,zh;q=0.9
```

### 5. 响应格式

**成功响应**:
```json
{
  "ret": ["SUCCESS::调用成功"],
  "data": {
    "success": true,
    "message": "操作成功"
  }
}
```

**失败响应**:
```json
{
  "ret": ["FAIL_SYS_SESSION_EXPIRED::Session过期"],
  "data": null
}
```

## 使用方法

### 方法1：使用Web界面

1. 访问：`http://localhost:8080/order.html`
2. 输入账号ID和订单ID
3. 点击"确认发货"按钮
4. 查看操作结果

### 方法2：使用curl命令

```bash
curl -X POST http://localhost:8080/api/order/confirmShipment \
  -H "Content-Type: application/json" \
  -d "{\"xianyuAccountId\": 1, \"orderId\": \"1234567890\"}"
```

### 方法3：使用Java代码

```java
@Autowired
private OrderService orderService;

public void confirmOrder(Long accountId, String orderId) {
    boolean success = orderService.confirmShipment(accountId, orderId);
    if (success) {
        System.out.println("确认发货成功");
    } else {
        System.out.println("确认发货失败");
    }
}
```

## 获取订单ID

### 方法1：从闲鱼网页获取

1. 登录闲鱼卖家中心：`https://market.m.goofish.com/`
2. 进入"已卖出"页面
3. 点击订单详情
4. 在URL中找到订单ID，例如：
   ```
   https://market.m.goofish.com/order/detail?orderId=1234567890
   ```

### 方法2：从订单列表API获取

调用订单列表API，从响应中提取订单ID：

```java
// 假设已经实现了订单列表API
List<Order> orders = orderService.getOrderList(accountId);
for (Order order : orders) {
    String orderId = order.getOrderId();
    // 处理订单
}
```

### 方法3：从数据库查询

如果已经保存了订单信息：

```sql
SELECT order_id, order_status, buyer_nick
FROM xianyu_order
WHERE xianyu_account_id = 1
  AND order_status = 'WAIT_SELLER_SEND_GOODS'  -- 待发货状态
ORDER BY created_time DESC;
```

## 注意事项

### 1. Cookie有效性

- 确保Cookie中包含`_m_h5_tk`字段
- Cookie过期会导致签名验证失败
- 建议定期更新Cookie

### 2. 订单状态

- 只能确认"待发货"状态的订单
- 已发货或已完成的订单无法重复确认
- 取消的订单无法确认发货

### 3. 签名时效性

- 签名包含时间戳，有时效限制
- 建议在生成签名后立即发送请求
- 如果请求失败，需要重新生成签名

### 4. 错误处理

常见错误及解决方法：

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| Session过期 | Cookie失效 | 重新登录获取Cookie |
| 签名错误 | 签名计算错误 | 检查token和data参数 |
| 订单不存在 | 订单ID错误 | 确认订单ID是否正确 |
| 订单状态不允许 | 订单不是待发货状态 | 检查订单当前状态 |

## 日志示例

### 成功日志

```
【账号1】开始确认发货: orderId=1234567890
【账号1】data参数: {"orderId":"1234567890","tradeText":"","picList":[],"newUnconsign":true}
【账号1】签名生成: timestamp=1731420600000, token=abc123..., sign=def456...
【账号1】请求URL: https://h5api.m.goofish.com/h5/mtop.taobao.idle.logistic.consign.dummy/1.0/?jsv=2.7.2&...
【账号1】发送确认发货请求...
【账号1】响应状态码: 200
【账号1】响应内容: {"ret":["SUCCESS::调用成功"],"data":{...}}
【账号1】✅ 确认发货成功: orderId=1234567890
```

### 失败日志

```
【账号1】开始确认发货: orderId=1234567890
【账号1】data参数: {"orderId":"1234567890","tradeText":"","picList":[],"newUnconsign":true}
【账号1】签名生成: timestamp=1731420600000, token=abc123..., sign=def456...
【账号1】请求URL: https://h5api.m.goofish.com/h5/mtop.taobao.idle.logistic.consign.dummy/1.0/?jsv=2.7.2&...
【账号1】发送确认发货请求...
【账号1】响应状态码: 200
【账号1】响应内容: {"ret":["FAIL_SYS_SESSION_EXPIRED::Session过期"],"data":null}
【账号1】❌ 确认发货失败: {"ret":["FAIL_SYS_SESSION_EXPIRED::Session过期"],"data":null}
```

## 测试步骤

### 1. 准备测试数据

```sql
-- 查询账号信息
SELECT id, user_id, nick 
FROM xianyu_cookie 
WHERE id = 1;

-- 确认Cookie有效
SELECT cookie 
FROM xianyu_cookie 
WHERE id = 1;
```

### 2. 获取测试订单ID

- 从闲鱼网页获取一个待发货的订单ID
- 或者使用测试订单ID（如果有）

### 3. 执行测试

```bash
# 使用curl测试
curl -X POST http://localhost:8080/api/order/confirmShipment \
  -H "Content-Type: application/json" \
  -d "{\"xianyuAccountId\": 1, \"orderId\": \"1234567890\"}"
```

### 4. 验证结果

- 检查API响应是否成功
- 查看应用日志
- 在闲鱼网页确认订单状态是否变为"已发货"

## 扩展功能

未来可以扩展的功能：

1. **批量确认发货**：一次确认多个订单
2. **自动确认发货**：监听订单状态，自动确认
3. **发货通知**：确认发货后自动发送消息通知买家
4. **物流信息**：支持填写物流单号
5. **发货记录**：保存发货记录到数据库

## 参考资料

- Python代码：`secure_confirm_decrypted.py`
- 签名工具：`XianyuSignUtils.java`
- 订单服务：`OrderServiceImpl.java`
