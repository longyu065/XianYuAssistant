# 验证等待机制是否生效

## 问题现象

日志显示异常一直在第70行抛出，说明等待机制没有生效。

## 原因

代码已经修改，但是**应用没有重启**，所以还在运行旧代码。

## 解决方法

### 1. 重启应用

停止并重新启动Spring Boot应用。

### 2. 验证是否生效

重启后，观察日志：

#### 首次请求（应该看到）
```
INFO  启动WebSocket请求: xianyuAccountId=1
INFO  正在获取accessToken: accountId=1
WARN  启动WebSocket需要滑块验证
WARN  需要滑块验证 [异常堆栈]  ← 只有首次会有
```

#### 第二次请求（5秒后，应该看到）
```
INFO  启动WebSocket请求: xianyuAccountId=1
INFO  正在获取accessToken: accountId=1
```

**注意**：第二次请求**不应该**再有WARN日志和异常堆栈！

如果还有，说明代码没有生效。

### 3. 如果还是不行

#### 方案A：清理并重新编译

```bash
# Maven项目
mvn clean compile

# 或者在IDE中
# Build -> Rebuild Project
```

#### 方案B：检查代码是否被还原

查看 `WebSocketTokenServiceImpl.java` 第60-80行，应该包含：

```java
// 0. 检查是否正在等待验证
if (pendingCaptchaAccounts.containsKey(accountId)) {
    Long timestamp = captchaTimestamps.get(accountId);
    if (timestamp != null && System.currentTimeMillis() - timestamp < CAPTCHA_TIMEOUT) {
        // 仍在等待验证，直接抛出异常，不重复请求
        String captchaUrl = pendingCaptchaAccounts.get(accountId);
        log.debug("【账号{}】正在等待滑块验证，跳过重复请求", accountId);
        throw new CaptchaRequiredException(captchaUrl);
    }
    // ...
}
```

如果这段代码不存在，说明被IDE自动格式化还原了。

## 预期效果

### 修改前
```
10:54:25 WARN 需要滑块验证 [异常堆栈 50行]
10:54:30 WARN 需要滑块验证 [异常堆栈 50行]  ← 重复
10:54:35 WARN 需要滑块验证 [异常堆栈 50行]  ← 重复
10:54:40 WARN 需要滑块验证 [异常堆栈 50行]  ← 重复
```

### 修改后
```
10:54:25 WARN 需要滑块验证 [异常堆栈 50行]  ← 只有首次
10:54:30 INFO 启动WebSocket请求
10:54:35 INFO 启动WebSocket请求
10:54:40 INFO 启动WebSocket请求
```

## 临时解决方案

如果重启后还是不行，可以临时增加前端的检查间隔：

编辑 `websocket-manual-captcha.html`，找到：

```javascript
}, 5000); // 每5秒检查一次
```

改为：

```javascript
}, 30000); // 每30秒检查一次
```

这样可以减少日志输出，但不是根本解决方案。

## 根本解决方案

确保以下代码存在并生效：

### 1. WebSocketTokenServiceImpl.java

```java
// 类成员变量
private final Map<Long, String> pendingCaptchaAccounts = new ConcurrentHashMap<>();
private final Map<Long, Long> captchaTimestamps = new ConcurrentHashMap<>();
private static final long CAPTCHA_TIMEOUT = 5 * 60 * 1000;

// getAccessToken方法开头
@Override
public String getAccessToken(Long accountId, String cookiesStr, String deviceId) {
    try {
        // 0. 检查是否正在等待验证
        if (pendingCaptchaAccounts.containsKey(accountId)) {
            // ... 等待逻辑
        }
        // ... 其他代码
    }
}
```

### 2. WebSocketController.java

```java
} catch (CaptchaRequiredException e) {
    log.debug("需要滑块验证: accountId={}, url={}", ...);  // 改为debug
    // ... 返回结果
}
```

## 检查清单

- [ ] 代码已修改
- [ ] 应用已重启
- [ ] 清理并重新编译
- [ ] 验证日志输出
- [ ] 第二次请求不再有异常堆栈

## 如果还是不行

请提供以下信息：

1. 重启后的完整日志（包括启动日志）
2. `WebSocketTokenServiceImpl.java` 第60-80行的代码
3. IDE和构建工具（IDEA/Eclipse, Maven/Gradle）

这样我可以帮你进一步排查问题。
