# 自动发货和自动回复测试指南

## 前置条件

1. 确保数据库已执行迁移脚本：`migration_add_auto_delivery.sql`
2. 确保 WebSocket 已连接
3. 准备测试商品和账号

## 测试步骤

### 一、测试自动发货

#### 1. 配置自动发货

```sql
-- 1.1 开启商品的自动发货开关
INSERT INTO xianyu_goods_config (xianyu_account_id, xy_goods_id, xianyu_auto_delivery_on, xianyu_auto_reply_on)
VALUES (1, '你的商品ID', 1, 0);

-- 1.2 配置自动发货内容
INSERT INTO xianyu_goods_auto_delivery_config (xianyu_account_id, xy_goods_id, type, auto_delivery_content)
VALUES (1, '你的商品ID', 1, '您好！感谢购买，这是您的虚拟商品内容：
激活码：TEST-1234-5678-ABCD
使用说明：请在官网激活使用
有问题随时联系我！');
```

#### 2. 触发自动发货

模拟买家拍下商品，系统会收到 content_type=26 的消息，内容包含"[我已拍下，待付款]"。

#### 3. 观察日志

```
【账号1】检测到待付款消息: xyGoodsId=789012, sId=55435931514@goofish
【账号1】处理自动发货: xyGoodsId=789012
【账号1】模拟人工操作延迟...
【账号1】准备发送自动发货消息
【账号1】自动发货成功
```

#### 4. 查看发货记录

```sql
SELECT * FROM xianyu_goods_auto_delivery_record 
WHERE xianyu_account_id = 1 
ORDER BY create_time DESC;
```

### 二、测试自动回复

#### 1. 配置自动回复

```sql
-- 1.1 开启商品的自动回复开关
UPDATE xianyu_goods_config 
SET xianyu_auto_reply_on = 1 
WHERE xy_goods_id = '你的商品ID';

-- 1.2 配置自动回复规则（包含匹配）
INSERT INTO xianyu_goods_auto_reply_config (xianyu_account_id, xy_goods_id, keyword, reply_content, match_type)
VALUES (1, '你的商品ID', '在吗,你好,咨询', '您好！我在的，有什么可以帮您？😊', 1);

-- 1.3 配置价格相关的自动回复
INSERT INTO xianyu_goods_auto_reply_config (xianyu_account_id, xy_goods_id, keyword, reply_content, match_type)
VALUES (1, '你的商品ID', '多少钱,价格,怎么卖', '这个商品价格是99元哦~全国包邮！', 1);

-- 1.4 配置包邮相关的自动回复
INSERT INTO xianyu_goods_auto_reply_config (xianyu_account_id, xy_goods_id, keyword, reply_content, match_type)
VALUES (1, '你的商品ID', '包邮,邮费,运费', '亲，全国包邮的哦！下单即可~', 1);
```

#### 2. 触发自动回复

让买家发送包含关键词的消息，例如：
- "你好"
- "在吗"
- "多少钱"
- "包邮吗"

#### 3. 观察日志

```
【账号1】检测到买家消息: xyGoodsId=789012, message=你好
【账号1】处理自动回复: xyGoodsId=789012
【账号1】匹配到关键词: 你好, 匹配类型: 1
【账号1】模拟人工操作延迟...
【账号1】准备发送自动回复
【账号1】自动回复成功
```

#### 4. 查看回复记录

```sql
SELECT * FROM xianyu_goods_auto_reply_record 
WHERE xianyu_account_id = 1 
ORDER BY create_time DESC;
```

### 三、测试人工延迟

观察日志中的延迟时间，应该看到：

```
模拟人工操作延迟...
模拟阅读延迟: 1234ms (文本长度: 10)
模拟思考延迟: 2345ms
模拟打字延迟: 3456ms (文本长度: 30)
```

每次延迟时间都是随机的，符合人工操作特征。

### 四、测试商品列表刷新延迟

```bash
# 调用刷新接口
curl -X POST http://localhost:10009/api/items/refresh \
  -H "Content-Type: application/json" \
  -d '{
    "xianyuAccountId": 1,
    "pageSize": 20,
    "maxPages": 3
  }'
```

观察日志，每次翻页都会有延迟：

```
第1页获取到20个商品
模拟人工翻页延迟...
第2页获取到20个商品
模拟人工翻页延迟...
第3页获取到15个商品
```

## 测试场景

### 场景1：买家咨询价格

1. 买家发送："这个多少钱？"
2. 系统自动回复："这个商品价格是99元哦~全国包邮！"
3. 延迟时间：阅读(1-2秒) + 思考(1-4秒) + 打字(2-5秒) = 4-11秒

### 场景2：买家拍下商品

1. 买家拍下商品
2. 系统收到"[我已拍下，待付款]"消息
3. 系统自动发送发货内容
4. 延迟时间：阅读(1-3秒) + 思考(1-4秒) + 打字(根据内容长度) = 5-15秒

### 场景3：买家连续提问

1. 买家："在吗？"
2. 系统回复："您好！我在的，有什么可以帮您？😊"
3. 买家："包邮吗？"
4. 系统回复："亲，全国包邮的哦！下单即可~"

每次回复都有独立的延迟，更像真人。

## 常见问题

### Q1: 自动回复没有触发？

检查：
1. 商品是否开启了自动回复开关
2. 关键词是否配置正确
3. 消息是否是买家发送的（不是自己发的）
4. WebSocket 是否正常连接

### Q2: 延迟时间太长或太短？

修改 `HumanLikeDelayUtils.java` 中的延迟参数：

```java
// 调整思考延迟
public static void thinkingDelay() {
    delay(1000, 4000); // 改为 delay(500, 2000) 可以缩短延迟
}
```

### Q3: 如何查看所有配置？

```sql
-- 查看商品配置
SELECT * FROM xianyu_goods_config;

-- 查看自动发货配置
SELECT * FROM xianyu_goods_auto_delivery_config;

-- 查看自动回复配置
SELECT * FROM xianyu_goods_auto_reply_config;
```

### Q4: 如何禁用自动功能？

```sql
-- 禁用自动发货
UPDATE xianyu_goods_config 
SET xianyu_auto_delivery_on = 0 
WHERE xy_goods_id = '你的商品ID';

-- 禁用自动回复
UPDATE xianyu_goods_config 
SET xianyu_auto_reply_on = 0 
WHERE xy_goods_id = '你的商品ID';
```

## 性能监控

### 查看发货成功率

```sql
SELECT 
    COUNT(*) as total,
    SUM(CASE WHEN state = 1 THEN 1 ELSE 0 END) as success,
    ROUND(SUM(CASE WHEN state = 1 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as success_rate
FROM xianyu_goods_auto_delivery_record
WHERE xianyu_account_id = 1;
```

### 查看回复成功率

```sql
SELECT 
    COUNT(*) as total,
    SUM(CASE WHEN state = 1 THEN 1 ELSE 0 END) as success,
    ROUND(SUM(CASE WHEN state = 1 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as success_rate
FROM xianyu_goods_auto_reply_record
WHERE xianyu_account_id = 1;
```

### 查看最常匹配的关键词

```sql
SELECT 
    matched_keyword,
    COUNT(*) as count
FROM xianyu_goods_auto_reply_record
WHERE xianyu_account_id = 1 AND state = 1
GROUP BY matched_keyword
ORDER BY count DESC
LIMIT 10;
```

## 安全建议

1. **不要设置过短的延迟**：太快的响应会被识别为机器人
2. **合理配置关键词**：避免过于宽泛的匹配导致误回复
3. **定期检查记录**：查看是否有异常的自动回复
4. **避免敏感内容**：不要在自动回复中包含敏感信息
5. **监控频率**：如果短时间内大量自动回复，可能被限制
