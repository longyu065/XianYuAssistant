# 快速测试消息发送功能

## 测试前准备

### 1. 确保WebSocket已连接

访问：`http://localhost:8080/websocket-send.html`

点击"检查连接状态"，确认显示"已连接"。

如果未连接，点击"启动连接"。

### 2. 查询正确的参数

打开数据库管理工具（如DB Browser for SQLite），执行以下SQL：

```sql
-- 查询最近收到的消息（用于回复）
SELECT 
    session_id as cid,
    sender_user_id as toId,
    content_text as received_message,
    datetime(message_time/1000, 'unixepoch', 'localtime') as time
FROM xianyu_chat_message
WHERE xianyu_account_id = 1
  AND direction = 2  -- 2=收到的消息
ORDER BY message_time DESC
LIMIT 5;
```

**记录查询结果**：
- `cid` (会话ID): 例如 `3812882055015`
- `toId` (对方用户ID): 例如 `3553532632`

**注意**：
- 如果数据库中的值包含`@goofish`后缀，需要去掉
- 例如：`3553532632@goofish` → 使用 `3553532632`

### 3. 验证用户ID

```sql
-- 查询当前账号的用户ID
SELECT id, user_id, unb 
FROM xianyu_cookie 
WHERE id = 1;
```

**记录**：
- `unb` 字段的值（这是你的用户ID）

## 测试步骤

### 方法1：使用Web界面测试

1. 访问：`http://localhost:8080/websocket-send.html`

2. 填写表单：
   - **账号ID**: `1`
   - **会话ID (cid)**: 从数据库查询的`session_id`（不带@goofish）
   - **接收方ID (toId)**: 从数据库查询的`sender_user_id`（不带@goofish）
   - **消息内容**: `测试消息`

3. 点击"发送消息"

4. 查看结果：
   - 成功：显示"✅ 消息发送成功"
   - 失败：显示错误信息

### 方法2：使用curl命令测试

```bash
curl -X POST http://localhost:8080/api/websocket/sendMessage ^
  -H "Content-Type: application/json" ^
  -d "{\"xianyuAccountId\": 1, \"cid\": \"3812882055015\", \"toId\": \"3553532632\", \"text\": \"测试消息\"}"
```

**替换参数**：
- `xianyuAccountId`: 你的账号ID
- `cid`: 从数据库查询的会话ID
- `toId`: 从数据库查询的用户ID

### 方法3：使用批处理文件测试

运行：`测试消息发送API.bat`

**修改批处理文件中的参数**：
```batch
curl -X POST http://localhost:8080/api/websocket/sendMessage ^
  -H "Content-Type: application/json" ^
  -d "{\"xianyuAccountId\": 1, \"cid\": \"你的cid\", \"toId\": \"你的toId\", \"text\": \"测试消息\"}"
```

## 查看日志

### 1. 应用日志

在控制台或日志文件中查找：

```
【账号1】=== 开始发送消息 ===
【账号1】输入参数 - cid: 3812882055015, toId: 3553532632, text: 测试消息
【账号1】当前用户ID - myUserId: 2218021801256, accountId: 1
【账号1】消息内容JSON: {"contentType":1,"text":{"text":"测试消息"}}
【账号1】Base64编码: eyJjb250ZW50VHlwZSI6MSwidGV4dCI6eyJ0ZXh0Ijoi5rWL6K+V5raI5oGvIn19
【账号1】实际发送者ID: 2218021801256
【账号1】actualReceivers: [3553532632@goofish, 2218021801256@goofish]
【账号1】完整消息JSON: {...}
【账号1】✅ 消息已发送到WebSocket: cid=3812882055015, toId=3553532632, text=测试消息
【账号1】=== 发送消息完成 ===
```

### 2. 服务器响应

查找WebSocket收到的响应：

```
【账号1】消息#XX [响应(code=200)]: {"code":200,"headers":{...}}
```

**成功标志**：`code=200`
**失败标志**：`code=500`

## 验证消息是否发送成功

### 方法1：查询数据库

```sql
-- 查询最近发送的消息
SELECT 
    session_id,
    receiver_user_id,
    content_text,
    direction,
    datetime(message_time/1000, 'unixepoch', 'localtime') as time
FROM xianyu_chat_message
WHERE xianyu_account_id = 1
  AND direction = 1  -- 1=发送的消息
ORDER BY message_time DESC
LIMIT 5;
```

应该能看到刚才发送的"测试消息"。

### 方法2：查看闲鱼App/Web

在闲鱼App或网页版中，打开对应的聊天窗口，应该能看到发送的消息。

## 常见问题

### 问题1：返回500错误

**可能原因**：
1. `myUserId`未正确设置
2. `cid`或`toId`格式错误
3. 消息格式不正确

**解决方法**：
1. 检查日志中的`myUserId`是否正确
2. 确认`cid`和`toId`不包含`@goofish`后缀
3. 查看完整的错误日志

### 问题2：WebSocket未连接

**错误信息**：
```
WebSocket未连接，请先启动连接
```

**解决方法**：
1. 访问 `http://localhost:8080/websocket-send.html`
2. 点击"启动连接"
3. 等待连接成功后再发送消息

### 问题3：找不到会话ID

**解决方法**：
1. 先在闲鱼App中与某个用户聊天
2. 等待WebSocket接收到消息
3. 从数据库查询`session_id`

### 问题4：用户ID格式错误

**错误示例**：
- `toId = "1"` （这是accountId，不是用户ID）
- `toId = "3553532632@goofish"` （不应该包含后缀）

**正确示例**：
- `toId = "3553532632"` （纯数字，不带后缀）

## 调试技巧

### 1. 对比Python日志

如果有Python版本，运行并对比日志：

**Python日志**：
```python
发送消息: cid=3812882055015, toId=3553532632
actualReceivers: ['3553532632@goofish', '2218021801256@goofish']
```

**Java日志**：
```
【账号1】实际发送者ID: 2218021801256
【账号1】actualReceivers: [3553532632@goofish, 2218021801256@goofish]
```

应该完全一致。

### 2. 使用已知正确的参数

从Python成功发送的日志中复制参数，在Java中测试：

```bash
# 从Python日志中复制
cid = "3812882055015"
toId = "3553532632"

# 在Java中测试
curl -X POST http://localhost:8080/api/websocket/sendMessage ^
  -H "Content-Type: application/json" ^
  -d "{\"xianyuAccountId\": 1, \"cid\": \"3812882055015\", \"toId\": \"3553532632\", \"text\": \"test\"}"
```

### 3. 检查Base64编码

在线Base64解码工具：https://www.base64decode.org/

将日志中的Base64编码复制到工具中解码，验证内容是否正确：

**编码**：`eyJjb250ZW50VHlwZSI6MSwidGV4dCI6eyJ0ZXh0Ijoi5rWL6K+V5raI5oGvIn19`

**解码**：`{"contentType":1,"text":{"text":"测试消息"}}`

## 成功示例

### 完整的成功日志

```
2025-11-12 21:50:00.123 [http-nio-8080-exec-1] INFO  WebSocketServiceImpl - 发送消息: accountId=1, cid=3812882055015, toId=3553532632, text=你好
2025-11-12 21:50:00.124 [http-nio-8080-exec-1] INFO  XianyuWebSocketClient - 【账号1】=== 开始发送消息 ===
2025-11-12 21:50:00.124 [http-nio-8080-exec-1] INFO  XianyuWebSocketClient - 【账号1】输入参数 - cid: 3812882055015, toId: 3553532632, text: 你好
2025-11-12 21:50:00.124 [http-nio-8080-exec-1] INFO  XianyuWebSocketClient - 【账号1】当前用户ID - myUserId: 2218021801256, accountId: 1
2025-11-12 21:50:00.125 [http-nio-8080-exec-1] INFO  XianyuWebSocketClient - 【账号1】消息内容JSON: {"contentType":1,"text":{"text":"你好"}}
2025-11-12 21:50:00.125 [http-nio-8080-exec-1] INFO  XianyuWebSocketClient - 【账号1】Base64编码: eyJjb250ZW50VHlwZSI6MSwidGV4dCI6eyJ0ZXh0Ijoi5L2g5aW9In19
2025-11-12 21:50:00.126 [http-nio-8080-exec-1] INFO  XianyuWebSocketClient - 【账号1】实际发送者ID: 2218021801256
2025-11-12 21:50:00.126 [http-nio-8080-exec-1] INFO  XianyuWebSocketClient - 【账号1】actualReceivers: [3553532632@goofish, 2218021801256@goofish]
2025-11-12 21:50:00.127 [http-nio-8080-exec-1] INFO  XianyuWebSocketClient - 【账号1】完整消息JSON: {"lwp":"/r/MessageSend/sendByReceiverScope","headers":{"mid":"1231762954883750 0"},"body":[{...}]}
2025-11-12 21:50:00.128 [http-nio-8080-exec-1] INFO  XianyuWebSocketClient - 【账号1】✅ 消息已发送到WebSocket: cid=3812882055015, toId=3553532632, text=你好
2025-11-12 21:50:00.128 [http-nio-8080-exec-1] INFO  XianyuWebSocketClient - 【账号1】=== 发送消息完成 ===
2025-11-12 21:50:00.200 [pool-3-thread-8] INFO  XianyuWebSocketClient - 【账号1】消息#38 [响应(code=200)]: {"code":200,"headers":{...}}
```

### API响应

```json
{
  "code": 200,
  "message": "消息发送成功",
  "data": null
}
```

### 数据库记录

```sql
SELECT * FROM xianyu_chat_message 
WHERE content_text = '你好' 
AND direction = 1 
ORDER BY message_time DESC LIMIT 1;

-- 结果：
-- id: 123
-- session_id: 3812882055015
-- receiver_user_id: 3553532632
-- content_text: 你好
-- direction: 1
-- message_time: 1731420600000
```

## 下一步

消息发送成功后，可以：

1. 实现自动回复功能
2. 实现批量发送消息
3. 实现消息模板功能
4. 实现定时发送功能
5. 实现图片消息发送
