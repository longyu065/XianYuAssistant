# 刷新接口参数调整说明

## 变更概述

将 `/api/items/refresh` 接口的请求参数从 `cookieId` 改为 `xianyuAccountId`，使用账号ID直接查询Cookie，简化调用逻辑。

## 变更原因

1. **语义更清晰**：使用 `xianyuAccountId` 更明确表示是闲鱼账号ID
2. **逻辑更简单**：直接使用账号ID查询Cookie，不需要支持多种格式
3. **数据一致性**：与数据库字段 `xianyu_account_id` 保持一致
4. **类型安全**：使用 `Long` 类型而不是 `String`，避免类型转换

## 变更内容

### 1. DTO 修改

**文件：** `AllItemsReqDTO.java`

**修改前：**
```java
@Data
public class AllItemsReqDTO {
    private String cookieId;  // 支持账号ID、账号备注、UNB
    private Integer pageSize = 20;
    private Integer maxPages;
}
```

**修改后：**
```java
@Data
public class AllItemsReqDTO {
    private Long xianyuAccountId;  // 只支持账号ID
    private Integer pageSize = 20;
    private Integer maxPages;
}
```

### 2. Service 修改

**文件：** `ItemServiceImpl.java`

**主要变更：**

1. **参数验证**
```java
// 验证账号ID
if (reqDTO.getXianyuAccountId() == null) {
    return ResultObject.failed("账号ID不能为空");
}
```

2. **获取Cookie**
```java
// 根据账号ID获取Cookie
String cookieStr = accountService.getCookieByAccountId(reqDTO.getXianyuAccountId());
if (cookieStr == null || cookieStr.isEmpty()) {
    return ResultObject.failed("未找到账号Cookie，请先登录");
}
```

3. **保存商品**
```java
// 直接使用账号ID
Long accountId = reqDTO.getXianyuAccountId();
goodsInfoService.saveOrUpdateGoodsInfo(item, accountId);
```

### 3. Controller 修改

**文件：** `ItemController.java`

**日志输出：**
```java
log.info("刷新商品数据请求: xianyuAccountId={}", reqDTO.getXianyuAccountId());
```

### 4. 前端修改

**文件：** `items.html`

**表单字段：**
```html
<!-- 修改前 -->
<input type="text" id="cookieId_8a7f3" placeholder="请输入账号ID、账号备注或UNB">

<!-- 修改后 -->
<input type="number" id="xianyuAccountId_8a7f3" placeholder="请输入闲鱼账号ID" min="1">
```

**JavaScript 代码：**
```javascript
// 修改前
const requestBody = {
    cookieId: cookieId,
    pageSize: pageSize
};

// 修改后
const requestBody = {
    xianyuAccountId: parseInt(xianyuAccountId),
    pageSize: pageSize
};
```

## API 调用示例

### 修改前

```bash
curl -X POST "http://localhost:8080/api/items/refresh" \
  -H "Content-Type: application/json" \
  -d '{
    "cookieId": "1",
    "pageSize": 20,
    "maxPages": 5
  }'
```

### 修改后

```bash
curl -X POST "http://localhost:8080/api/items/refresh" \
  -H "Content-Type: application/json" \
  -d '{
    "xianyuAccountId": 1,
    "pageSize": 20,
    "maxPages": 5
  }'
```

## 优势对比

### 修改前

**支持的输入格式：**
- 账号ID：`"1"`
- 账号备注：`"账号_12345678"`
- UNB：`"2200123456789"`

**问题：**
- 需要复杂的解析逻辑
- 类型不安全（String）
- 语义不清晰

### 修改后

**支持的输入格式：**
- 账号ID：`1`（数字）

**优势：**
- 逻辑简单直接
- 类型安全（Long）
- 语义清晰明确
- 与数据库字段一致

## 数据流程

### 完整流程

```
前端输入账号ID (1)
    ↓
POST /api/items/refresh
    ↓
ItemController.refreshItems()
    ↓
ItemServiceImpl.refreshItems()
    ↓
accountService.getCookieByAccountId(1)
    ↓
查询数据库获取Cookie
    ↓
调用闲鱼API获取商品列表
    ↓
goodsInfoService.saveOrUpdateGoodsInfo(item, 1)
    ↓
保存商品，设置 xianyu_account_id = 1
```

## 兼容性说明

### 不兼容变更

这是一个**不兼容的变更**，旧的调用方式将无法工作。

**旧的调用方式（不再支持）：**
```json
{
  "cookieId": "账号_12345678",
  "pageSize": 20
}
```

**新的调用方式（必须使用）：**
```json
{
  "xianyuAccountId": 1,
  "pageSize": 20
}
```

### 迁移指南

如果你之前使用账号备注或UNB调用接口，需要：

1. **查询账号ID**
```sql
-- 通过账号备注查询
SELECT id FROM xianyu_account WHERE account_note = '账号_12345678';

-- 通过UNB查询
SELECT id FROM xianyu_account WHERE unb = '2200123456789';
```

2. **使用账号ID调用**
```bash
curl -X POST "http://localhost:8080/api/items/refresh" \
  -H "Content-Type: application/json" \
  -d '{"xianyuAccountId": 1, "pageSize": 20}'
```

## 错误处理

### 错误1：账号ID为空

**请求：**
```json
{
  "pageSize": 20
}
```

**响应：**
```json
{
  "code": 500,
  "msg": "账号ID不能为空"
}
```

### 错误2：账号不存在或Cookie无效

**请求：**
```json
{
  "xianyuAccountId": 999,
  "pageSize": 20
}
```

**响应：**
```json
{
  "code": 500,
  "msg": "未找到账号Cookie，请先登录"
}
```

## 日志示例

### 成功日志

```
2024-11-12 17:00:00.123 [http-nio-8080-exec-1] INFO  ItemController - 刷新商品数据请求: xianyuAccountId=1
2024-11-12 17:00:00.124 [http-nio-8080-exec-1] INFO  ItemServiceImpl - 开始刷新商品数据: xianyuAccountId=1
2024-11-12 17:00:00.125 [http-nio-8080-exec-1] INFO  ItemServiceImpl - 获取账号Cookie成功: xianyuAccountId=1
2024-11-12 17:00:01.234 [http-nio-8080-exec-1] INFO  GoodsInfoServiceImpl - 新增商品信息: xyGoodId=123456789, title=商品标题, id=987654321, accountId=1
2024-11-12 17:00:01.235 [http-nio-8080-exec-1] INFO  ItemServiceImpl - 刷新商品数据完成: xianyuAccountId=1, 总数=20, 成功=20
```

## 测试验证

### 测试步骤

1. **准备测试数据**
```sql
-- 确认账号存在
SELECT id, account_note, unb FROM xianyu_account WHERE id = 1;

-- 确认Cookie有效
SELECT cookie_status FROM xianyu_cookie WHERE xianyu_account_id = 1;
```

2. **测试刷新接口**
```bash
curl -X POST "http://localhost:8080/api/items/refresh" \
  -H "Content-Type: application/json" \
  -d '{"xianyuAccountId":1,"pageSize":5,"maxPages":1}'
```

3. **验证结果**
```sql
-- 查询商品是否保存成功
SELECT xy_good_id, title, xianyu_account_id 
FROM xianyu_goods_info 
WHERE xianyu_account_id = 1 
LIMIT 5;
```

## 总结

### 变更要点

1. ✅ 参数名从 `cookieId` 改为 `xianyuAccountId`
2. ✅ 参数类型从 `String` 改为 `Long`
3. ✅ 只支持账号ID，不再支持账号备注和UNB
4. ✅ 逻辑简化，直接查询Cookie
5. ✅ 前端界面同步更新

### 影响范围

- **后端**：DTO、Service、Controller
- **前端**：items.html
- **API**：不兼容变更，需要更新调用方式

### 优势

- 逻辑更简单清晰
- 类型更安全
- 语义更明确
- 与数据库字段一致

## 更新时间

2024-11-12
