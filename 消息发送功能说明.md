# 消息发送功能说明

## 功能概述

实现了通过WebSocket向指定用户发送消息的功能，支持在商品咨询窗口中发送文本消息。

## API接口

### 发送消息接口

**接口地址**: `POST /api/websocket/sendMessage`

**请求参数**:
```json
{
  "xianyuAccountId": 1,           // 账号ID（必填）
  "cid": "55435931514",           // 会话ID，不带@goofish后缀（必填）
  "toId": "3553532632",           // 接收方用户ID，不带@goofish后缀（必填）
  "text": "你好，请问商品还在吗？"  // 消息文本内容（必填）
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "消息发送成功",
  "data": null
}
```

**错误响应**:
```json
{
  "code": 500,
  "message": "WebSocket未连接，请先启动连接",
  "data": null
}
```

## 参数说明

### 1. xianyuAccountId（账号ID）
- 类型: Long
- 说明: 发送消息的闲鱼账号ID
- 获取方式: 从数据库 `xianyu_cookie` 表中查询

### 2. cid（会话ID）
- 类型: String
- 说明: 聊天会话的唯一标识，不需要带 `@goofish` 后缀
- 格式示例: `55435931514`
- 数据库字段: `xianyu_chat_message.session_id`
- 获取方式: 
  - 从聊天消息中解析获取（解密数据的字段1.6）
  - 从数据库查询：`SELECT session_id FROM xianyu_chat_message WHERE xianyu_account_id = 1`

### 3. toId（接收方用户ID）
- 类型: String
- 说明: 消息接收方的用户ID，不需要带 `@goofish` 后缀
- 格式示例: `3553532632`
- 数据库字段: 
  - 如果是回复别人的消息：`xianyu_chat_message.sender_user_id`（对方发来的消息的发送者）
  - 如果是主动发消息：`xianyu_chat_message.receiver_user_id`
- 获取方式:
  - 从聊天消息中解析获取（解密数据的字段1.1.1或1.2）
  - 从数据库查询：`SELECT sender_user_id, receiver_user_id FROM xianyu_chat_message WHERE xianyu_account_id = 1`

### 4. text（消息内容）
- 类型: String
- 说明: 要发送的文本消息内容
- 示例: `"你好，请问商品还在吗？"`

## 使用流程

### 1. 启动WebSocket连接
```bash
curl -X POST http://localhost:8080/api/websocket/start \
  -H "Content-Type: application/json" \
  -d "{\"xianyuAccountId\": 1}"
```

### 2. 检查连接状态
```bash
curl -X POST http://localhost:8080/api/websocket/status \
  -H "Content-Type: application/json" \
  -d "{\"xianyuAccountId\": 1}"
```

### 3. 发送消息
```bash
curl -X POST http://localhost:8080/api/websocket/sendMessage \
  -H "Content-Type: application/json" \
  -d "{\"xianyuAccountId\": 1, \"cid\": \"55435931514\", \"toId\": \"3553532632\", \"text\": \"你好\"}"
```

## 技术实现

### 消息格式

参考Python代码和Web端实现，消息格式如下：

```json
{
  "lwp": "/r/MessageSend/sendByReceiverScope",
  "headers": {
    "mid": "6551762954272987 0"
  },
  "body": [
    {
      "uuid": "-17629542729862",
      "cid": "55435931514@goofish",
      "conversationType": 1,
      "content": {
        "contentType": 101,
        "custom": {
          "type": 1,
          "data": "eyJjb250ZW50VHlwZSI6MSwidGV4dCI6eyJ0ZXh0IjoibmloYW8ifX0="
        }
      },
      "redPointPolicy": 0,
      "extension": {
        "extJson": "{}"
      },
      "ctx": {
        "appVersion": "1.0",
        "platform": "web"
      },
      "mtags": {},
      "msgReadStatusSetting": 1
    },
    {
      "actualReceivers": [
        "3553532632@goofish",
        "2218021801256@goofish"
      ]
    }
  ]
}
```

### 关键字段说明

1. **lwp**: `/r/MessageSend/sendByReceiverScope` - 消息发送路径
2. **mid**: 消息ID，格式为 `随机数(0-999) + 时间戳(毫秒) + " 0"`
3. **uuid**: 消息唯一标识，格式为负数时间戳（去掉最后两位）
4. **cid**: 会话ID，格式为 `{cid}@goofish`
5. **contentType**: 101 表示自定义内容
6. **data**: Base64编码的消息内容
7. **actualReceivers**: 实际接收者列表，包含接收方和发送方

### Base64编码的消息内容

原始消息内容格式：
```json
{
  "contentType": 1,
  "text": {
    "text": "你好"
  }
}
```

经过Base64编码后作为 `data` 字段的值。

## 注意事项

1. **WebSocket连接**: 发送消息前必须先启动WebSocket连接
2. **参数格式**: cid和toId不需要带 `@goofish` 后缀，代码会自动添加
3. **消息类型**: 目前只支持文本消息（contentType=1）
4. **错误处理**: 如果发送失败，检查：
   - WebSocket连接是否正常
   - 参数是否正确
   - 账号是否有权限发送消息

## 测试示例

使用测试页面 `websocket-send.html` 进行测试：

1. 访问 `http://localhost:8080/websocket-send.html`
2. 输入账号ID、会话ID、接收方ID和消息内容
3. 点击"发送消息"按钮
4. 查看发送结果

## 数据库查询示例

### 查询会话ID和用户ID

```sql
-- 查询最近的聊天消息，获取cid和toId
SELECT 
    session_id as cid,
    sender_user_id,
    receiver_user_id,
    content_text,
    direction
FROM xianyu_chat_message
WHERE xianyu_account_id = 1
ORDER BY created_time DESC
LIMIT 10;

-- 说明：
-- session_id = cid（会话ID）
-- sender_user_id = 发送者用户ID
-- receiver_user_id = 接收者用户ID
-- direction: 1=发送（我发的）2=接收（收到的）
-- 
-- 如果要回复收到的消息（direction=2），toId应该使用sender_user_id
-- 如果要查看发送的消息（direction=1），toId应该使用receiver_user_id
```

### 查询账号信息

```sql
-- 查询账号ID
SELECT id, user_id, nick
FROM xianyu_cookie
WHERE id = 1;
```

## 扩展功能

未来可以扩展的功能：

1. 支持图片消息
2. 支持商品卡片消息
3. 批量发送消息
4. 消息模板功能
5. 定时发送消息
6. 消息发送记录
