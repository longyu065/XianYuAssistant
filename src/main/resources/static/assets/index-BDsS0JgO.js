import{a as F,s as W,g as re,e as K}from"./index-BTFSt2fU.js";import{u as de,a as ue,g as pe,s as fe,b as ve}from"./websocket-B7VuREY3.js";import{d as G,r as g,q as $,f as V,h as f,g as s,b as l,i as e,m as r,o as c,_ as H,v as me,x as ke,y as ge,c as h,s as S,w as O,e as _e,F as X,j as Z,n as B,t as p,E as N}from"./index-7CieyMQU.js";import"./request-DTdiWb_T.js";const ye=G({__name:"ManualUpdateCookieDialog",props:{modelValue:{type:Boolean},accountId:{},currentCookie:{}},emits:["update:modelValue","success"],setup(I,{emit:T}){const v=I,a=T,n=g(""),m=g(!1);$(()=>v.modelValue,b=>{b&&(n.value=v.currentCookie||"")});const _=async()=>{if(!n.value.trim()){F("Cookie不能为空");return}m.value=!0;try{(await de({xianyuAccountId:v.accountId,cookieText:n.value.trim()})).code===200&&(W("Cookie更新成功"),w(),a("success"))}catch(b){console.error("Cookie更新失败:",b)}finally{m.value=!1}},w=()=>{a("update:modelValue",!1)};return(b,i)=>{const d=f("el-input"),D=f("el-form-item"),C=f("el-alert"),y=f("el-form"),z=f("el-button"),U=f("el-dialog");return c(),V(U,{"model-value":I.modelValue,title:"手动更新Cookie",width:"600px",onClose:w},{footer:s(()=>[l(z,{onClick:w},{default:s(()=>[...i[2]||(i[2]=[r("取消",-1)])]),_:1}),l(z,{type:"primary",loading:m.value,onClick:_},{default:s(()=>[...i[3]||(i[3]=[r(" 确定更新 ",-1)])]),_:1},8,["loading"])]),default:s(()=>[l(y,{"label-width":"80px"},{default:s(()=>[l(D,{label:"Cookie值"},{default:s(()=>[l(d,{modelValue:n.value,"onUpdate:modelValue":i[0]||(i[0]=E=>n.value=E),type:"textarea",rows:8,placeholder:"请输入完整的Cookie字符串",class:"cookie-input"},null,8,["modelValue"])]),_:1}),l(C,{title:"提示",type:"info",closable:!1,"show-icon":""},{default:s(()=>[...i[1]||(i[1]=[e("p",{style:{"margin-bottom":"8px"}},"请从浏览器中复制完整的Cookie字符串",-1),e("p",{style:{"margin-bottom":"8px","font-size":"12px"}},[e("span",{style:{color:"#e6a23c","font-weight":"600"}},"重要字段："),e("span",{style:{color:"#f56c6c","font-weight":"500"}},"unb"),r("、 "),e("span",{style:{color:"#f56c6c","font-weight":"500"}},"_m_h5_tk"),r("、 "),e("span",{style:{color:"#f56c6c","font-weight":"500"}},"cookie2"),r("、 "),e("span",{style:{color:"#f56c6c","font-weight":"500"}},"t")],-1),e("p",{style:{"margin-bottom":"4px","font-weight":"500"}},"格式示例：",-1),e("p",{style:{"font-size":"11px","line-height":"1.8","word-break":"break-all","font-family":"'Courier New', Consolas, monospace"}},[e("span",{style:{color:"#f56c6c","font-weight":"600"}},"unb"),r("=2218021801256; cookies=sgcookie=E100JgD87TWZ...; "),e("span",{style:{color:"#f56c6c","font-weight":"600"}},"t"),r("=97df36d73d5e5bfb...; tracknick=xy246940070033; csg=f7aeab6d; _m_h5_tk_enc=51ce7936ea...; XSRF-TOKEN=bb76b331-48fb-496b...; _samesite_flag_=true; mtop_partitioned_detect=1; "),e("span",{style:{color:"#f56c6c","font-weight":"600"}},"_m_h5_tk"),r("=5f73f84e8caa...; _tb_token_=e3f1fd5ee5a34; "),e("span",{style:{color:"#f56c6c","font-weight":"600"}},"cookie2"),r("=153aeae482f715e0... ")],-1)])]),_:1})]),_:1})]),_:1},8,["model-value"])}}}),he=H(ye,[["__scopeId","data-v-ef9ad1fa"]]),we={class:"dialog-content"},be={class:"dialog-footer"},xe=G({__name:"ManualUpdateTokenDialog",props:{modelValue:{type:Boolean},accountId:{},currentToken:{}},emits:["update:modelValue","success"],setup(I,{emit:T}){const v=I,a=T,n=g(!1),m=g(!1),_=g("");$(()=>v.modelValue,i=>{n.value=i,i&&(_.value=v.currentToken||"")}),$(n,i=>{a("update:modelValue",i)});const w=async()=>{if(!_.value.trim()){F("请输入WebSocket Token");return}m.value=!0;try{const i=await ue({xianyuAccountId:v.accountId,websocketToken:_.value.trim()});if(i.code===0||i.code===200)W("Token更新成功"),n.value=!1,a("success");else throw new Error(i.msg||"更新失败")}catch(i){console.error("更新Token失败:",i),F("更新失败: "+i.message)}finally{m.value=!1}},b=()=>{n.value=!1};return(i,d)=>{const D=f("el-alert"),C=f("el-input"),y=f("el-form-item"),z=f("el-form"),U=f("el-button"),E=f("el-dialog");return c(),V(E,{modelValue:n.value,"onUpdate:modelValue":d[1]||(d[1]=u=>n.value=u),title:"手动更新 WebSocket Token",width:"600px","close-on-click-modal":!1},{footer:s(()=>[e("span",be,[l(U,{onClick:b},{default:s(()=>[...d[4]||(d[4]=[r("取消",-1)])]),_:1}),l(U,{type:"primary",loading:m.value,onClick:w},{default:s(()=>[...d[5]||(d[5]=[r(" 确定更新 ",-1)])]),_:1},8,["loading"])])]),default:s(()=>[e("div",we,[l(D,{title:"提示",type:"info",closable:!1,style:{"margin-bottom":"20px"}},{default:s(()=>[...d[2]||(d[2]=[e("p",null,"WebSocket Token用于WebSocket连接认证，有效期约20小时。",-1),e("p",null,'建议使用"刷新Token"按钮自动刷新，手动输入仅用于特殊情况。',-1)])]),_:1}),l(z,{"label-width":"120px"},{default:s(()=>[l(y,{label:"账号ID"},{default:s(()=>[l(C,{value:I.accountId,disabled:""},null,8,["value"])]),_:1}),l(y,{label:"当前Token"},{default:s(()=>[l(C,{value:I.currentToken,type:"textarea",rows:3,disabled:"",placeholder:"未获取到Token"},null,8,["value"])]),_:1}),l(y,{label:"新Token"},{default:s(()=>[l(C,{modelValue:_.value,"onUpdate:modelValue":d[0]||(d[0]=u=>_.value=u),type:"textarea",rows:3,placeholder:"请输入新的WebSocket Token"},null,8,["modelValue"]),d[3]||(d[3]=e("div",{style:{"margin-top":"8px",color:"#909399","font-size":"12px"}}," 请确保Token格式正确，错误的Token会导致WebSocket连接失败 ",-1))]),_:1})]),_:1})])]),_:1},8,["modelValue"])}}}),Te=H(xe,[["__scopeId","data-v-79a859dc"]]),Ce={class:"connection-page"},Se={class:"connection-container"},Ve={class:"account-list"},Ie=["onClick"],Me={class:"account-avatar"},ze={class:"account-info"},Ue={class:"account-name"},De={class:"account-id"},Ee={class:"panel-header"},Ae={key:0,class:"empty-state"},Be={key:1,class:"status-content"},Ne={key:0,class:"connection-main-card"},We={class:"main-card-header"},Le={class:"header-left"},Fe={class:"icon-large"},$e={class:"header-info"},Ge={class:"main-subtitle"},He={class:"header-right"},Re={class:"details-grid"},je={class:"detail-section cookie-section"},qe={class:"section-header"},Je={class:"section-body"},Ke={class:"info-box"},Oe={class:"info-box-value cookie-value"},Xe={key:0,class:"info-box-meta"},Ze={class:"section-actions"},Pe={class:"detail-section token-section"},Qe={class:"section-header"},Ye={class:"section-body"},eo={class:"info-box"},oo={class:"info-box-value time-value"},to={class:"info-box"},no={class:"info-box-value token-value"},so={key:0,class:"info-box-meta"},lo={class:"section-actions"},ao={class:"main-actions"},io={class:"action-wrapper"},co={class:"logs-section"},ro={class:"logs-container"},uo={class:"log-time"},po={class:"log-message"},fo={key:0,class:"log-empty"},vo=G({__name:"index",setup(I){const T=g(!1),v=g([]),a=g(null),n=g(null),m=g(!1);g(!1);const _=g([]);let w=null;const b=g(!1),i=g(!1),d=me(()=>v.value.find(o=>o.id===a.value)),D=async()=>{T.value=!0;try{const o=await re();if(o.code===0||o.code===200)v.value=o.data?.accounts||[];else throw new Error(o.msg||"获取账号列表失败")}catch(o){console.error("加载账号列表失败:",o),v.value=[]}finally{T.value=!1}},C=o=>{a.value=o,y(o),w&&clearInterval(w),w=window.setInterval(()=>{a.value&&y(a.value,!0)},5e3)},y=async(o,t=!1)=>{t||(m.value=!0);try{const x=await pe(o);if(x.code===0||x.code===200)n.value=x.data,t||u("状态已更新");else throw new Error(x.msg||"获取连接状态失败")}catch(x){t||(console.error("加载连接状态失败:",x),u("加载状态失败: "+x.message,!0))}finally{m.value=!1}},z=async()=>{if(a.value){m.value=!0,u("正在启动连接...");try{const o=await fe(a.value);if(o.code===0||o.code===200)W("连接启动成功"),u("连接启动成功"),await y(a.value);else if(o.code===1001&&o.data?.needCaptcha)u("⚠️ 检测到需要滑块验证",!0),await N.confirm(`检测到账号需要完成滑块验证才能启动连接。

📋 操作步骤：

1️⃣ 点击下方"访问闲鱼IM"按钮，打开闲鱼消息页面

2️⃣ 在闲鱼页面完成滑块验证

3️⃣ 验证成功后，点击本页面 Cookie 和 Token 区域的"❓ 如何获取？"按钮

4️⃣ 按照帮助教程获取 Cookie 和 Token

5️⃣ 点击"✏️ 手动更新"按钮，粘贴 Cookie 和 Token

6️⃣ 更新完成后，重新点击"启动连接"即可

💡 提示：帮助按钮中有详细的图文教程，非常简单！`,"🔐 需要滑块验证",{confirmButtonText:"🌐 访问闲鱼IM",cancelButtonText:"取消",type:"warning",distinguishCancelAndClose:!0,customClass:"captcha-guide-dialog"}),window.open("https://www.goofish.com/im","_blank"),u("✅ 已打开闲鱼IM页面"),u('📌 完成验证后，请点击"❓ 如何获取？"按钮查看教程'),K("请在闲鱼IM页面完成验证，然后使用帮助按钮获取Cookie和Token");else throw new Error(o.msg||"启动连接失败")}catch(o){o!=="cancel"&&o!=="close"&&(console.error("启动连接失败:",o),u("启动连接失败: "+o.message,!0))}finally{m.value=!1}}},U=async()=>{if(a.value){try{await N.confirm("断开连接后将无法接收消息和执行自动化流程，确定要断开连接吗？","确认断开连接",{confirmButtonText:"确定断开",cancelButtonText:"取消",type:"warning"})}catch{return}m.value=!0,u("正在断开连接...");try{const o=await ve(a.value);if(o.code===0||o.code===200)W("连接已断开"),u("连接已断开"),await y(a.value);else throw new Error(o.msg||"断开连接失败")}catch(o){console.error("断开连接失败:",o),u("断开连接失败: "+o.message,!0)}finally{m.value=!1}}},E=()=>{a.value&&(y(a.value),K("状态已刷新"))},u=(o,t=!1)=>{const A=new Date().toLocaleTimeString();_.value.push({time:A,message:o,isError:t}),_.value.length>50&&_.value.shift()},R=o=>o.accountNote||o.unb||"未命名账号",P=o=>R(o).charAt(0),Q=o=>o==null?"未知":{1:"有效",2:"过期",3:"失效"}[o]||"未知",Y=o=>o==null?"info":{1:"success",2:"warning",3:"danger"}[o]||"info",ee=o=>o?new Date(o).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"未设置",j=o=>o?Date.now()>o:!1,oe=o=>o?j(o)?"已过期":"有效":"未设置",te=o=>o?j(o)?"danger":"success":"info",ne=()=>{b.value=!0},se=()=>{i.value=!0},le=()=>{N({title:"如何获取Cookie",message:`
      <div style="text-align: left;">
        <p style="margin-bottom: 12px;">请按照以下步骤获取Cookie：</p>
        <ol style="margin-left: 20px; line-height: 1.8;">
          <li>打开浏览器，访问闲鱼网站并登录</li>
          <li>按F12打开开发者工具</li>
          <li>切换到"网络"(Network)标签</li>
          <li>刷新页面</li>
          <li>在请求列表中找到任意请求</li>
          <li>在请求头中找到Cookie字段</li>
          <li>复制完整的Cookie值</li>
        </ol>
        <div style="margin-top: 16px; text-align: center;">
          <img 
            src="/cookieGet.png" 
            class="cookie-help-image"
            alt="Cookie获取示例" 
            onerror="this.style.display='none'"
            onclick="window.open('/cookieGet.png', '_blank')"
            title="点击查看大图"
          />
        </div>
        <p style="margin-top: 12px; color: #909399; font-size: 12px; text-align: center;">
          💡 点击图片可查看大图
        </p>
        <p style="margin-top: 8px; color: #f56c6c; font-size: 12px; text-align: center;">
          ⚠️ Cookie包含敏感信息，请勿泄露给他人
        </p>
      </div>
    `,dangerouslyUseHTMLString:!0,confirmButtonText:"知道了",customClass:"cookie-help-dialog"})},ae=()=>{N({title:"如何获取WebSocket Token",message:`
      <div style="text-align: left;">
        <p style="margin-bottom: 12px;">请按照以下步骤获取WebSocket Token：</p>
        <ol style="margin-left: 20px; line-height: 1.8;">
          <li>打开浏览器，访问 <a href="https://www.goofish.com/im" target="_blank" style="color: #409eff;">闲鱼IM页面</a> 并登录</li>
          <li>按F12打开开发者工具</li>
          <li>切换到"网络"(Network)标签</li>
          <li>在页面中进行任意操作（如点击聊天）</li>
          <li>在请求列表中找到WebSocket连接请求</li>
          <li>查看请求参数或响应中的Token信息</li>
          <li>复制完整的Token值</li>
        </ol>
        <div style="margin-top: 16px; text-align: center;">
          <img 
            src="/tokenGet.png" 
            class="token-help-image"
            alt="Token获取示例" 
            onerror="this.style.display='none'"
            onclick="window.open('/tokenGet.png', '_blank')"
            title="点击查看大图"
          />
        </div>
        <p style="margin-top: 12px; color: #909399; font-size: 12px; text-align: center;">
          💡 点击图片可查看大图
        </p>
        <p style="margin-top: 8px; color: #f56c6c; font-size: 12px; text-align: center;">
          ⚠️ Token包含敏感信息，请勿泄露给他人
        </p>
      </div>
    `,dangerouslyUseHTMLString:!0,confirmButtonText:"知道了",customClass:"token-help-dialog"})},ie=async()=>{u("Cookie已手动更新"),a.value&&await y(a.value)},ce=async()=>{u("Token已手动更新"),a.value&&await y(a.value)};return ke(async()=>{await D(),v.value.length>0&&C(v.value[0]?.id||0)}),ge(()=>{w&&clearInterval(w)}),(o,t)=>{const x=f("el-empty"),A=f("el-card"),M=f("el-button"),L=f("el-tag"),q=_e("loading");return c(),h("div",Ce,[t[21]||(t[21]=e("div",{class:"page-header"},[e("h1",{class:"page-title"},"连接管理")],-1)),e("div",Se,[l(A,{class:"account-panel"},{header:s(()=>[...t[2]||(t[2]=[e("div",{class:"panel-header"},[e("span",{class:"panel-title"},"闲鱼账号")],-1)])]),default:s(()=>[O((c(),h("div",Ve,[(c(!0),h(X,null,Z(v.value,k=>(c(),h("div",{key:k.id,class:B(["account-item",{active:a.value===k.id}]),onClick:J=>C(k.id)},[e("div",Me,p(P(k)),1),e("div",ze,[e("div",Ue,p(R(k)),1),e("div",De,"ID: "+p(k.id),1)])],10,Ie))),128)),!T.value&&v.value.length===0?(c(),V(x,{key:0,description:"暂无账号数据","image-size":80})):S("",!0)])),[[q,T.value]])]),_:1}),l(A,{class:"status-panel"},{header:s(()=>[e("div",Ee,[t[3]||(t[3]=e("span",{class:"panel-title"},"连接状态",-1)),a.value?(c(),V(M,{key:0,size:"small",icon:"Refresh",onClick:E,circle:""})):S("",!0)])]),default:s(()=>[a.value?O((c(),h("div",Be,[n.value?(c(),h("div",Ne,[e("div",We,[e("div",Le,[e("div",{class:B(["icon-wrapper-large",n.value.connected?"icon-success":"icon-danger"])},[e("span",Fe,p(n.value.connected?"✓":"✕"),1)],2),e("div",$e,[t[5]||(t[5]=e("h2",{class:"main-title"},"连接状态",-1)),e("p",Ge,"账号 ID: "+p(n.value.xianyuAccountId)+" · "+p(n.value.status),1),e("p",{class:B(["main-note",n.value.connected?"note-success":"note-danger"])},p(n.value.connected?"已连接到闲鱼服务器":"当前未连接到闲鱼服务器，无法监听消息以及执行自动化流程"),3)])]),e("div",He,[l(L,{type:n.value.connected?"success":"danger",size:"large",effect:"dark",round:"",class:"status-tag-large"},{default:s(()=>[r(p(n.value.connected?"● 已连接":"● 未连接"),1)]),_:1},8,["type"])])]),e("div",Re,[e("div",je,[e("div",qe,[t[6]||(t[6]=e("div",{class:"section-icon"},"🍪",-1)),t[7]||(t[7]=e("div",{class:"section-title-group"},[e("h3",{class:"section-title"},"Cookie 凭证"),e("p",{class:"section-note"},"用于识别账号，如果过期无法使用任何功能")],-1)),l(L,{type:Y(n.value.cookieStatus),size:"small",round:""},{default:s(()=>[r(p(Q(n.value.cookieStatus)),1)]),_:1},8,["type"])]),e("div",Je,[e("div",Ke,[t[8]||(t[8]=e("div",{class:"info-box-label"},"Cookie 内容",-1)),e("div",Oe,p(n.value.cookieText||"未获取到Cookie"),1),n.value.cookieText?(c(),h("div",Xe," 长度: "+p(n.value.cookieText.length)+" 字符 ",1)):S("",!0)]),e("div",Ze,[l(M,{type:"primary",size:"small",onClick:ne,class:"manual-update-btn"},{default:s(()=>[...t[9]||(t[9]=[r(" ✏️ 手动更新 ",-1)])]),_:1}),l(M,{type:"info",size:"small",onClick:le},{default:s(()=>[...t[10]||(t[10]=[r(" ❓ 如何获取？ ",-1)])]),_:1})])])]),e("div",Pe,[e("div",Qe,[t[11]||(t[11]=e("div",{class:"section-icon"},"🔑",-1)),t[12]||(t[12]=e("div",{class:"section-title-group"},[e("h3",{class:"section-title"},"WebSocket Token"),e("p",{class:"section-note"},"这个是收取消息的凭证，如果异常，可能是账号被锁人机验证，需要隔段时间再试一试")],-1)),l(L,{type:te(n.value.tokenExpireTime),size:"small",round:""},{default:s(()=>[r(p(oe(n.value.tokenExpireTime)),1)]),_:1},8,["type"])]),e("div",Ye,[e("div",eo,[t[13]||(t[13]=e("div",{class:"info-box-label"},"⏰ 过期时间",-1)),e("div",oo,p(ee(n.value.tokenExpireTime)),1)]),e("div",to,[t[14]||(t[14]=e("div",{class:"info-box-label"},"Token 内容",-1)),e("div",no,p(n.value.websocketToken||"未获取到Token"),1),n.value.websocketToken?(c(),h("div",so," 长度: "+p(n.value.websocketToken.length)+" 字符 ",1)):S("",!0)]),e("div",lo,[l(M,{type:"default",size:"small",onClick:se},{default:s(()=>[...t[15]||(t[15]=[r(" ✏️ 手动更新 ",-1)])]),_:1}),l(M,{type:"info",size:"small",onClick:ae},{default:s(()=>[...t[16]||(t[16]=[r(" ❓ 如何获取？ ",-1)])]),_:1})])])])]),e("div",ao,[e("div",io,[n.value.connected?(c(),V(M,{key:0,type:"danger",size:"default",onClick:U,class:"main-action-btn"},{default:s(()=>[...t[17]||(t[17]=[r(" ⏸ 断开连接 ",-1)])]),_:1})):(c(),V(M,{key:1,type:"success",size:"default",onClick:z,class:"main-action-btn start-connection-btn"},{default:s(()=>[...t[18]||(t[18]=[r(" ▶ 启动连接 ",-1)])]),_:1})),t[19]||(t[19]=e("div",{class:"action-tip"}," ⚠️ 请勿频繁启用连接和断开连接，否则容易触发滑动窗口人机校验，导致账号暂时不可用 ",-1))])])])):S("",!0),e("div",co,[t[20]||(t[20]=e("div",{class:"logs-header"},"操作日志",-1)),e("div",ro,[(c(!0),h(X,null,Z(_.value,(k,J)=>(c(),h("div",{key:J,class:B(["log-entry",{"log-error":k.isError}])},[e("span",uo,"["+p(k.time)+"]",1),e("span",po,p(k.message),1)],2))),128)),_.value.length===0?(c(),h("div",fo," 暂无日志记录 ")):S("",!0)])])])),[[q,m.value]]):(c(),h("div",Ae,[l(x,{description:"请选择一个账号查看连接状态","image-size":100},{image:s(()=>[...t[4]||(t[4]=[e("div",{class:"empty-icon"},"🔗",-1)])]),_:1})]))]),_:1})]),d.value&&n.value?(c(),V(he,{key:0,modelValue:b.value,"onUpdate:modelValue":t[0]||(t[0]=k=>b.value=k),"account-id":d.value.id,"current-cookie":n.value.cookieText||"",onSuccess:ie},null,8,["modelValue","account-id","current-cookie"])):S("",!0),d.value&&n.value?(c(),V(Te,{key:1,modelValue:i.value,"onUpdate:modelValue":t[1]||(t[1]=k=>i.value=k),"account-id":d.value.id,"current-token":n.value.websocketToken||"",onSuccess:ce},null,8,["modelValue","account-id","current-token"])):S("",!0)])}}}),yo=H(vo,[["__scopeId","data-v-ddfde90e"]]);export{yo as default};
