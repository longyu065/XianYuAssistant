import{g as fe,e as z,a as R,s as _e}from"./index-BTFSt2fU.js";import{r as he}from"./request-DTdiWb_T.js";import{g as ye}from"./goods-Bzsuu9Qq.js";import{c as we}from"./websocket-B7VuREY3.js";import{d as Ce,r as n,v as xe,x as ke,y as be,c as h,i as l,b as a,g as o,h as r,F as Q,j as W,m as x,w as O,e as Ie,s as E,f as L,t as d,n as J,o as u,_ as Ve}from"./index-7CieyMQU.js";function Le(P){return he({url:"/msg/list",method:"POST",data:P})}const Te={class:"messages-page"},Ue={class:"page-header"},ze={class:"header-actions"},Se={class:"content-container"},Ae={class:"panel-header"},De=["onClick"],Ge={class:"goods-cover"},Me=["src","alt"],Ne={class:"goods-info"},Re={class:"goods-title"},Ee={class:"goods-id"},Pe={key:0,class:"loading-more"},$e={class:"messages-container"},qe={class:"card-header"},Be={class:"card-subtitle"},Fe={class:"message-id"},je={class:"goods-id"},He={class:"message-time"},Qe={key:1,class:"no-action"},We={class:"pagination-container"},Oe={class:"quick-reply-content"},Je={class:"reply-info"},Ke={class:"info-item"},Xe={class:"info-value"},Ye={class:"info-item"},Ze={class:"info-value"},et=Ce({__name:"index",setup(P){const S=n(!1),k=n([]),i=n(null),m=n(""),A=n([]),g=n(1),$=n(20),D=n(0),G=n(!1),y=n([]),w=n(1),q=n(0),b=n(!1),f=n(null),I=n(!1),C=n(""),M=n(!1),c=n(null),K=xe(()=>{if(!i.value)return"";const t=k.value.find(e=>e.id===i.value);return t?t.unb:""}),X=async()=>{try{const t=await fe();(t.code===0||t.code===200)&&(k.value=t.data?.accounts||[],k.value.length>0&&!i.value&&(i.value=k.value[0]?.id??null,v(),N()))}catch(t){console.error("加载账号列表失败:",t)}},v=async()=>{if(!i.value){z("请先选择账号");return}S.value=!0;try{const t={xianyuAccountId:i.value,pageNum:g.value,pageSize:$.value,filterCurrentAccount:G.value};m.value&&(t.xyGoodsId=m.value);const e=await Le(t);if(e.code===0||e.code===200)A.value=e.data?.list||[],D.value=e.data?.totalCount||0;else throw new Error(e.msg||"获取消息列表失败")}catch(t){console.error("加载消息列表失败:",t),A.value=[]}finally{S.value=!1}},N=async()=>{if(i.value){b.value=!0;try{const t={xianyuAccountId:i.value,pageNum:w.value,pageSize:10},e=await ye(t);if(e.code===0||e.code===200)w.value===1?y.value=e.data?.itemsWithConfig||[]:y.value.push(...e.data?.itemsWithConfig||[]),q.value=e.data?.totalCount||0;else throw new Error(e.msg||"获取商品列表失败")}catch(t){console.error("加载商品列表失败:",t),y.value=[]}finally{b.value=!1}}},B=()=>{if(!f.value)return;const{scrollTop:t,scrollHeight:e,clientHeight:U}=f.value;t+U>=e-10&&y.value.length<q.value&&(w.value++,N())},Y=()=>{f.value&&f.value.addEventListener("scroll",B)},Z=()=>{f.value&&f.value.removeEventListener("scroll",B)},ee=()=>{g.value=1,w.value=1,v(),N()},te=t=>{m.value===t?F():(m.value=t,z("已筛选该商品的消息"),g.value=1,v())},F=()=>{m.value="",z("已取消筛选，显示全部消息"),g.value=1,v()},se=t=>{g.value=t,v()},le=(t,e)=>T(e)?t===1?"用户消息":`系统消息(${t})`:"你发送的",oe=(t,e)=>T(e)?t===1?"success":"warning":"primary",T=t=>t.senderUserId!==K.value,ae=t=>{if(!t)return"-";const e=new Date(t),_=new Date().getTime()-e.getTime();return _<6e4?"刚刚":_<36e5?`${Math.floor(_/6e4)}分钟前`:_<864e5?`${Math.floor(_/36e5)}小时前`:e.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},ne=t=>{c.value=t,C.value="",I.value=!0},ie=async()=>{if(!C.value.trim()){z("请输入回复内容");return}if(!c.value||!i.value){R("消息信息不完整");return}if(!c.value.sid){R("会话ID(sid)不存在，无法发送消息");return}if(!c.value.senderUserId){R("接收方ID(senderUserId)不存在，无法发送消息");return}M.value=!0;try{const t=await we({xianyuAccountId:i.value,cid:c.value.sid,toId:c.value.senderUserId,text:C.value.trim()});(t.code===0||t.code===200)&&(_e("消息发送成功"),I.value=!1,C.value="",c.value=null,v())}catch(t){console.error("发送消息失败:",t)}finally{M.value=!1}};return ke(()=>{X(),setTimeout(()=>{Y()},0)}),be(()=>{Z()}),(t,e)=>{const U=r("el-option"),_=r("el-select"),V=r("el-button"),re=r("el-switch"),ue=r("el-empty"),j=r("el-card"),p=r("el-table-column"),de=r("el-tag"),ce=r("el-table"),ve=r("el-pagination"),pe=r("el-input"),me=r("el-dialog"),H=Ie("loading");return u(),h("div",Te,[l("div",Ue,[e[7]||(e[7]=l("h1",{class:"page-title"},"消息管理",-1)),l("div",ze,[a(_,{modelValue:i.value,"onUpdate:modelValue":e[0]||(e[0]=s=>i.value=s),placeholder:"选择账号",style:{width:"200px"},onChange:ee},{default:o(()=>[(u(!0),h(Q,null,W(k.value,s=>(u(),L(U,{key:s.id,label:s.accountNote||s.unb,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(V,{onClick:v},{default:o(()=>[...e[6]||(e[6]=[x("刷新消息",-1)])]),_:1}),a(re,{modelValue:G.value,"onUpdate:modelValue":e[1]||(e[1]=s=>G.value=s),"active-text":"隐藏当前账号消息","inactive-text":"显示全部消息",onChange:v},null,8,["modelValue"])])]),l("div",Se,[a(j,{class:"goods-filter-panel"},{header:o(()=>[l("div",Ae,[e[9]||(e[9]=l("span",{class:"panel-title"},"商品列表",-1)),m.value?(u(),L(V,{key:0,type:"info",size:"small",plain:"",onClick:F},{default:o(()=>[...e[8]||(e[8]=[x(" 取消筛选 ",-1)])]),_:1})):E("",!0)])]),default:o(()=>[O((u(),h("div",{ref_key:"goodsListRef",ref:f,class:"goods-list-container"},[(u(!0),h(Q,null,W(y.value,s=>(u(),h("div",{key:s.item.id,class:J(["goods-item",{active:m.value===s.item.xyGoodId}]),onClick:ge=>te(s.item.xyGoodId)},[l("div",Ge,[l("img",{src:s.item.coverPic,alt:s.item.title,class:"cover-img"},null,8,Me)]),l("div",Ne,[l("div",Re,d(s.item.title),1),l("div",Ee,"#"+d(s.item.xyGoodId),1)])],10,De))),128)),b.value&&w.value>1?(u(),h("div",Pe," 加载中... ")):E("",!0),!b.value&&y.value.length===0?(u(),L(ue,{key:1,description:"暂无商品数据","image-size":80})):E("",!0)])),[[H,b.value&&w.value===1]])]),_:1}),l("div",$e,[a(j,{class:"messages-card"},{header:o(()=>[l("div",qe,[e[10]||(e[10]=l("span",{class:"card-title"},"消息列表",-1)),l("span",Be,"共 "+d(D.value)+" 条消息",1)])]),default:o(()=>[O((u(),L(ce,{data:A.value,stripe:"",style:{width:"100%"},"max-height":"calc(100vh - 300px)"},{default:o(()=>[a(p,{type:"index",label:"序号",width:"60",align:"center"}),a(p,{prop:"id",label:"消息ID",width:"100"},{default:o(({row:s})=>[l("div",Fe,d(s.id),1)]),_:1}),a(p,{label:"消息类型",width:"120"},{default:o(({row:s})=>[a(de,{type:oe(s.contentType,s),size:"small"},{default:o(()=>[x(d(le(s.contentType,s)),1)]),_:2},1032,["type"])]),_:1}),a(p,{prop:"senderUserName",label:"发送者",width:"120","show-overflow-tooltip":""}),a(p,{prop:"msgContent",label:"消息内容","min-width":"200","show-overflow-tooltip":""},{default:o(({row:s})=>[l("div",{class:J(["message-content",{"user-message":T(s)}])},d(s.msgContent),3)]),_:1}),a(p,{prop:"xyGoodsId",label:"商品ID",width:"120"},{default:o(({row:s})=>[l("div",je,d(s.xyGoodsId||"-"),1)]),_:1}),a(p,{label:"时间",width:"150"},{default:o(({row:s})=>[l("div",He,d(ae(s.messageTime)),1)]),_:1}),a(p,{label:"操作",width:"100",align:"center",fixed:"right"},{default:o(({row:s})=>[T(s)?(u(),L(V,{key:0,type:"primary",size:"small",onClick:ge=>ne(s)},{default:o(()=>[...e[11]||(e[11]=[x(" 快速回复 ",-1)])]),_:1},8,["onClick"])):(u(),h("span",Qe,"-"))]),_:1})]),_:1},8,["data"])),[[H,S.value]]),l("div",We,[a(ve,{"current-page":g.value,"onUpdate:currentPage":e[2]||(e[2]=s=>g.value=s),"page-size":$.value,total:D.value,layout:"total, prev, pager, next, jumper",onCurrentChange:se},null,8,["current-page","page-size","total"])])]),_:1})])]),a(me,{modelValue:I.value,"onUpdate:modelValue":e[5]||(e[5]=s=>I.value=s),title:"快速回复",width:"500px","close-on-click-modal":!1},{footer:o(()=>[a(V,{onClick:e[4]||(e[4]=s=>I.value=!1)},{default:o(()=>[...e[14]||(e[14]=[x("取消",-1)])]),_:1}),a(V,{type:"primary",loading:M.value,onClick:ie},{default:o(()=>[...e[15]||(e[15]=[x(" 发送 ",-1)])]),_:1},8,["loading"])]),default:o(()=>[l("div",Oe,[l("div",Je,[l("div",Ke,[e[12]||(e[12]=l("span",{class:"info-label"},"回复给：",-1)),l("span",Xe,d(c.value?.senderUserName),1)]),l("div",Ye,[e[13]||(e[13]=l("span",{class:"info-label"},"原消息：",-1)),l("span",Ze,d(c.value?.msgContent),1)])]),a(pe,{modelValue:C.value,"onUpdate:modelValue":e[3]||(e[3]=s=>C.value=s),type:"textarea",rows:6,placeholder:"请输入回复内容...",maxlength:"500","show-word-limit":""},null,8,["modelValue"])])]),_:1},8,["modelValue"])])}}}),nt=Ve(et,[["__scopeId","data-v-70838b79"]]);export{nt as default};
