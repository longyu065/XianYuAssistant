import{g as ie,a as V,e as ue,s as de}from"./index-BTFSt2fU.js";import{r as U}from"./request-DTdiWb_T.js";import{d as ce,r,v as pe,x as ve,c as u,i as s,b as l,g as o,h as d,w as $,e as ge,f as L,s as _e,F as O,j as w,m as c,t as m,E as P,o as n,n as fe,_ as me}from"./index-7CieyMQU.js";function be(y){return U({url:"/operation-log/query",method:"POST",data:y})}function Ee(y){return U({url:"/operation-log/deleteOld",method:"POST",data:{days:y}})}const Se={class:"operation-log-page"},ye={class:"operation-log-container"},he={class:"account-list"},Ce=["onClick"],Te={class:"account-avatar"},Oe={class:"account-info"},we={class:"account-name"},xe={class:"account-id"},Me={class:"panel-header"},Ne={class:"header-actions"},ke={key:0,class:"empty-state"},De={key:1,class:"logs-content"},Ie={class:"filter-bar"},Ae={class:"pagination-container"},Re=ce({__name:"index",setup(y){const f=r(!1),b=r([]),p=r(null),N=r([]),k=r(0),v=r(1),h=r(20),C=r(""),T=r(""),E=r(null),D=[{label:"全部",value:""},{label:"扫码登录",value:"LOGIN"},{label:"WebSocket连接",value:"WEBSOCKET_CONNECT"},{label:"WebSocket断开",value:"WEBSOCKET_DISCONNECT"},{label:"发送消息",value:"SEND_MESSAGE"},{label:"接收消息",value:"RECEIVE_MESSAGE"},{label:"自动发货",value:"AUTO_DELIVERY"},{label:"自动回复",value:"AUTO_REPLY"},{label:"确认收货",value:"CONFIRM_SHIPMENT"},{label:"Token刷新",value:"TOKEN_REFRESH"},{label:"Cookie更新",value:"COOKIE_UPDATE"},{label:"商品同步",value:"GOODS_SYNC"},{label:"消息同步",value:"MESSAGE_SYNC"}],B=[{label:"全部",value:""},{label:"账号",value:"ACCOUNT"},{label:"消息",value:"MESSAGE"},{label:"订单",value:"ORDER"},{label:"商品",value:"GOODS"},{label:"系统",value:"SYSTEM"}],G=[{label:"全部",value:null},{label:"成功",value:1},{label:"失败",value:0},{label:"部分成功",value:2}];pe(()=>b.value.find(e=>e.id===p.value));const F=async()=>{f.value=!0;try{const e=await ie();(e.code===0||e.code===200)&&(b.value=e.data?.accounts||[],b.value.length>0&&!p.value&&(p.value=b.value[0]?.id??null,g()))}catch(e){console.error("加载账号列表失败:",e)}finally{f.value=!1}},Y=e=>{p.value=e,v.value=1,g()},g=async()=>{if(p.value){f.value=!0;try{const e=await be({accountId:p.value,operationType:C.value||void 0,operationModule:T.value||void 0,operationStatus:E.value!==null?E.value:void 0,page:v.value,pageSize:h.value});if(e.code===0||e.code===200)N.value=e.data?.logs||[],k.value=e.data?.total||0;else throw new Error(e.msg||"加载失败")}catch(e){console.error("加载操作记录失败:",e),V("加载失败: "+e.message)}finally{f.value=!1}}},K=()=>{v.value=1,g()},W=()=>{C.value="",T.value="",E.value=null,v.value=1,g()},q=e=>{v.value=e,g()},H=e=>{h.value=e,v.value=1,g()},j=()=>{g(),ue("已刷新")},J=async()=>{try{await P.prompt("请输入要删除多少天之前的日志","删除旧日志",{confirmButtonText:"确定",cancelButtonText:"取消",inputPattern:/^\d+$/,inputErrorMessage:"请输入有效的天数"}).then(async({value:e})=>{const t=parseInt(e),i=await Ee(t);if(i.code===0||i.code===200)de(`成功删除${i.data}条记录`),g();else throw new Error(i.msg||"删除失败")})}catch(e){e!=="cancel"&&(console.error("删除旧日志失败:",e),V("删除失败: "+e.message))}},Q=e=>e.accountNote?.substring(0,1)||e.id?.toString().substring(0,1)||"?",X=e=>e.accountNote||`账号${e.id}`,Z=e=>D.find(i=>i.value===e)?.label||e,ee=e=>({LOGIN:"success",WEBSOCKET_CONNECT:"success",WEBSOCKET_DISCONNECT:"warning",SEND_MESSAGE:"primary",RECEIVE_MESSAGE:"info",AUTO_DELIVERY:"success",AUTO_REPLY:"success",CONFIRM_SHIPMENT:"success",TOKEN_REFRESH:"warning",COOKIE_UPDATE:"warning",GOODS_SYNC:"info",MESSAGE_SYNC:"info"})[e]||"",te=e=>({0:"失败",1:"成功",2:"部分成功"})[e]||"未知",ae=e=>({0:"danger",1:"success",2:"warning"})[e]||"info",le=e=>new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}),I=e=>e?e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`:"-",oe=e=>{let t='<div style="text-align: left;">';t+=`<p><strong>操作描述：</strong>${e.operationDesc||"-"}</p>`,e.targetType&&(t+=`<p><strong>目标类型：</strong>${e.targetType}</p>`),e.targetId&&(t+=`<p><strong>目标ID：</strong>${e.targetId}</p>`),e.requestParams&&(t+=`<p><strong>请求参数：</strong></p><pre style="max-height: 200px; overflow: auto; background: #f5f5f5; padding: 10px; border-radius: 4px;">${e.requestParams}</pre>`),e.responseResult&&(t+=`<p><strong>响应结果：</strong></p><pre style="max-height: 200px; overflow: auto; background: #f5f5f5; padding: 10px; border-radius: 4px;">${e.responseResult}</pre>`),e.errorMessage&&(t+=`<p><strong>错误信息：</strong></p><pre style="max-height: 200px; overflow: auto; background: #fff3f3; padding: 10px; border-radius: 4px; color: #f56c6c;">${e.errorMessage}</pre>`),e.durationMs&&(t+=`<p><strong>耗时：</strong>${I(e.durationMs)}</p>`),t+="</div>",P({title:"操作详情",message:t,dangerouslyUseHTMLString:!0,confirmButtonText:"关闭",customClass:"operation-detail-dialog"})};return ve(()=>{F()}),(e,t)=>{const i=d("el-empty"),A=d("el-card"),S=d("el-button"),x=d("el-option"),M=d("el-select"),_=d("el-table-column"),R=d("el-tag"),se=d("el-table"),ne=d("el-pagination"),z=ge("loading");return n(),u("div",Se,[t[12]||(t[12]=s("div",{class:"page-header"},[s("h1",{class:"page-title"},"操作记录")],-1)),s("div",ye,[l(A,{class:"account-panel"},{header:o(()=>[...t[5]||(t[5]=[s("div",{class:"panel-header"},[s("span",{class:"panel-title"},"闲鱼账号")],-1)])]),default:o(()=>[$((n(),u("div",he,[(n(!0),u(O,null,w(b.value,a=>(n(),u("div",{key:a.id,class:fe(["account-item",{active:p.value===a.id}]),onClick:re=>Y(a.id)},[s("div",Te,m(Q(a)),1),s("div",Oe,[s("div",we,m(X(a)),1),s("div",xe,"ID: "+m(a.id),1)])],10,Ce))),128)),!f.value&&b.value.length===0?(n(),L(i,{key:0,description:"暂无账号数据","image-size":80})):_e("",!0)])),[[z,f.value]])]),_:1}),l(A,{class:"logs-panel"},{header:o(()=>[s("div",Me,[t[8]||(t[8]=s("span",{class:"panel-title"},"操作记录",-1)),s("div",Ne,[l(S,{size:"small",onClick:j,icon:"Refresh"},{default:o(()=>[...t[6]||(t[6]=[c("刷新",-1)])]),_:1}),l(S,{size:"small",type:"danger",onClick:J,icon:"Delete"},{default:o(()=>[...t[7]||(t[7]=[c("删除旧日志",-1)])]),_:1})])])]),default:o(()=>[p.value?(n(),u("div",De,[s("div",Ie,[l(M,{modelValue:C.value,"onUpdate:modelValue":t[0]||(t[0]=a=>C.value=a),placeholder:"操作类型",clearable:"",style:{width:"150px"}},{default:o(()=>[(n(),u(O,null,w(D,a=>l(x,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),l(M,{modelValue:T.value,"onUpdate:modelValue":t[1]||(t[1]=a=>T.value=a),placeholder:"操作模块",clearable:"",style:{width:"120px"}},{default:o(()=>[(n(),u(O,null,w(B,a=>l(x,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),l(M,{modelValue:E.value,"onUpdate:modelValue":t[2]||(t[2]=a=>E.value=a),placeholder:"操作状态",clearable:"",style:{width:"120px"}},{default:o(()=>[(n(),u(O,null,w(G,a=>l(x,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),l(S,{type:"primary",onClick:K},{default:o(()=>[...t[9]||(t[9]=[c("筛选",-1)])]),_:1}),l(S,{onClick:W},{default:o(()=>[...t[10]||(t[10]=[c("重置",-1)])]),_:1})]),$((n(),L(se,{data:N.value,stripe:"",style:{width:"100%"},height:500},{default:o(()=>[l(_,{prop:"id",label:"ID",width:"80"}),l(_,{label:"操作类型",width:"140"},{default:o(({row:a})=>[l(R,{type:ee(a.operationType),size:"small"},{default:o(()=>[c(m(Z(a.operationType)),1)]),_:2},1032,["type"])]),_:1}),l(_,{prop:"operationModule",label:"模块",width:"100"}),l(_,{prop:"operationDesc",label:"操作描述","min-width":"200","show-overflow-tooltip":""}),l(_,{label:"状态",width:"100"},{default:o(({row:a})=>[l(R,{type:ae(a.operationStatus),size:"small"},{default:o(()=>[c(m(te(a.operationStatus)),1)]),_:2},1032,["type"])]),_:1}),l(_,{label:"耗时",width:"100"},{default:o(({row:a})=>[c(m(I(a.durationMs)),1)]),_:1}),l(_,{label:"时间",width:"180"},{default:o(({row:a})=>[c(m(le(a.createTime)),1)]),_:1}),l(_,{label:"操作",width:"100",fixed:"right"},{default:o(({row:a})=>[l(S,{type:"primary",size:"small",link:"",onClick:re=>oe(a)},{default:o(()=>[...t[11]||(t[11]=[c(" 详情 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[z,f.value]]),s("div",Ae,[l(ne,{"current-page":v.value,"onUpdate:currentPage":t[3]||(t[3]=a=>v.value=a),"page-size":h.value,"onUpdate:pageSize":t[4]||(t[4]=a=>h.value=a),"page-sizes":[10,20,50,100],total:k.value,layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:q,onSizeChange:H},null,8,["current-page","page-size","total"])])])):(n(),u("div",ke,[l(i,{description:"请选择一个账号查看操作记录","image-size":100})]))]),_:1})])])}}}),Le=me(Re,[["__scopeId","data-v-5e0fca01"]]);export{Le as default};
