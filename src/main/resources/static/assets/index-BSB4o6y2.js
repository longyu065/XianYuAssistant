import{r as ae,g as ne}from"./account-BM0RHrlO.js";import{g as le}from"./goods-DUkgtAex.js";import{a as M,b as ie}from"./index-B9A6kdhu.js";import{d as ce,r as l,s as re,m as de,n as ue,c as f,h as o,e as a,f as n,g as c,F as E,p as P,j as U,l as ve,t as r,w as ge,b as me,i as G,q as $,o as d,_ as pe}from"./index-udmZ-1w9.js";function _e(V){return ae({url:"/msg/list",method:"POST",data:V})}const fe={class:"messages-page"},he={class:"page-header"},ye={class:"header-actions"},we={class:"content-container"},Ce={class:"goods-filter-panel"},be={class:"card-header"},xe={class:"card-subtitle"},ke=["onClick"],Ie={class:"goods-cover"},Le=["src","alt"],Te={class:"goods-info"},Me={class:"goods-title"},Ue={class:"goods-id"},Ge={key:0,class:"loading-more"},Ve={class:"messages-container"},ze={class:"card-header"},Ae={class:"card-subtitle"},Ne={class:"message-id"},Se={class:"goods-id"},De={class:"message-time"},Ee={key:1,class:"no-action"},Pe={class:"pagination-container"},$e=ce({__name:"index",setup(V){const b=l(!1),h=l([]),i=l(null),w=l(""),x=l([]),m=l(1),z=l(20),k=l(0),I=l(!1),p=l([]),y=l(1),A=l(0),L=l(!1),v=l(null),B=re(()=>{if(!i.value)return"";const t=h.value.find(e=>e.id===i.value);return t?t.unb:""}),F=async()=>{try{const t=await ne();(t.code===0||t.code===200)&&(h.value=t.data?.accounts||[],h.value.length>0&&!i.value&&(i.value=h.value[0]?.id||null,_(),T()))}catch(t){M("加载账号列表失败: "+t.message)}},_=async()=>{if(!i.value){ie("请先选择账号");return}b.value=!0;try{const t={xianyuAccountId:i.value,pageNum:m.value,pageSize:z.value,filterCurrentAccount:I.value};w.value&&(t.xyGoodsId=w.value);const e=await _e(t);if(e.code===0||e.code===200)x.value=e.data?.list||[],k.value=e.data?.totalCount||0;else throw new Error(e.msg||"获取消息列表失败")}catch(t){M("加载消息列表失败: "+t.message),x.value=[]}finally{b.value=!1}},T=async()=>{if(i.value){L.value=!0;try{const t={xianyuAccountId:i.value,pageNum:y.value,pageSize:10},e=await le(t);if(e.code===0||e.code===200)y.value===1?p.value=e.data?.itemsWithConfig||[]:p.value.push(...e.data?.itemsWithConfig||[]),A.value=e.data?.totalCount||0;else throw new Error(e.msg||"获取商品列表失败")}catch(t){M("加载商品列表失败: "+t.message),p.value=[]}finally{L.value=!1}}},N=()=>{if(!v.value)return;const{scrollTop:t,scrollHeight:e,clientHeight:C}=v.value;t+C>=e-10&&p.value.length<A.value&&(y.value++,T())},j=()=>{v.value&&v.value.addEventListener("scroll",N)},q=()=>{v.value&&v.value.removeEventListener("scroll",N)},H=()=>{m.value=1,y.value=1,_(),T()},R=t=>{w.value=t,m.value=1,_()},W=t=>{m.value=t,_()},O=t=>({1:"用户消息",2:"图片",32:"已付款待发货"})[t]||`其他(${t})`,J=t=>({1:"success",2:"success",32:"warning"})[t]||"info",K=t=>t.senderUserId!==B.value,Q=t=>{if(!t)return"-";const e=new Date(t),g=new Date().getTime()-e.getTime();return g<6e4?"刚刚":g<36e5?`${Math.floor(g/6e4)}分钟前`:g<864e5?`${Math.floor(g/36e5)}小时前`:e.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},X=t=>{t&&window.open(t,"_blank")};return de(()=>{F(),setTimeout(()=>{j()},0)}),ue(()=>{q()}),(t,e)=>{const C=c("el-option"),g=c("el-select"),S=c("el-button"),Y=c("el-switch"),D=c("el-card"),u=c("el-table-column"),Z=c("el-tag"),ee=c("el-table"),te=c("el-pagination"),se=me("loading");return d(),f("div",fe,[o("div",he,[e[4]||(e[4]=o("h1",{class:"page-title"},"消息管理",-1)),o("div",ye,[a(g,{modelValue:i.value,"onUpdate:modelValue":e[0]||(e[0]=s=>i.value=s),placeholder:"选择账号",style:{width:"200px"},onChange:H},{default:n(()=>[(d(!0),f(E,null,P(h.value,s=>(d(),G(C,{key:s.id,label:s.accountNote||s.unb,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(S,{onClick:_},{default:n(()=>[...e[3]||(e[3]=[U("刷新消息",-1)])]),_:1}),a(Y,{modelValue:I.value,"onUpdate:modelValue":e[1]||(e[1]=s=>I.value=s),"inactive-text":"隐藏当前账号消息",onChange:_},null,8,["modelValue"])])]),o("div",we,[o("div",Ce,[a(D,{class:"goods-card"},{header:n(()=>[o("div",be,[e[5]||(e[5]=o("span",{class:"card-title"},"商品列表",-1)),o("span",xe,"共 "+r(p.value.length)+" 件商品",1)])]),default:n(()=>[o("div",{ref_key:"goodsListRef",ref:v,class:"goods-list-container"},[(d(!0),f(E,null,P(p.value,s=>(d(),f("div",{key:s.item.id,class:$(["goods-item",{active:w.value===s.item.xyGoodId}]),onClick:oe=>R(s.item.xyGoodId)},[o("div",Ie,[o("img",{src:s.item.coverPic,alt:s.item.title,class:"cover-img"},null,8,Le)]),o("div",Te,[o("div",Me,r(s.item.title),1),o("div",Ue,"#"+r(s.item.xyGoodId),1)])],10,ke))),128)),L.value&&y.value>1?(d(),f("div",Ge," 加载中... ")):ve("",!0)],512)]),_:1})]),o("div",Ve,[a(D,{class:"messages-card"},{header:n(()=>[o("div",ze,[e[6]||(e[6]=o("span",{class:"card-title"},"消息列表",-1)),o("span",Ae,"共 "+r(k.value)+" 条消息",1)])]),default:n(()=>[ge((d(),G(ee,{data:x.value,stripe:"",style:{width:"100%"},"max-height":"calc(100vh - 350px)"},{default:n(()=>[a(u,{type:"index",label:"序号",width:"60",align:"center"}),a(u,{prop:"id",label:"消息ID",width:"100"},{default:n(({row:s})=>[o("div",Ne,r(s.id),1)]),_:1}),a(u,{label:"消息类型",width:"120"},{default:n(({row:s})=>[a(Z,{type:J(s.contentType),size:"small"},{default:n(()=>[U(r(O(s.contentType)),1)]),_:2},1032,["type"])]),_:1}),a(u,{prop:"senderUserName",label:"发送者",width:"120","show-overflow-tooltip":""}),a(u,{prop:"msgContent",label:"消息内容","min-width":"200","show-overflow-tooltip":""},{default:n(({row:s})=>[o("div",{class:$(["message-content",{"user-message":K(s)}])},r(s.msgContent),3)]),_:1}),a(u,{prop:"xyGoodsId",label:"商品ID",width:"120"},{default:n(({row:s})=>[o("div",Se,r(s.xyGoodsId||"-"),1)]),_:1}),a(u,{label:"时间",width:"150"},{default:n(({row:s})=>[o("div",De,r(Q(s.messageTime)),1)]),_:1}),a(u,{label:"操作",width:"100",align:"center",fixed:"right"},{default:n(({row:s})=>[s.reminderUrl?(d(),G(S,{key:0,type:"primary",link:"",size:"small",onClick:oe=>X(s.reminderUrl)},{default:n(()=>[...e[7]||(e[7]=[U(" 查看链接 ",-1)])]),_:1},8,["onClick"])):(d(),f("span",Ee,"-"))]),_:1})]),_:1},8,["data"])),[[se,b.value]]),o("div",Pe,[a(te,{"current-page":m.value,"onUpdate:currentPage":e[2]||(e[2]=s=>m.value=s),"page-size":z.value,total:k.value,layout:"total, prev, pager, next, jumper",onCurrentChange:W},null,8,["current-page","page-size","total"])])]),_:1})])])])}}}),He=pe($e,[["__scopeId","data-v-4f44a338"]]);export{He as default};
