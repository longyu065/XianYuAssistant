import{d as xe,r as d,x as we,c as p,i as l,b as a,g as s,h as c,F as X,j as Y,w as $,e as Ce,s as D,t as u,n as Z,z as be,m as g,E as Ie,o as v,f as De,_ as Se}from"./index-7CieyMQU.js";import{g as Ae,e as b,s as B,a as ee}from"./index-BTFSt2fU.js";import{g as ze,u as Ge}from"./goods-Bzsuu9Qq.js";import{r as te}from"./request-DTdiWb_T.js";import{G as Ve}from"./GoodsDetailDialog-DIkdK50B.js";import{g as ke,c as Te}from"./auto-delivery-record-lhsB70g4.js";function Ue(S){return te({url:"/auto-delivery-config/save",method:"POST",data:S})}function Ee(S){return te({url:"/auto-delivery-config/get",method:"POST",data:S})}const Oe={class:"auto-delivery-page"},Ne={class:"page-header"},Pe={class:"header-actions"},$e={class:"content-container"},Be={class:"goods-panel"},Me={class:"card-header"},Re={class:"card-subtitle"},qe={class:"goods-list"},Le=["id","onClick"],Fe={class:"goods-info"},je={class:"goods-title"},We={class:"goods-meta"},He={class:"goods-price"},Je={key:0,class:"empty-goods"},Ke={class:"config-panel"},Qe={class:"card-header"},Xe={key:0,class:"card-subtitle"},Ye={class:"config-content"},Ze={class:"goods-title-section"},et={class:"goods-title-text"},tt={class:"switch-label"},ot={class:"switch-label"},at={class:"form-tip"},lt={class:"save-config-container"},st={key:0,class:"last-update-time"},nt={class:"delivery-records-section"},it={class:"records-header"},rt={class:"records-info"},ut={class:"records-count"},dt={class:"records-actions"},ct={key:0,class:"records-pagination"},vt={class:"records-table-wrapper"},pt={class:"order-id"},mt={class:"content-text"},gt={key:0,class:"pagination-container-bottom"},yt={key:1,class:"empty-config"},ft=xe({__name:"index",setup(S){const A=d(!1),T=d(!1),z=d([]),i=d(null),y=d([]),n=d(null),w=d(null),U=d(!1),M=d(""),r=d({type:1,autoDeliveryContent:"",autoConfirmShipment:0}),E=d(!1),G=d([]),h=d(0),x=d(1),C=d(20),f=d(!1),R=o=>o?o.replace("T"," ").substring(0,19):"-",oe=async()=>{try{const o=await Ae();(o.code===0||o.code===200)&&(z.value=o.data?.accounts||[],z.value.length>0&&!i.value&&(i.value=z.value[0]?.id||null,q()))}catch(o){console.error("加载账号列表失败:",o)}},q=async()=>{if(!i.value){b("请先选择账号");return}A.value=!0;try{const o={xianyuAccountId:i.value,pageNum:1,pageSize:100},e=await ze(o);if(e.code===0||e.code===200)y.value=e.data?.itemsWithConfig||[],y.value.length>0&&!n.value&&y.value.length>0&&L(y.value[0]);else throw new Error(e.msg||"获取商品列表失败")}catch(o){console.error("加载商品列表失败:",o),y.value=[]}finally{A.value=!1}},ae=()=>{n.value=null,w.value=null,q()},L=async o=>{n.value=o,x.value=1,await le(),await V()},le=async()=>{if(!(!n.value||!i.value))try{const o={xianyuAccountId:i.value,xyGoodsId:n.value.item.xyGoodId},e=await Ee(o);if(e.code===0||e.code===200)w.value=e.data||null,e.data?(r.value.type=e.data.type,r.value.autoDeliveryContent=e.data.autoDeliveryContent||"",r.value.autoConfirmShipment=e.data.autoConfirmShipment||0):(r.value.type=1,r.value.autoDeliveryContent="",r.value.autoConfirmShipment=0);else throw new Error(e.msg||"获取配置失败")}catch(o){console.error("加载配置失败:",o),w.value=null}},se=async()=>{if(!n.value||!i.value){b("请先选择商品");return}if(!r.value.autoDeliveryContent.trim()){b("请输入自动发货内容");return}T.value=!0;try{const o={xianyuAccountId:i.value,xianyuGoodsId:n.value.item.id,xyGoodsId:n.value.item.xyGoodId,type:r.value.type,autoDeliveryContent:r.value.autoDeliveryContent.trim(),autoConfirmShipment:r.value.autoConfirmShipment},e=await Ue(o);if(e.code===0||e.code===200)B("保存配置成功"),w.value=e.data||null;else throw new Error(e.msg||"保存配置失败")}catch(o){console.error("保存配置失败:",o)}finally{T.value=!1}},ne=o=>({0:"success",1:"info",2:"warning"})[o]||"info",ie=o=>({0:"在售",1:"已下架",2:"已售出"})[o]||"未知",re=o=>o?`¥${o}`:"-",ue=()=>{if(!n.value||!i.value){b("请先选择商品");return}M.value=n.value.item.xyGoodId,U.value=!0},de=async o=>{if(!n.value||!i.value){b("请先选择商品");return}try{const e=await Ge({xianyuAccountId:i.value,xyGoodsId:n.value.item.xyGoodId,xianyuAutoDeliveryOn:o?1:0});if(e.code===0||e.code===200){B(`自动发货${o?"开启":"关闭"}成功`),n.value&&(n.value.xianyuAutoDeliveryOn=o?1:0);const m=y.value.find(O=>O.item.xyGoodId===n.value?.item.xyGoodId);m&&(m.xianyuAutoDeliveryOn=o?1:0)}else throw new Error(e.msg||"操作失败")}catch(e){console.error("操作失败:",e),n.value&&(n.value.xianyuAutoDeliveryOn=o?0:1)}},V=async()=>{if(!i.value||!n.value){G.value=[],h.value=0;return}E.value=!0;try{const o={xianyuAccountId:i.value,xyGoodsId:n.value.item.xyGoodId,pageNum:x.value,pageSize:C.value},e=await ke(o);if(e.code===0||e.code===200)G.value=e.data?.records||[],h.value=e.data?.total||0;else throw new Error(e.msg||"获取记录失败")}catch(o){console.error("加载自动发货记录失败:",o),G.value=[],h.value=0}finally{E.value=!1}},F=o=>{x.value=o,V()},j=o=>{C.value=o,x.value=1,V()},ce=o=>o===1?"success":"danger",ve=o=>o===1?"成功":"失败",pe=async o=>{if(!i.value){b("请先选择账号");return}if(!o.orderId){ee("该记录没有订单ID，无法确认收货");return}try{await Ie.confirm(`确定要确认收货吗？订单ID: ${o.orderId}`,"确认收货",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e={xianyuAccountId:i.value,orderId:o.orderId},m=await Te(e);if(m.code===0||m.code===200)B(m.data||"确认收货成功"),await V();else throw m.msg&&(m.msg.includes("Token")||m.msg.includes("令牌"))?new Error("Cookie已过期，请重新扫码登录获取新的Cookie"):new Error(m.msg||"确认收货失败")}catch(e){if(e==="cancel")return;console.error("确认收货失败:",e),ee(e.message||"确认收货失败")}};return we(()=>{oe()}),(o,e)=>{const m=c("el-option"),O=c("el-select"),me=c("el-image"),N=c("el-tag"),P=c("el-empty"),W=c("el-card"),k=c("el-button"),H=c("el-switch"),I=c("el-form-item"),J=c("el-radio"),ge=c("el-radio-group"),ye=c("el-input"),fe=c("el-form"),K=c("el-pagination"),_=c("el-table-column"),_e=c("el-table"),Q=Ce("loading");return v(),p("div",Oe,[l("div",Ne,[e[12]||(e[12]=l("h1",{class:"page-title"},"自动发货配置",-1)),l("div",Pe,[e[11]||(e[11]=l("span",{class:"account-label"},"选择闲鱼账号",-1)),a(O,{modelValue:i.value,"onUpdate:modelValue":e[0]||(e[0]=t=>i.value=t),placeholder:"选择账号",style:{width:"200px"},onChange:ae},{default:s(()=>[(v(!0),p(X,null,Y(z.value,t=>(v(),De(m,{key:t.id,label:t.accountNote||t.unb,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),l("div",$e,[l("div",Be,[a(W,{class:"goods-card"},{header:s(()=>[l("div",Me,[e[13]||(e[13]=l("span",{class:"card-title"},"商品列表",-1)),l("span",Re,"共 "+u(y.value.length)+" 件商品",1)])]),default:s(()=>[$((v(),p("div",qe,[(v(!0),p(X,null,Y(y.value,t=>(v(),p("div",{key:t.item.xyGoodId,id:`goods-item-${t.item.id}-${Math.random().toString(36).substr(2,9)}`,class:Z(["goods-item",{active:n.value?.item.xyGoodId===t.item.xyGoodId}]),onClick:he=>L(t)},[a(me,{src:t.item.coverPic,fit:"cover",class:"goods-image"},null,8,["src"]),l("div",Fe,[l("div",je,u(t.item.title),1),l("div",We,[l("span",He,u(re(t.item.soldPrice)),1),a(N,{type:ne(t.item.status),size:"small"},{default:s(()=>[g(u(ie(t.item.status)),1)]),_:2},1032,["type"])])])],10,Le))),128)),y.value.length===0&&!A.value?(v(),p("div",Je,[a(P,{description:"暂无商品"})])):D("",!0)])),[[Q,A.value]])]),_:1})]),l("div",Ke,[a(W,{class:"config-card"},{header:s(()=>[l("div",Qe,[e[14]||(e[14]=l("span",{class:"card-title"},"自动发货配置",-1)),n.value?D("",!0):(v(),p("span",Xe," 请选择商品 "))])]),default:s(()=>[n.value?(v(),p("div",{key:0,class:Z(["config-form",{"records-expanded":f.value}])},[$(l("div",Ye,[l("div",Ze,[l("div",et,u(n.value.item.title),1),a(k,{type:"primary",size:"small",onClick:ue},{default:s(()=>[...e[15]||(e[15]=[g(" 查看商品详情 ",-1)])]),_:1})]),a(fe,{model:r.value,"label-width":"100px"},{default:s(()=>[a(I,{label:"自动发货"},{default:s(()=>[a(H,{modelValue:n.value.xianyuAutoDeliveryOn,"onUpdate:modelValue":e[1]||(e[1]=t=>n.value.xianyuAutoDeliveryOn=t),"active-value":1,"inactive-value":0,onChange:de},null,8,["modelValue"]),l("span",tt,u(n.value.xianyuAutoDeliveryOn===1?"已开启":"已关闭"),1)]),_:1}),a(I,{label:"发货类型"},{default:s(()=>[a(ge,{modelValue:r.value.type,"onUpdate:modelValue":e[2]||(e[2]=t=>r.value.type=t)},{default:s(()=>[a(J,{value:1},{default:s(()=>[...e[16]||(e[16]=[g("文本内容",-1)])]),_:1}),a(J,{value:2},{default:s(()=>[...e[17]||(e[17]=[g("自定义",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),a(I,{label:"发货内容"},{default:s(()=>[a(ye,{modelValue:r.value.autoDeliveryContent,"onUpdate:modelValue":e[3]||(e[3]=t=>r.value.autoDeliveryContent=t),type:"textarea",rows:8,placeholder:"请输入自动发货内容，买家下单后将自动发送此内容",maxlength:"1000","show-word-limit":""},null,8,["modelValue"])]),_:1}),a(I,{label:"自动确认发货"},{default:s(()=>[a(H,{modelValue:r.value.autoConfirmShipment,"onUpdate:modelValue":e[4]||(e[4]=t=>r.value.autoConfirmShipment=t),"active-value":1,"inactive-value":0,disabled:n.value.xianyuAutoDeliveryOn!==1},null,8,["modelValue","disabled"]),l("span",ot,u(r.value.autoConfirmShipment===1?"已开启":"已关闭"),1),l("div",at,u(n.value.xianyuAutoDeliveryOn===1?"开启后，自动发货成功将自动确认收货":"需要先开启自动发货"),1)]),_:1}),a(I,null,{default:s(()=>[l("div",lt,[a(k,{type:"primary",loading:T.value,onClick:se},{default:s(()=>[...e[18]||(e[18]=[g(" 保存配置 ",-1)])]),_:1},8,["loading"]),w.value?(v(),p("span",st," 上次更新: "+u(R(w.value.updateTime)),1)):D("",!0)])]),_:1})]),_:1},8,["model"])],512),[[be,!f.value]]),l("div",nt,[l("div",it,[l("div",rt,[e[19]||(e[19]=l("span",{class:"records-title"},"自动发货记录",-1)),l("span",ut,"共 "+u(h.value)+" 条记录",1)]),l("div",dt,[h.value>0&&!f.value?(v(),p("div",ct,[a(K,{"current-page":x.value,"onUpdate:currentPage":e[5]||(e[5]=t=>x.value=t),"page-size":C.value,"onUpdate:pageSize":e[6]||(e[6]=t=>C.value=t),"page-sizes":[10,20,50,100],total:h.value,layout:"sizes, prev, pager, next",small:"",onSizeChange:j,onCurrentChange:F},null,8,["current-page","page-size","total"])])):D("",!0),a(k,{icon:f.value?"ArrowDown":"ArrowUp",size:"small",onClick:e[7]||(e[7]=t=>f.value=!f.value)},{default:s(()=>[g(u(f.value?"收起":"展开"),1)]),_:1},8,["icon"])])]),$((v(),p("div",vt,[a(_e,{data:G.value,stripe:"",style:{width:"100%"},"max-height":f.value?"calc(100vh - 250px)":400},{empty:s(()=>[a(P,{description:"暂无发货记录","image-size":80})]),default:s(()=>[a(_,{type:"index",label:"序号",width:"60",align:"center"}),a(_,{prop:"orderId",label:"订单ID",width:"180"},{default:s(({row:t})=>[l("span",pt,u(t.orderId||"-"),1)]),_:1}),a(_,{prop:"buyerUserId",label:"买家ID",width:"120"},{default:s(({row:t})=>[g(u(t.buyerUserId||"-"),1)]),_:1}),a(_,{prop:"buyerUserName",label:"买家名称",width:"120"},{default:s(({row:t})=>[g(u(t.buyerUserName||"-"),1)]),_:1}),a(_,{prop:"content",label:"发货内容","min-width":"200"},{default:s(({row:t})=>[l("div",mt,u(t.content||"-"),1)]),_:1}),a(_,{prop:"state",label:"自动发货结果",width:"120",align:"center"},{default:s(({row:t})=>[a(N,{type:ce(t.state),size:"small"},{default:s(()=>[g(u(ve(t.state)),1)]),_:2},1032,["type"])]),_:1}),a(_,{prop:"orderState",label:"确认发货",width:"100",align:"center"},{default:s(({row:t})=>[a(N,{type:t.orderState===1?"success":"info",size:"small"},{default:s(()=>[g(u(t.orderState===1?"已确认":"未确认"),1)]),_:2},1032,["type"])]),_:1}),a(_,{prop:"createTime",label:"发货时间",width:"180"},{default:s(({row:t})=>[g(u(R(t.createTime)),1)]),_:1}),a(_,{label:"操作",width:"120",align:"center",fixed:"right"},{default:s(({row:t})=>[a(k,{type:"primary",size:"small",disabled:!t.orderId||t.orderState===1,onClick:he=>pe(t)},{default:s(()=>[...e[20]||(e[20]=[g(" 确认收货 ",-1)])]),_:1},8,["disabled","onClick"])]),_:1})]),_:1},8,["data","max-height"]),h.value>0&&f.value?(v(),p("div",gt,[a(K,{"current-page":x.value,"onUpdate:currentPage":e[8]||(e[8]=t=>x.value=t),"page-size":C.value,"onUpdate:pageSize":e[9]||(e[9]=t=>C.value=t),"page-sizes":[10,20,50,100],total:h.value,layout:"total, sizes, prev, pager, next, jumper",small:"",onSizeChange:j,onCurrentChange:F},null,8,["current-page","page-size","total"])])):D("",!0)])),[[Q,E.value]])])],2)):(v(),p("div",yt,[a(P,{description:"请选择左侧商品进行配置"})]))]),_:1})])]),a(Ve,{modelValue:U.value,"onUpdate:modelValue":e[10]||(e[10]=t=>U.value=t),"goods-id":M.value,"account-id":i.value},null,8,["modelValue","goods-id","account-id"])])}}}),It=Se(ft,[["__scopeId","data-v-7bb758a2"]]);export{It as default};
